--correct calculator
<script>
function recalcAll() {
  const rows = document.querySelectorAll("#tbody tr");

  rows.forEach(row => {
    let courseworkValues = [];
    let projectPresentationValues = [];
    let unitTestValues = [];

    // Collect coursework scores
    row.querySelectorAll("td[data-col]").forEach(td => {
      const input = td.querySelector("input");
      if (!input) return;
      const label = td.getAttribute("data-col");
      const val = parseFloat(input.value) || 0;

      if (label.includes("ut")) unitTestValues.push(val);
      else if (label.includes("proj") || label.includes("pres"))
        projectPresentationValues.push(val);

      courseworkValues.push(val);
    });

    // Coursework Calculation Logic
    let coursework40 = 0;

    if (unitTestValues.length > 0 && projectPresentationValues.length === 0) {
      // Only Unit Tests → they become all 40%
      let avg = unitTestValues.reduce((a,b)=>a+b,0) / unitTestValues.length;
      coursework40 = avg * 0.40;

    } else if (projectPresentationValues.length > 0 && unitTestValues.length === 0) {
      // Only Project/Presentation → they become all 40%
      let avg = projectPresentationValues.reduce((a,b)=>a+b,0) / projectPresentationValues.length;
      coursework40 = avg * 0.40;

    } else {
      // Normal rule when both exist:
      let avgUT = unitTestValues.length
        ? (unitTestValues.reduce((a,b)=>a+b,0) / unitTestValues.length)
        : 0;

      let avgPP = projectPresentationValues.length
        ? (projectPresentationValues.reduce((a,b)=>a+b,0) / projectPresentationValues.length)
        : 0;

      let combined = 0;
      let count = 0;

      if (unitTestValues.length) { combined += avgUT; count++; }
      if (projectPresentationValues.length) { combined += avgPP; count++; }

      let finalAvg = count > 0 ? combined / count : 0;
      coursework40 = finalAvg * 0.40;
    }

    // Update Coursework Total cell (40%)
    row.children[row.children.length - 3].textContent = coursework40.toFixed(1);

    // Term Exam Score
    let examRaw = parseFloat(row.children[row.children.length - 2].querySelector("input").value) || 0;
    let exam60 = examRaw * 0.60;

    // Update Exam Total (60%)
    // (You may need to adjust index if layout changed)
    // But since you said "Do not change anything else", I keep your existing structure:
    row.children[row.children.length - 2].setAttribute("data-exam60", exam60);

    // Final 100%
    let finalTotal = coursework40 + exam60;

    // Update Final Score cell
    row.children[row.children.length - 1].textContent = finalTotal.toFixed(1);
  });
}
</script>

function exportExcel() {
    const academicYear = document.getElementById("academicYear").value;
    const term = document.getElementById("termSelect").value;
    const grade = document.getElementById("gradeLevel").value;
    const subject = document.getElementById("subjectSelect").value;

    const table = document.getElementById("assessmentTable");
    let sheetData = [];

    // Metadata rows
    sheetData.push(["Academic Year:", academicYear]);
    sheetData.push(["Term:", term]);
    sheetData.push(["Grade Level:", grade]);
    sheetData.push(["Subject:", subject]);
    sheetData.push([]); // spacer

    // Headers
    const headerRow1 = [];
    const headerRow2 = [];

    const theadRows = table.querySelectorAll("thead tr");
    theadRows.forEach((tr, rowIndex) => {
        const cells = tr.querySelectorAll("th");
        cells.forEach(cell => {
            if (rowIndex === 0) headerRow1.push(cell.innerText.trim());
            if (rowIndex === 1) headerRow2.push(cell.innerText.trim());
        });
    });

    sheetData.push(headerRow1);
    sheetData.push(headerRow2);

    // Body rows
    const rows = table.querySelectorAll("#tbody tr");
    rows.forEach(tr => {
        const rowArr = [];
        tr.querySelectorAll("td").forEach(td => {
            const input = td.querySelector("input");
            if (input) {
                rowArr.push(input.value);
            } else {
                rowArr.push(td.textContent.trim());
            }
        });
        sheetData.push(rowArr);
    });

    // Workbook
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(sheetData);

    ws['!cols'] = headerRow2.map(() => ({ wch: 18 }));

    XLSX.utils.book_append_sheet(wb, ws, "Assessment");

    // Filename pattern:
    // Year1_Mathematics_2025-2026_Term1_assessment.xlsx
    const fileName =
        `${grade}_${subject}_${academicYear}_${term}_assessment.xlsx`
            .replace(/\s+/g, '');

    XLSX.writeFile(wb, fileName);
}
