<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dynamic Assessment Entry</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- SheetJS for Excel import/export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui;
    background: #f5f5f7;
    padding: 20px;
  }

  .title {
    font-size: 22px;
    font-weight: 600;
    margin-bottom: 20px;
  }

  .card {
    background: #ffffff;
    border-radius: 14px;
    padding: 20px;
    border: 1px solid #ddd;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    position: relative;
  }

  .top-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }

  .btn-top {
    padding: 6px 12px;
    background: #0071e3;
    color: white;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 13px;
  }

  .btn-top:hover {
    background: #005bbd;
  }

  /* Coursework Box */
  .cw-group {
    border: 1px solid #d0d0d5;
    background: #fafafa;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 14px;
    display: inline-block;
  }

  .cw-title {
    font-weight: 600;
    margin-bottom: 6px;
  }

  .cw-buttons {
    display: flex;
    gap: 8px;
  }

  .btn {
    padding: 5px 12px;
    border-radius: 999px;
    border: 1px solid #ccc;
    background: white;
    cursor: pointer;
    font-size: 12px;
  }

  .btn:hover {
    background: #eaeaea;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    margin-top: 15px;
    font-size: 13px;
    min-width: 950px;
  }

  th, td {
    border: 1px solid #dcdcdc;
    padding: 6px;
    text-align: center;
  }

  th {
    background: #f2f2f7;
    font-weight: 600;
  }

  .label-col {
    text-align: left;
    padding-left: 8px;
    font-weight: 600;
  }

  input.score-box {
    width: 55px;
    padding: 4px;
    border-radius: 6px;
    border: 1px solid #cfcfd4;
    text-align: right;
  }

  input.name-box {
    width: 150px;
    padding: 4px;
    border-radius: 6px;
    border: 1px solid #cfcfd4;
  }

  .delete-col-btn {
    font-size: 11px;
    background: none;
    border: none;
    color: red;
    cursor: pointer;
  }

  .btn-add-student {
    margin-top: 14px;
    padding: 6px 14px;
    border-radius: 999px;
    background: #0071e3;
    color: #fff;
    border: none;
    cursor: pointer;
    font-size: 13px;
  }

  /* NEW pastel backgrounds */
  .cw-cell {
    background: #eaf4ff;   /* very light pastel blue */
  }

  .exam-cell {
    background: #fff8dc;   /* very light pastel yellow */
  }

  .total-cell {
    background: #eaffea;   /* very light pastel green */
  }
</style>
</head>

<body>

<div class="title">Assessment Entry – Dynamic Coursework & Exam</div>

<div class="card">

  <!-- Excel Buttons -->
  <div class="top-buttons">
    <button class="btn-top" onclick="importExcel()">Import from Excel</button>
    <button class="btn-top" onclick="exportExcel()">Export to Excel</button>
  </div>

  <!-- Coursework Group Box -->
  <div class="cw-group">
    <div class="cw-title">Coursework Weight: 40%</div>
    <div class="cw-buttons">
      <button class="btn" onclick="addUnitTest()">+ Add Unit Test</button>
      <button class="btn" onclick="addProject()">+ Add Project</button>
      <button class="btn" onclick="addPresentation()">+ Add Presentation</button>
    </div>
  </div>

  <!-- Assessment Table -->
  <table id="assessmentTable">
    <thead id="thead">
      <tr id="headerRow1">
        <th rowspan="2">No.</th>
        <th rowspan="2">Student Name</th>
        <th colspan="1" id="cwHeader">Coursework (40%)</th>
        <th rowspan="2">Coursework Total</th>
        <th rowspan="2">Term Exam (60%)</th>
        <th rowspan="2">Total (100%)</th>
      </tr>

      <tr id="headerRow2">
        <th id="col-ut1">Unit Test 1 <button class="delete-col-btn" onclick="deleteColumn('col-ut1')">x</button></th>
      </tr>
    </thead>

    <tbody id="tbody">
      <tr>
        <td>1</td>
        <td class="label-col"><input class="name-box" value="Zin Aung Hlaing"></td>
        <td data-col="col-ut1" class="cw-cell"><input class="score-box" value="8" oninput="recalc()"></td>
        <td class="cw-cell">0</td>
        <td class="exam-cell"><input class="score-box" value="53" oninput="recalc()"></td>
        <td class="total-cell">0</td>
      </tr>

      <tr>
        <td>2</td>
        <td class="label-col"><input class="name-box" value="Phoo Pyae Heather"></td>
        <td data-col="col-ut1" class="cw-cell"><input class="score-box" value="7" oninput="recalc()"></td>
        <td class="cw-cell">0</td>
        <td class="exam-cell"><input class="score-box" value="43" oninput="recalc()"></td>
        <td class="total-cell">0</td>
      </tr>
    </tbody>
  </table>

  <button class="btn-add-student" onclick="addStudent()">+ Add Student</button>

</div>

<script>
let cwCount = 1; // current number of coursework columns

function addUnitTest() {
  cwCount++;
  const colId = `col-ut${cwCount}`;
  addCourseworkColumn(colId, `Unit Test ${cwCount}`);
}

function addProject() {
  cwCount++;
  const colId = `col-proj${cwCount}`;
  addCourseworkColumn(colId, "Project");
}

function addPresentation() {
  cwCount++;
  const colId = `col-pres${cwCount}`;
  addCourseworkColumn(colId, "Presentation");
}

function addCourseworkColumn(colId, label) {
  // Update header row 1 colspan
  document.getElementById("cwHeader").colSpan = cwCount;

  // Add header cell
  const headerRow2 = document.getElementById("headerRow2");
  const th = document.createElement("th");
  th.id = colId;
  th.innerHTML = `${label} <button class="delete-col-btn" onclick="deleteColumn('${colId}')">x</button>`;
  headerRow2.appendChild(th);

  // Add column for each student row (before coursework total)
  document.querySelectorAll("#tbody tr").forEach(row => {
    const td = document.createElement("td");
    td.setAttribute("data-col", colId);
    td.classList.add("cw-cell");
    td.innerHTML = `<input class="score-box" oninput="recalc()">`;
    row.insertBefore(td, row.children[row.children.length - 3]);
  });

  recalc();
}

function deleteColumn(colId) {
  // Remove header col
  const th = document.getElementById(colId);
  if (th) th.remove();

  // Remove each row's corresponding cell
  document.querySelectorAll(`[data-col="${colId}"]`).forEach(td => td.remove());

  cwCount = Math.max(0, cwCount - 1);
  if (cwCount < 1) cwCount = 1; // keep safe minimum for colspan

  document.getElementById("cwHeader").colSpan = cwCount;
  recalc();
}

function addStudent() {
  const tbody = document.getElementById("tbody");
  const rowNumber = tbody.children.length + 1;

  const newRow = document.createElement("tr");

  let html = `
    <td>${rowNumber}</td>
    <td class="label-col"><input class="name-box" placeholder="Student Name"></td>
  `;

  // Add coursework columns in order
  document.querySelectorAll("#headerRow2 th").forEach(th => {
    const colId = th.id;
    if (colId) {
      html += `<td data-col="${colId}" class="cw-cell"><input class="score-box" oninput="recalc()"></td>`;
    }
  });

  // Coursework Total (blue), Exam (yellow), Total (green)
  html += `
    <td class="cw-cell">0</td>
    <td class="exam-cell"><input class="score-box" oninput="recalc()"></td>
    <td class="total-cell">0</td>
  `;

  newRow.innerHTML = html;
  tbody.appendChild(newRow);
  recalc();
}

// Calculator logic: Coursework 40% (Quizzes 25% + Project/Presentation 15%), Exam 60%
function recalc() {
  const rows = document.querySelectorAll("#tbody tr");

  rows.forEach(row => {
    let unitTests = [];
    let projPres = [];

    // Collect coursework inputs
    row.querySelectorAll("td[data-col]").forEach(td => {
      const col = td.getAttribute("data-col");
      const input = td.querySelector("input");
      let val = parseFloat(input && input.value ? input.value : 0);
      if (isNaN(val)) val = 0;
      if (val > 100) val = 100;
      if (val < 0) val = 0;
      if (input) input.value = val; // clamp to 0–100

      if (col.includes("ut")) {
        unitTests.push(val);
      } else {
        projPres.push(val);
      }
    });

    const quizAvg = unitTests.length ? unitTests.reduce((a, b) => a + b, 0) / unitTests.length : 0;
    const projAvg = projPres.length ? projPres.reduce((a, b) => a + b, 0) / projPres.length : 0;

    // Coursework calculation (fixed weights)
    const coursework = (quizAvg / 100) * 25 + (projAvg / 100) * 15; // max 40

    // Exam = 60%
    const examCell = row.children[row.children.length - 2];
    const examInput = examCell.querySelector("input");
    let exam = parseFloat(examInput && examInput.value ? examInput.value : 0);
    if (isNaN(exam)) exam = 0;
    if (exam > 100) exam = 100;
    if (exam < 0) exam = 0;
    if (examInput) examInput.value = exam;

    const examScore = (exam / 100) * 60;

    const total = coursework + examScore; // max 100

    // Set Coursework Total (blue column) and Total (green)
    const cwTotalCell = row.children[row.children.length - 3];
    const finalTotalCell = row.children[row.children.length - 1];

    cwTotalCell.textContent = coursework.toFixed(2);
    finalTotalCell.textContent = total.toFixed(2);
  });
}

/* IMPORT EXCEL */
function importExcel() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = ".xlsx";

  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();

    reader.onload = event => {
      const wb = XLSX.read(event.target.result, { type: "binary" });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      populateTableFromExcel(json);
    };

    reader.readAsBinaryString(file);
  };

  input.click();
}

function populateTableFromExcel(data) {
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  // Assumes: No | Name | UT1 | (Coursework Total) | Exam | Total
  data.slice(1).forEach((row, i) => {
    const tr = document.createElement("tr");

    const name = row[1] || "";
    const ut1 = row[2] || 0;
    const exam = row[4] || 0;

    tr.innerHTML = `
      <td>${i + 1}</td>
      <td class="label-col"><input class="name-box" value="${name}"></td>
      <td data-col="col-ut1" class="cw-cell"><input class="score-box" value="${ut1}" oninput="recalc()"></td>
      <td class="cw-cell">0</td>
      <td class="exam-cell"><input class="score-box" value="${exam}" oninput="recalc()"></td>
      <td class="total-cell">0</td>
    `;

    tbody.appendChild(tr);
  });

  recalc();
}

/* EXPORT EXCEL */
function exportExcel() {
  const table = document.getElementById("assessmentTable");
  const wb = XLSX.utils.table_to_book(table);
  XLSX.writeFile(wb, "assessment.xlsx");
}

// Initial calculation on load
document.addEventListener("DOMContentLoaded", recalc);
</script>

</body>
</html>
