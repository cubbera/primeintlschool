<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Subject Status</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:,">

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui;
      background: #f5f5f7;
      padding: 24px;
    }

    h1 { margin-bottom: 16px; }

    .filters {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    label { font-size: 14px; }

    select {
      margin-left: 6px;
      padding: 4px 6px;
      font-size: 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #d0d0d0;
      padding: 8px;
      text-align: left;
    }

    th {
      background: #eaeaf0;
      font-weight: 600;
    }

    tr.done { background: #f0f7f0; }
    tr.pending { background: #fff; }

    #error {
      color: red;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<h1>Subject Status</h1>

<div class="filters">
  <label>
    Academic Year:
    <select id="yearFilter">
      <option value="">All</option>
    </select>
  </label>

  <label>
    Term:
    <select id="termFilter">
      <option value="">All</option>
    </select>
  </label>

  <label>
    Class:
    <select id="classFilter">
      <option value="">All</option>
    </select>
  </label>
</div>

<table>
  <thead>
    <tr>
      <th>Academic Year</th>
      <th>Term</th>
      <th>Class</th>
      <th>Subject</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<div id="error"></div>

<script>
const WEB_APP_URL =
  "https://script.google.com/macros/s/AKfycbxSMDy62e0Ch8zR8L0fpDaDcVBNTDBfDo7_3hM55RWlWW6QNZ4BdPhluY9vzSvkllwxsA/exec";

let ALL_ROWS = [];

async function loadData() {
  try {
    const res = await fetch(WEB_APP_URL);
    const data = await res.json();   // âœ… FIX HERE

    ALL_ROWS = data;
    populateFilters(data);
    applyFilters();

  } catch (err) {
    console.error(err);
    document.getElementById("error").innerText =
      "Error: Unable to load data. Check Apps Script deployment.";
  }
}

function populateFilters(rows) {
  const yearSet = new Set();
  const termSet = new Set();
  const classSet = new Set();

  rows.forEach(r => {
    yearSet.add(r.academic_year);
    termSet.add(r.term);
    classSet.add(r.class_id);
  });

  fillSelect("yearFilter", [...yearSet].sort());
  fillSelect("termFilter", [...termSet].sort());
  fillSelect("classFilter", [...classSet].sort());

  yearFilter.onchange = applyFilters;
  termFilter.onchange = applyFilters;
  classFilter.onchange = applyFilters;
}

function fillSelect(id, values) {
  const sel = document.getElementById(id);
  values.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    sel.appendChild(opt);
  });
}

function applyFilters() {
  const year = yearFilter.value;
  const term = termFilter.value;
  const cls  = classFilter.value;

  let rows = ALL_ROWS.filter(r =>
    (year === "" || r.academic_year === year) &&
    (term === "" || String(r.term) === String(term)) &&
    (cls === "" || r.class_id === cls)
  );

  rows.sort((a, b) => {
    if (a.is_done != b.is_done) return a.is_done - b.is_done;
    if (a.class_id !== b.class_id) return a.class_id.localeCompare(b.class_id);
    return a.subject.localeCompare(b.subject);
  });

  render(rows);
}

function render(rows) {
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.className = r.is_done == 1 ? "done" : "pending";

    tr.innerHTML = `
      <td>${r.academic_year}</td>
      <td>${r.term}</td>
      <td>${r.class_id}</td>
      <td>${r.subject}</td>
      <td>${r.is_done == 1 ? "Done" : "Pending"}</td>
    `;

    tbody.appendChild(tr);
  });
}

loadData();
</script>

</body>
</html>
