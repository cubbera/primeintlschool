<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transaction Entry (Mockup)</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --soft:#f9fafb;
      --soft2:#f3f4f6;
      --focus:#2563eb;
      --warn:#b45309;
      --bad:#dc2626;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:var(--bg);
    }
    .wrap{ max-width: 1400px; margin: 24px auto 40px; padding: 0 16px; }

    .topbar{ display:flex; justify-content:space-between; align-items:flex-start; gap:16px; margin-bottom: 12px; }
    h1{ font-size: 18px; margin: 0 0 4px; font-weight: 800; letter-spacing:.2px; }
    .sub{ margin:0; color:var(--muted); font-size: 13px; }

    .btn{
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      padding: 10px 12px;
      border-radius: 10px;
      cursor:pointer;
      font-weight:700;
      font-size: 13px;
      white-space:nowrap;
    }
    .btn:hover{ background:var(--soft); }
    .btn.primary{ border-color: var(--focus); background: var(--focus); color: #fff; }
    .btn.primary:hover{ filter: brightness(0.95); }
    .btn.ghost{ background: var(--soft); }

    .card{
      border:1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
      background:#fff;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
    }
    .toolbar{
      display:flex; align-items:center; justify-content:space-between;
      gap: 12px; padding: 12px;
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    .pill{
      font-size: 12px; color: var(--muted);
      background: var(--soft);
      border: 1px solid var(--line);
      padding: 6px 10px; border-radius: 999px;
    }
    .hint{ font-size:12px; color:var(--muted); }

    .tableWrap{ overflow:auto; width:100%; }
    table{ border-collapse: collapse; width:100%; min-width: 1420px; table-layout: fixed; }

    thead th{
      position: sticky; top: 0; z-index: 2;
      background: var(--soft);
      border-bottom: 1px solid var(--line);
      font-size: 12px;
      color: var(--muted);
      padding: 10px 8px;
      text-align: left;
      vertical-align: bottom;
      white-space: nowrap;
    }
    tbody td{
      border-top: 1px solid var(--line);
      padding: 6px;
      vertical-align: top;
      background:#fff;
    }
    tbody tr:hover td{ background: var(--soft); }

    .rownum{
      text-align:right;
      color: var(--muted);
      font-size: 12px;
      padding-top: 14px;
      width: 44px;
    }

    /* Input "box line" */
    .cell{
      width:100%;
      border:1px solid var(--line);
      background: #fff;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
      outline: none;
    }
    .cell:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 3px rgba(37,99,235,.12);
    }

    select.cell{
      padding-right: 28px;
      appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, var(--muted) 50%),
        linear-gradient(135deg, var(--muted) 50%, transparent 50%);
      background-position:
        calc(100% - 16px) 55%,
        calc(100% - 11px) 55%;
      background-size: 5px 5px, 5px 5px;
      background-repeat: no-repeat;
    }
    textarea.cell{
      resize: vertical;
      line-height: 1.25;
      min-height: 44px; /* ~2 lines */
      max-height: 140px;
    }

    .warn{ display:block; margin-top: 4px; font-size: 11px; color: var(--warn); }
    .err{ display:block; margin-top: 4px; font-size: 11px; color: var(--bad); }
    .ok{ display:block; margin-top: 4px; font-size: 11px; color: #059669; }

    .amount{
      text-align:right;
      font-variant-numeric: tabular-nums;
      font-weight: 700;
    }
    .neg{ color: var(--bad); }
    .pos{ color: var(--text); }

    .fileCell{ display:flex; align-items:center; justify-content:flex-end; }
    .fileInput{ width: 190px; font-size: 12px; }

    .footer{
      display:flex; align-items:center; justify-content: space-between;
      gap: 12px; padding: 12px;
      border-top:1px solid var(--line);
      background:#fff;
    }

    /* Category 2 typeahead */
    .combo{ position: relative; }
    .comboRow{ display:flex; gap:6px; align-items:center; }
    .comboBtn{
      width: 38px; min-width:38px;
      border:1px solid var(--line);
      background:#fff;
      border-radius: 10px;
      padding: 8px 0;
      cursor:pointer;
      font-weight:900;
      color: var(--muted);
    }
    .comboBtn:hover{ background: var(--soft); }
    .menu{
      position:absolute;
      top: calc(100% + 6px);
      left:0;
      right:0;
      background:#fff;
      border:1px solid var(--line);
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,.08);
      max-height: 280px;
      overflow:auto;
      z-index: 10;
      display:none;
    }
    .menu.open{ display:block; }
    .menuGroup{
      padding: 8px 10px;
      border-bottom:1px solid var(--line);
      background: var(--soft);
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .menuItem{
      padding: 10px 10px;
      font-size: 13px;
      cursor:pointer;
      border-bottom: 1px solid rgba(229,231,235,.6);
    }
    .menuItem:hover{ background: var(--soft); }
    .menuItem:last-child{ border-bottom:none; }

    /* Report */
    .report{
      margin-top: 16px;
      border:1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
      background:#fff;
      display:none;
    }
    .reportHead{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
      padding: 12px;
      border-bottom:1px solid var(--line);
      background: var(--soft);
    }
    .reportHead h2{ margin:0; font-size: 14px; font-weight: 900; }
    .reportMeta{ font-size:12px; color: var(--muted); }

    .reportBody{ overflow:auto; }
    .reportTable{
      width:100%;
      border-collapse: collapse;
      min-width: 760px;
    }
    .reportTable th, .reportTable td{
      border:1px solid var(--line);
      padding: 10px 10px;
      font-size: 13px;
    }
    .reportTable thead th{
      position: sticky; top:0; z-index:2;
      background:#fff;
      color: var(--muted);
      font-size: 12px;
      text-align:left;
    }
    .reportTable td.num{
      text-align:right;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
      font-weight: 800;
    }
    .reportTable tr.section{ background: var(--soft2); }
    .reportTable tr.subRow td:first-child{ padding-left: 44px; font-weight: 700; }
    .toggleBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 999px;
      padding: 2px 8px;
      cursor:pointer;
      font-weight: 900;
      margin-right: 8px;
      width: 36px;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Transaction Entry</h1>
        <p class="sub">Payment Date: DD-MMM-YYYY • Category 1 auto-fills from Category 2 • Amount can be negative (refunds)</p>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn" id="btnDummy">Fill In With Dummy</button>
      </div>
    </div>

    <div class="card">
      <div class="toolbar">
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <span class="pill" id="rowCountPill">0 row(s)</span>
          <button class="btn ghost" id="btnAddRow">+ Add Line</button>
        </div>
        <div class="hint" id="validationSummary">No validation issues.</div>
      </div>

      <div class="tableWrap">
        <table id="entryTable" aria-label="Transaction entry table">
          <colgroup>
            <col style="width:44px" />
            <col style="width:130px" />
            <col style="width:150px" />
            <col style="width:140px" />
            <col style="width:280px" />
            <col style="width:300px" />
            <col style="width:120px" />
            <col style="width:120px" />
            <col style="width:160px" />
            <col style="width:160px" />
            <col style="width:170px" />
            <col style="width:130px" />
            <col style="width:220px" />
          </colgroup>
          <thead>
            <tr>
              <th>#</th>
              <th>Payment Date</th>
              <th>Academic Year</th>
              <th>Category 1</th>
              <th>Category 2</th>
              <th>Description</th>
              <th>Invoice Nr</th>
              <th>Receipt Nr</th>
              <th>Payer Name</th>
              <th>Receiver Name</th>
              <th>Wallet</th>
              <th>Amount</th>
              <th style="text-align:right;">Attach File</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="footer">
        <div></div>
        <button class="btn primary" id="btnSubmit">Submit Transaction(s)</button>
      </div>
    </div>

    <div class="report" id="report">
      <div class="reportHead">
        <div>
          <h2>Simple Financial Report</h2>
        </div>
        <div class="reportMeta" id="reportMeta"></div>
      </div>
      <div class="reportBody">
        <table class="reportTable" id="reportTable" aria-label="Financial report table"></table>
      </div>
    </div>
  </div>

<script>
(() => {
  // Academic Years (default columns)
  const ACADEMIC_YEARS_DEFAULT = ["AY2025-2026", "Summer2026", "AY2026-2027"];

  const WALLETS = ["Petty Cash", "KBZ Bank", "Aya Bank", "CB", "KPay", "Visa / Master Card"];

  // Category 2 lists mapped to Category 1 (Category 1 is auto)
  const CAT2_BY_CAT1 = {
    Income: [
      "Tuition Fee",
      "Registration Fee",
      "Material Fee",
      "Ferry Fee",
      "Sales Of Merchandise"
    ],
    Expense: [
      "Salary (Teaching)",
      "Salary (Office)",
      "Benefits And Welfare",
      "Digital Marketing",
      "Offline Marketing",
      "Classroom Expenses",
      "School Merchandise",
      "Building & Electrical Repair",
      "Electronic And Repair",
      "Utility Bills",
      "General & Administrative Expenses",
      "Supplies",
      "Materials And Stationery",
      "School Event Expense",
      "Donation & Gift",
      "Tax"
    ],
    Asset: [
      "Construction",
      "Solar Panel",
      "Electrical Setup",
      "Electronic Items",
      "Big Furniture",
      "Playground Equipment",
      "Rent"
    ],
    Investment: [
      "Other (Investment)"
    ]
  };

  const CAT1_ORDER = ["Income","Expense","Asset","Investment"];

  const CAT2_TO_CAT1 = (() => {
    const map = new Map();
    for (const [cat1, list] of Object.entries(CAT2_BY_CAT1)) {
      for (const cat2 of list) map.set(cat2, cat1);
    }
    return map;
  })();

  // DOM
  const tbody = document.getElementById("tbody");
  const btnAddRow = document.getElementById("btnAddRow");
  const btnDummy = document.getElementById("btnDummy");
  const btnSubmit = document.getElementById("btnSubmit");
  const rowCountPill = document.getElementById("rowCountPill");
  const validationSummary = document.getElementById("validationSummary");

  const reportWrap = document.getElementById("report");
  const reportTable = document.getElementById("reportTable");
  const reportMeta = document.getElementById("reportMeta");

  // Date helpers
  const pad2 = (n) => String(n).padStart(2, "0");
  const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const monthIndex = (mmm) => MONTHS.findIndex(m => m.toLowerCase() === String(mmm).toLowerCase());

  function toDDMMMYYYY(dateObj) {
    return `${pad2(dateObj.getDate())}-${MONTHS[dateObj.getMonth()]}-${dateObj.getFullYear()}`;
  }
  function parseDDMMMYYYY(s) {
    if (!s) return { ok:false, reason:"Empty" };
    const m = String(s).trim().match(/^(\d{2})-([A-Za-z]{3})-(\d{4})$/);
    if (!m) return { ok:false, reason:"Format: DD-MMM-YYYY" };
    const dd = Number(m[1]);
    const mi = monthIndex(m[2]);
    const yyyy = Number(m[3]);
    if (mi < 0) return { ok:false, reason:"Invalid month" };
    const d = new Date(yyyy, mi, dd);
    if (d.getFullYear() !== yyyy || d.getMonth() !== mi || d.getDate() !== dd) {
      return { ok:false, reason:"Invalid date" };
    }
    return { ok:true, date:d };
  }
  function isPastDate(dateObj) {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const d = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
    return d < today;
  }

  function formatMoney(n) {
    const sign = n < 0 ? "-" : "";
    const abs = Math.abs(n);
    const s = abs.toFixed(2);
    const [a,b] = s.split(".");
    const withCommas = a.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    return `${sign}${withCommas}.${b}`;
  }

  function buildSelect(options, placeholder = "Select...") {
    const sel = document.createElement("select");
    sel.className = "cell";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder;
    sel.appendChild(opt0);
    for (const v of options) {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      sel.appendChild(opt);
    }
    return sel;
  }
  function buildInput(placeholder="") {
    const inp = document.createElement("input");
    inp.className = "cell";
    inp.placeholder = placeholder;
    return inp;
  }
  function buildTextarea(placeholder="") {
    const ta = document.createElement("textarea");
    ta.className = "cell";
    ta.rows = 2;
    ta.placeholder = placeholder;
    return ta;
  }
  function buildFileInput() {
    const inp = document.createElement("input");
    inp.type = "file";
    inp.className = "fileInput";
    return inp;
  }

  function setAmountClass(el) {
    const raw = String(el.value).replace(/,/g,"").trim();
    const n = Number(raw);
    el.classList.add("amount");
    el.classList.remove("neg","pos");
    if (!raw || !isFinite(n)) return;
    el.classList.add(n < 0 ? "neg" : "pos");
  }

  function validateRow(tr) {
    const pdEl = tr.querySelector('[data-field="paymentDate"]');
    const msgEl = tr.querySelector('[data-field="paymentDateMsg"]');
    msgEl.textContent = "";
    msgEl.className = "";

    const v = { errors:0, warnings:0 };
    const raw = pdEl.value.trim();
    if (!raw) return v;

    const parsed = parseDDMMMYYYY(raw);
    if (!parsed.ok) {
      v.errors++;
      msgEl.textContent = parsed.reason;
      msgEl.className = "err";
      return v;
    }
    if (isPastDate(parsed.date)) {
      v.warnings++;
      msgEl.textContent = "Warning: date is in the past";
      msgEl.className = "warn";
    } else {
      msgEl.textContent = "OK";
      msgEl.className = "ok";
    }
    return v;
  }

  function refreshSummaryValidation() {
    let errors = 0, warnings = 0;
    for (const tr of [...tbody.querySelectorAll("tr")]) {
      const r = validateRow(tr);
      errors += r.errors;
      warnings += r.warnings;
    }
    if (errors === 0 && warnings === 0) validationSummary.textContent = "No validation issues.";
    else {
      const parts = [];
      if (errors) parts.push(`${errors} error(s)`);
      if (warnings) parts.push(`${warnings} warning(s)`);
      validationSummary.textContent = parts.join(" • ");
    }
  }

  function updateCat1(tr, cat2Val) {
    const c1 = tr.querySelector('[data-field="category1"]');
    c1.value = CAT2_TO_CAT1.get(cat2Val) || "";
  }

  // --- Category 2 typeahead (filter as you type; dropdown button shows ALL) ---
  function buildCategory2Combo(tr, prefillValue="") {
    const combo = document.createElement("div");
    combo.className = "combo";

    const row = document.createElement("div");
    row.className = "comboRow";

    const input = buildInput("Type to search...");
    input.setAttribute("data-field","category2");
    input.value = prefillValue || "";

    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "comboBtn";
    btn.textContent = "▾";
    btn.title = "Show all categories";

    const menu = document.createElement("div");
    menu.className = "menu";
    menu.setAttribute("data-menu","cat2");

    function closeMenu(){ menu.classList.remove("open"); }
    function openMenu(){ menu.classList.add("open"); }

    function renderMenu(query, forceAll=false) {
      const q = String(query || "").trim().toLowerCase();
      menu.innerHTML = "";

      for (const cat1 of CAT1_ORDER) {
        const list = CAT2_BY_CAT1[cat1] || [];
        const filtered = forceAll || !q
          ? list
          : list.filter(x => x.toLowerCase().includes(q));

        if (!filtered.length) continue;

        const g = document.createElement("div");
        g.className = "menuGroup";
        g.textContent = cat1;
        menu.appendChild(g);

        for (const item of filtered) {
          const it = document.createElement("div");
          it.className = "menuItem";
          it.textContent = item;
          it.addEventListener("mousedown", (e) => {
            e.preventDefault(); // keep focus behavior stable
            input.value = item;
            updateCat1(tr, item);
            closeMenu();
          });
          menu.appendChild(it);
        }
      }

      // If nothing matched
      if (!menu.children.length) {
        const empty = document.createElement("div");
        empty.className = "menuItem";
        empty.textContent = "No matches";
        empty.style.color = "var(--muted)";
        empty.style.cursor = "default";
        menu.appendChild(empty);
      }
    }

    // open + filter while typing
    input.addEventListener("input", () => {
      renderMenu(input.value, false);
      openMenu();
      updateCat1(tr, input.value);
    });

    input.addEventListener("focus", () => {
      renderMenu(input.value, false);
      openMenu();
    });

    btn.addEventListener("click", () => {
      renderMenu("", true); // show ALL
      openMenu();
      input.focus();
    });

    // click outside closes
    document.addEventListener("mousedown", (e) => {
      if (!combo.contains(e.target)) closeMenu();
    });

    row.appendChild(input);
    row.appendChild(btn);
    combo.appendChild(row);
    combo.appendChild(menu);

    // Initial cat1
    updateCat1(tr, input.value);
    return combo;
  }

  // --- Rows ---
  function addRow(prefill={}) {
    const tr = document.createElement("tr");

    const td0 = document.createElement("td");
    td0.className = "rownum";
    td0.textContent = String(tbody.children.length + 1);
    tr.appendChild(td0);

    // Payment Date
    const td1 = document.createElement("td");
    const pd = buildInput("DD-MMM-YYYY");
    pd.setAttribute("data-field","paymentDate");
    pd.value = prefill.paymentDate || "";
    const pdMsg = document.createElement("span");
    pdMsg.setAttribute("data-field","paymentDateMsg");
    td1.appendChild(pd);
    td1.appendChild(pdMsg);
    tr.appendChild(td1);

    // Academic Year
    const td2 = document.createElement("td");
    const ay = buildSelect(ACADEMIC_YEARS_DEFAULT, "Select...");
    ay.setAttribute("data-field","academicYear");
    ay.value = prefill.academicYear || "";
    td2.appendChild(ay);
    tr.appendChild(td2);

    // Category 1 (auto, disabled)
    const td3 = document.createElement("td");
    const c1 = buildSelect(CAT1_ORDER, "Auto...");
    c1.setAttribute("data-field","category1");
    c1.disabled = true;
    c1.value = prefill.category1 || "";
    td3.appendChild(c1);
    tr.appendChild(td3);

    // Category 2 (typeahead)
    const td4 = document.createElement("td");
    const c2combo = buildCategory2Combo(tr, prefill.category2 || "");
    td4.appendChild(c2combo);
    tr.appendChild(td4);

    // Description
    const td5 = document.createElement("td");
    const desc = buildTextarea("");
    desc.setAttribute("data-field","description");
    desc.value = prefill.description || "";
    td5.appendChild(desc);
    tr.appendChild(td5);

    // Invoice
    const td6 = document.createElement("td");
    const inv = buildInput("");
    inv.setAttribute("data-field","invoiceNr");
    inv.value = prefill.invoiceNr || "";
    td6.appendChild(inv);
    tr.appendChild(td6);

    // Receipt
    const td7 = document.createElement("td");
    const rec = buildInput("");
    rec.setAttribute("data-field","receiptNr");
    rec.value = prefill.receiptNr || "";
    td7.appendChild(rec);
    tr.appendChild(td7);

    // Payer
    const td8 = document.createElement("td");
    const payer = buildInput("");
    payer.setAttribute("data-field","payerName");
    payer.value = prefill.payerName || "";
    td8.appendChild(payer);
    tr.appendChild(td8);

    // Receiver
    const td9 = document.createElement("td");
    const recv = buildInput("");
    recv.setAttribute("data-field","receiverName");
    recv.value = prefill.receiverName || "";
    td9.appendChild(recv);
    tr.appendChild(td9);

    // Wallet
    const td10 = document.createElement("td");
    const w = buildSelect(WALLETS, "Select...");
    w.setAttribute("data-field","wallet");
    w.value = prefill.wallet || "";
    td10.appendChild(w);
    tr.appendChild(td10);

    // Amount
    const td11 = document.createElement("td");
    const amt = buildInput("0.00");
    amt.setAttribute("data-field","amount");
    amt.value = (prefill.amount ?? "") === "" ? "" : String(prefill.amount);
    td11.appendChild(amt);
    tr.appendChild(td11);

    // Attach
    const td12 = document.createElement("td");
    const fileCell = document.createElement("div");
    fileCell.className = "fileCell";
    const file = buildFileInput();
    file.setAttribute("data-field","file");
    fileCell.appendChild(file);
    td12.appendChild(fileCell);
    tr.appendChild(td12);

    // events
    pd.addEventListener("input", () => { validateRow(tr); refreshSummaryValidation(); });
    pd.addEventListener("blur",  () => { validateRow(tr); refreshSummaryValidation(); });

    amt.addEventListener("input", () => setAmountClass(amt));
    setAmountClass(amt);

    tbody.appendChild(tr);
    renumberRows();
    refreshRowCount();
    validateRow(tr);
    refreshSummaryValidation();
  }

  function renumberRows() {
    [...tbody.querySelectorAll("tr")].forEach((tr, i) => {
      tr.querySelector(".rownum").textContent = String(i + 1);
    });
  }
  function refreshRowCount() {
    rowCountPill.textContent = `${tbody.children.length} row(s)`;
  }

  function getRowData(tr) {
    const get = (name) => tr.querySelector(`[data-field="${name}"]`);
    const amountEl = get("amount");
    const amountVal = Number(String(amountEl.value).replace(/,/g,"").trim() || "0");
    const cat2Val = get("category2").value.trim();
    const cat1Val = get("category1").value || (CAT2_TO_CAT1.get(cat2Val) || "");
    return {
      paymentDate: get("paymentDate").value.trim(),
      academicYear: get("academicYear").value,
      category1: cat1Val,
      category2: cat2Val,
      description: get("description").value.trim(),
      invoiceNr: get("invoiceNr").value.trim(),
      receiptNr: get("receiptNr").value.trim(),
      payerName: get("payerName").value.trim(),
      receiverName: get("receiverName").value.trim(),
      wallet: get("wallet").value,
      amount: isFinite(amountVal) ? amountVal : 0,
      file: get("file").files && get("file").files[0] ? get("file").files[0].name : ""
    };
  }

  function collectRows() {
    return [...tbody.querySelectorAll("tr")]
      .map(getRowData)
      .filter(r => r.academicYear || r.category2 || r.paymentDate || r.description || r.amount);
  }

  function uniqueAcademicYears(rows) {
    const set = new Set();
    rows.forEach(r => { if (r.academicYear) set.add(r.academicYear); });
    const ordered = [];
    ACADEMIC_YEARS_DEFAULT.forEach(x => { if (set.has(x)) ordered.push(x); set.delete(x); });
    [...set].sort().forEach(x => ordered.push(x));
    return ordered.length ? ordered : [...ACADEMIC_YEARS_DEFAULT];
  }

  function buildReport(rows) {
    const years = uniqueAcademicYears(rows);

    // Aggregate: cat1 -> totals, and cat2 breakdown
    const agg = new Map(); // cat1 -> { totalByYear: Map, items: Map(cat2 -> Map(year->sum)) }

    for (const r of rows) {
      const cat1 = r.category1 || (CAT2_TO_CAT1.get(r.category2) || "");
      if (!cat1) continue;
      const cat2 = r.category2 || "Uncategorized";
      const ay = r.academicYear || "Unassigned";
      const amount = Number(r.amount || 0);

      if (!agg.has(cat1)) agg.set(cat1, { totalByYear: new Map(), items: new Map() });
      const node = agg.get(cat1);

      node.totalByYear.set(ay, (node.totalByYear.get(ay) || 0) + amount);

      if (!node.items.has(cat2)) node.items.set(cat2, new Map());
      const item = node.items.get(cat2);
      item.set(ay, (item.get(ay) || 0) + amount);
    }

    const expanded = new Map();
    CAT1_ORDER.forEach(c => expanded.set(c, false));

    function render() {
      const thead = document.createElement("thead");
      const hr = document.createElement("tr");
      const h0 = document.createElement("th");
      h0.textContent = "Category";
      hr.appendChild(h0);
      for (const y of years) {
        const th = document.createElement("th");
        th.textContent = y;
        hr.appendChild(th);
      }
      thead.appendChild(hr);

      const tb = document.createElement("tbody");

      for (const cat1 of CAT1_ORDER) {
        if (!agg.has(cat1)) continue;
        const node = agg.get(cat1);

        const tr = document.createElement("tr");
        tr.className = "section";

        const tdCat = document.createElement("td");
        const toggle = document.createElement("button");
        toggle.className = "toggleBtn";
        toggle.textContent = expanded.get(cat1) ? "[-]" : "[+]";
        toggle.addEventListener("click", () => {
          expanded.set(cat1, !expanded.get(cat1));
          renderIntoTable();
        });

        const label = document.createElement("span");
        label.style.fontWeight = "900";
        label.textContent = cat1.toUpperCase(); // <-- no extra [+]/[-] text

        tdCat.appendChild(toggle);
        tdCat.appendChild(label);
        tr.appendChild(tdCat);

        for (const y of years) {
          const td = document.createElement("td");
          td.className = "num";
          const v = node.totalByYear.get(y) || 0;
          td.textContent = formatMoney(v);
          if (v < 0) td.classList.add("neg");
          tr.appendChild(td);
        }
        tb.appendChild(tr);

        if (expanded.get(cat1)) {
          const itemsSorted = [...node.items.entries()].sort((a,b) => a[0].localeCompare(b[0]));
          for (const [cat2, byYear] of itemsSorted) {
            const r2 = document.createElement("tr");
            r2.className = "subRow";

            const td2 = document.createElement("td");
            td2.textContent = cat2;
            r2.appendChild(td2);

            for (const y of years) {
              const td = document.createElement("td");
              td.className = "num";
              const v = byYear.get(y) || 0;
              td.textContent = formatMoney(v);
              if (v < 0) td.classList.add("neg");
              r2.appendChild(td);
            }
            tb.appendChild(r2);
          }
        }
      }

      reportTable.innerHTML = "";
      reportTable.appendChild(thead);
      reportTable.appendChild(tb);
    }

    function renderIntoTable(){ render(); }

    renderIntoTable();

    reportMeta.textContent = `${rows.length} submitted row(s) • Years: ${years.join(", ")}`;
    reportWrap.style.display = "block";
    reportWrap.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  // Dummy data
  function randInt(min, max) { return Math.floor(Math.random()*(max-min+1))+min; }
  function pick(arr) { return arr[randInt(0, arr.length-1)]; }
  function randomName() {
    const first = ["Aye","Min","Htet","Su","May","Thiri","Ko","Zaw","Nandar","Myo","Khine","Lin","Win","Hla","Ei","Yoon","Sai","Nyein"];
    const last = ["Aung","Tun","Kyaw","Hlaing","Oo","Naing","Myint","Soe","Khin","Phyo","Wai","Zin","Htwe","Hnin","Lwin","Thant"];
    return `${pick(first)} ${pick(last)}`;
  }
  function randomDateNearToday() {
    const now = new Date();
    const offset = randInt(-20, 25);
    const d = new Date(now.getFullYear(), now.getMonth(), now.getDate() + offset);
    return toDDMMMYYYY(d);
  }
  function fillDummy(n=50) {
    tbody.innerHTML = "";
    const allCat2 = Object.values(CAT2_BY_CAT1).flat();

    for (let i=0; i<n; i++) {
      const cat2 = pick(allCat2);
      const cat1 = CAT2_TO_CAT1.get(cat2) || "";
      const ay = pick(ACADEMIC_YEARS_DEFAULT);

      let amount = 0;
      if (cat1 === "Income") amount = randInt(50, 1500);
      if (cat1 === "Expense") amount = -randInt(30, 1200);
      if (cat1 === "Asset") amount = -randInt(100, 6000);
      if (cat1 === "Investment") amount = randInt(0,1) ? randInt(100, 5000) : -randInt(100, 5000);

      // occasional tuition refund
      if (cat2 === "Tuition Fee" && randInt(1, 12) === 1) amount = -randInt(50, 500);

      addRow({
        paymentDate: randomDateNearToday(),
        academicYear: ay,
        category1: cat1,
        category2: cat2,
        description: `Transaction — ${cat2}.`,
        invoiceNr: `INV-${randInt(1000,9999)}`,
        receiptNr: `RCPT-${randInt(1000,9999)}`,
        payerName: randomName(),
        receiverName: randomName(),
        wallet: pick(WALLETS),
        amount: amount.toFixed(2)
      });
    }
    refreshSummaryValidation();
  }

  // Events
  btnAddRow.addEventListener("click", () => addRow());
  btnDummy.addEventListener("click", () => fillDummy(50));
  btnSubmit.addEventListener("click", () => buildReport(collectRows()));

  // Init
  for (let i=0; i<6; i++) addRow();
})();
</script>
</body>
</html>