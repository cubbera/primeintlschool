<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tuition Proration & Refund Calculator</title>

<style>
  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --line:#e5e7eb;
    --text:#111827;
    --muted:#6b7280;
    --danger:#b91c1c;

    --btn:#111827;
    --refund:#f97316;          /* ORANGE refund button */

    --t1:#2563eb;              /* Term 1 */
    --t2:#059669;              /* Term 2 */
    --t3:#9333ea;              /* Term 3 */
    --off:#9ca3af;             /* Break/Outside */
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    font-size:12px;
    line-height:1.35;
  }
  .page{
    max-width:980px;
    margin:16px auto;
    padding:0 14px 24px;
  }
  .titlebar{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:12px;
    margin-bottom:10px;
  }
  h1{
    margin:0;
    font-size:16px;
    letter-spacing:.2px;
  }
  .subtitle{
    margin:0;
    color:var(--muted);
    font-size:12px;
  }

  /* Main card */
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
    box-shadow:0 10px 22px rgba(17,24,39,.06);
  }

  /* Single-column lines but aligned */
  .line{
    display:grid;
    grid-template-columns:auto 16px 1fr;
    align-items:center;
    column-gap:10px;
    margin:6px 0;
  }
  .lhs{
    white-space:nowrap;
    font-weight:800;
  }
  .eq{
    text-align:center;
    font-weight:900;
    color:var(--muted);
  }
  .rhs{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }

  input{
    font-size:12px;
    padding:6px 8px;
    border:1px solid var(--line);
    border-radius:10px;
    background:#fff;
    outline:none;
  }
  input[type="date"]{ padding:5px 8px; }

  .moneyIn{
    width:200px;
    font-weight:900;
    letter-spacing:.2px;
    font-variant-numeric:tabular-nums;
    text-align:right;
  }
  .discIn{
    width:200px;
    font-weight:1000;
    color:var(--danger);
    font-variant-numeric:tabular-nums;
    text-align:right;
  }

  .tag{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:2px 9px;
    border-radius:999px;
    border:1px solid var(--line);
    background:#f3f4f6;
    font-weight:900;
    font-size:12px;
  }

  .out{
    font-size:14px;
    font-weight:1000;
    letter-spacing:.3px;
    font-variant-numeric:tabular-nums;
  }
  .muted{ color:var(--muted); font-weight:800; }

  .btnRow{
    margin-top:6px;
    margin-bottom:2px;
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  button{
    appearance:none;
    border:1px solid var(--btn);
    background:var(--btn);
    color:#fff;
    font-size:12px;
    font-weight:1000;
    padding:8px 10px;
    border-radius:10px;
    cursor:pointer;
  }
  button.secondary{
    background:#fff;
    color:var(--btn);
    border:1px solid var(--line);
  }
  button.refund{
    background:var(--refund);
    border-color:var(--refund);
  }

  .gap3{height:18px}

  /* Reference */
  .ref{
    margin-top:12px;
    background:var(--card);
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
  }
  .ref h2{
    margin:0 0 6px;
    font-size:13px;
  }
  .refBtns{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin:8px 0 10px;
  }
  .refBtns button{
    background:#fff;
    color:var(--btn);
    border:1px solid var(--line);
    font-weight:900;
  }

  table{
    width:100%;
    border-collapse:collapse;
    font-size:11px;
    margin-top:6px;
  }
  th,td{
    border:1px solid var(--line);
    padding:6px;
    text-align:center;
  }
  th{
    background:#fafafa;
    font-weight:1000;
    color:#374151;
  }

  /* Month strips */
  .monthBlock{
    margin-top:10px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .ayLabel{
    font-weight:1000;
    color:#374151;
    font-size:12px;
    margin-top:6px;
  }
  .months{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
  }
  .m{
    min-width:54px;
    padding:4px 6px;
    border-radius:10px;
    color:#fff;
    font-weight:1000;
    font-size:11px;
    text-align:center;
    letter-spacing:.2px;
  }
  .t1{background:var(--t1)}
  .t2{background:var(--t2)}
  .t3{background:var(--t3)}
  .off{background:var(--off)}

  /* Steps at bottom */
  .steps{
    margin-top:12px;
    padding:10px;
    border:1px dashed var(--line);
    border-radius:12px;
    background:#fafafa;
  }
  .steps h3{
    margin:0 0 6px;
    font-size:12px;
    letter-spacing:.2px;
  }
  .steps pre{
    margin:0;
    white-space:pre-wrap;
    font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
    font-size:11px;
    color:#374151;
  }

  /* Hide */
  .hidden{display:none!important;}

</style>
</head>

<body>
<div class="page">

  <div class="titlebar">
    <div>
      <h1>Tuition Proration & Refund Calculator</h1>
      <p class="subtitle">Proration uses BASE ÷ 10 × months attend. Refund uses FINAL tuition after discount ÷ initial months × unused term months.</p>
    </div>
  </div>

  <div class="card">

    <div class="line">
      <div class="lhs">BASE tuition fee</div>
      <div class="eq">=</div>
      <div class="rhs">
        <input id="baseFee" class="moneyIn" value="10,000,000" inputmode="numeric" />
      </div>
    </div>

    <div class="line">
      <div class="lhs">Join date</div>
      <div class="eq">=</div>
      <div class="rhs">
        <input id="joinDate" type="date" />
        <span class="tag" id="joinTermTag">[Academic Year - Term]</span>
      </div>
    </div>

    <div class="line">
      <div class="lhs">Tuition Fee before discount [AFTER PRORATE]</div>
      <div class="eq">=</div>
      <div class="rhs">
        <span class="out" id="proratedFee">0</span>
        <span class="tag" id="monthsAttendTag">[0 months]</span>
      </div>
    </div>

    <div class="line">
      <div class="lhs">Discount #1</div>
      <div class="eq">=</div>
      <div class="rhs">
        <input id="disc1" class="discIn" value="-1,000,000" inputmode="numeric" />
      </div>
    </div>

    <div class="line">
      <div class="lhs">Discount #2</div>
      <div class="eq">=</div>
      <div class="rhs">
        <input id="disc2" class="discIn" value="-0" inputmode="numeric" />
      </div>
    </div>

    <div class="btnRow">
      <button type="button" id="calcFinalBtn">Calculate Final Amount</button>
    </div>

    <div class="line" style="margin-top:8px;">
      <div class="lhs">FINAL Tuition Fee after discount</div>
      <div class="eq">=</div>
      <div class="rhs">
        <span class="out" id="finalFee">0</span>
      </div>
    </div>

    <div class="gap3"></div>
    <div class="gap3"></div>

    <div class="line">
      <div class="lhs">Leave date</div>
      <div class="eq">=</div>
      <div class="rhs">
        <input id="leaveDate" type="date" />
        <span class="tag" id="leaveTermTag">[Academic Year - Term]</span>
      </div>
    </div>

    <div class="btnRow">
      <button type="button" class="refund" id="calcRefundBtn">Calculate Refund</button>
    </div>

    <div class="line" style="margin-top:8px;">
      <div class="lhs">Refundable amount</div>
      <div class="eq">=</div>
      <div class="rhs">
        <span class="out" id="refundAmount">0</span>
        <span class="tag" id="refundMeta">[0 terms, 0 months]</span>
      </div>
    </div>

  </div>

  <div class="ref">
    <h2>Reference</h2>

    <div class="refBtns">
      <button type="button" id="toggleRefTableBtn">Hide/Show Reference Calendar 1 (Table)</button>
      <button type="button" id="toggleRefChartBtn">Hide/Show Reference Calendar 2 (Chart)</button>
    </div>

    <!-- Reference Calendar 1 (Table) -->
    <div id="refTableBox">
      <div class="muted">1) Term start/end table (AY2025-2026 and AY2026-2027)</div>

      <table>
        <tr>
          <th>Academic Year</th><th>Term</th><th>Start</th><th>End</th><th>Months</th>
        </tr>
        <tr><td rowspan="3">AY2025-2026</td><td>Term 1</td><td>2025-06-10</td><td>2025-08-29</td><td>3</td></tr>
        <tr><td>Term 2</td><td>2025-09-01</td><td>2025-11-28</td><td>3</td></tr>
        <tr><td>Term 3</td><td>2025-12-01</td><td>2026-04-03</td><td>4</td></tr>

        <tr><td rowspan="3">AY2026-2027</td><td>Term 1</td><td>2026-06-16</td><td>2026-09-04</td><td>3</td></tr>
        <tr><td>Term 2</td><td>2026-09-07</td><td>2026-12-18</td><td>3</td></tr>
        <tr><td>Term 3</td><td>2027-01-05</td><td>2027-03-31</td><td>4</td></tr>
      </table>
    </div>

    <!-- Reference Calendar 2 (Chart) -->
    <div id="refChartBox" style="margin-top:12px;">
      <div class="muted">2) Month view (accurate colors). Dec 26 is Term 2.</div>

      <div class="monthBlock">
        <div class="ayLabel">AY2025-2026</div>
        <div class="months" id="months2526"></div>

        <div class="ayLabel">AY2026-2027</div>
        <div class="months" id="months2627"></div>
      </div>
    </div>
  </div>

  <!-- Step-by-step moved to bottom -->
  <div class="steps">
    <h3>Step-by-step calculation</h3>
    <pre id="stepsText">Select Join date, click Calculate Final Amount, then select Leave date and click Calculate Refund.</pre>
  </div>

</div>

<script>
/* ============================================================
   TERM DATA (DO NOT CHANGE)
   ============================================================ */
const TERMS = {
  "AY2025-2026": [
    { name:"Term 1", start:"2025-06-10", end:"2025-08-29", months:3 },
    { name:"Term 2", start:"2025-09-01", end:"2025-11-28", months:3 },
    { name:"Term 3", start:"2025-12-01", end:"2026-04-03", months:4 }
  ],
  "AY2026-2027": [
    { name:"Term 1", start:"2026-06-16", end:"2026-09-04", months:3 },
    { name:"Term 2", start:"2026-09-07", end:"2026-12-18", months:3 },
    { name:"Term 3", start:"2027-01-05", end:"2027-03-31", months:4 }
  ]
};

/* 10-month AY model months (Jun–Mar) */
const AY_MONTHS = {
  "AY2025-2026": ["2025-06","2025-07","2025-08","2025-09","2025-10","2025-11","2025-12","2026-01","2026-02","2026-03"],
  "AY2026-2027": ["2026-06","2026-07","2026-08","2026-09","2026-10","2026-11","2026-12","2027-01","2027-02","2027-03"]
};

const $ = (id)=>document.getElementById(id);

/* ============================================================
   MONEY HELPERS
   ============================================================ */
function parseMoney(str){
  return Number(String(str||"").replace(/,/g,"").trim()) || 0;
}
function formatMoney(n){
  return Number(n||0).toLocaleString("en-US");
}

/* Ensure discounts ALWAYS stay negative (and show "-") */
function forceNegativeDisplay(rawValue){
  // Keep a "-" always visible even if empty
  if(rawValue == null) return "-0";
  let s = String(rawValue).trim();

  // If user typed only "-", keep it
  if(s === "-") return "-0";

  // Remove commas, parse
  let n = parseMoney(s);

  // Always store negative (or -0)
  if(n > 0) n = -n;
  if(n === 0) return "-0";

  return "-" + formatMoney(Math.abs(n));
}

/* Format base fee (non-negative) */
function normalizeBase(rawValue){
  const n = parseMoney(rawValue);
  return formatMoney(Math.max(0, n));
}

/* ============================================================
   DATE HELPERS
   ============================================================ */
function dateObj(iso){
  if(!iso) return null;
  const d = new Date(iso + "T00:00:00");
  return isNaN(d.getTime()) ? null : d;
}
function ymKey(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}
function inRange(d, startIso, endIso){
  const s = new Date(startIso + "T00:00:00");
  const e = new Date(endIso + "T00:00:00");
  return d >= s && d <= e;
}

/* Find term by date */
function findTermByDate(d){
  if(!d) return null;
  for(const ay of Object.keys(TERMS)){
    for(const t of TERMS[ay]){
      if(inRange(d, t.start, t.end)){
        return { ay, term: t.name, months: t.months };
      }
    }
  }
  return null;
}

/* Months attend = join month → end of AY months list (Jun–Mar) */
function calcMonthsAttend(joinDate){
  const jt = findTermByDate(joinDate);
  if(!jt) return { ay:null, monthsAttend:0 };

  const months = AY_MONTHS[jt.ay] || [];
  const idx = months.indexOf(ymKey(joinDate));
  if(idx === -1) return { ay:jt.ay, monthsAttend:0 };

  return { ay: jt.ay, monthsAttend: months.length - idx };
}

/* Build list of "paid months" (YYYY-MM) from join month to AY end */
function buildPaidMonths(ay, joinDate){
  const months = AY_MONTHS[ay] || [];
  const idx = months.indexOf(ymKey(joinDate));
  if(idx === -1) return [];
  return months.slice(idx); // inclusive join month → end
}

/* Months in refundable terms (terms AFTER leave term) */
function buildRefundableTermMonths(ay, leaveTermName){
  const terms = TERMS[ay] || [];
  const leaveIdx = terms.findIndex(t => t.name === leaveTermName);
  const remaining = leaveIdx >= 0 ? terms.slice(leaveIdx + 1) : [];

  // Convert each remaining term months into list of YYYY-MM in AY months model
  // We map by the AY_MONTHS list membership (Jun–Mar), because your policy is 10-month model.
  const ayMonths = AY_MONTHS[ay] || [];
  const out = [];

  remaining.forEach(t=>{
    const s = new Date(t.start + "T00:00:00");
    const e = new Date(t.end + "T00:00:00");

    // Loop months between start and end, collect YYYY-MM if present in AY months list
    const cur = new Date(s.getFullYear(), s.getMonth(), 1);
    const end = new Date(e.getFullYear(), e.getMonth(), 1);

    while(cur <= end){
      const y = cur.getFullYear();
      const m = String(cur.getMonth()+1).padStart(2,"0");
      const ym = `${y}-${m}`;
      if(ayMonths.includes(ym) && !out.includes(ym)){
        out.push(ym);
      }
      cur.setMonth(cur.getMonth()+1);
    }
  });

  // Sort by AY month order
  out.sort((a,b)=> (ayMonths.indexOf(a) - ayMonths.indexOf(b)));
  return out;
}

/* Count remaining terms/months AFTER leave term (for label) */
function calcRefundableMonthsTerms(ay, leaveTermName){
  const list = TERMS[ay] || [];
  const leaveIdx = list.findIndex(t => t.name === leaveTermName);
  const remaining = leaveIdx >= 0 ? list.slice(leaveIdx + 1) : [];
  return {
    termsCount: remaining.length,
    monthsCount: remaining.reduce((s,t)=>s+(t.months||0),0)
  };
}

/* ============================================================
   AUTO UPDATES (JOIN / LEAVE)
   ============================================================ */
function updateJoinAuto(){
  const j = dateObj($("joinDate").value);
  const jt = findTermByDate(j);

  $("joinTermTag").textContent = jt ? `[${jt.ay} - ${jt.term}]` : `[Academic Year - Term]`;

  const base = parseMoney($("baseFee").value);
  const res = calcMonthsAttend(j);

  $("monthsAttendTag").textContent = `[${res.monthsAttend} months]`;

  if(!jt || res.monthsAttend <= 0 || base <= 0){
    $("proratedFee").textContent = "0";
    return;
  }

  const prorated = Math.round((base / 10) * res.monthsAttend);
  $("proratedFee").textContent = formatMoney(prorated);
}

function updateLeaveAuto(){
  const l = dateObj($("leaveDate").value);
  const lt = findTermByDate(l);
  $("leaveTermTag").textContent = lt ? `[${lt.ay} - ${lt.term}]` : `[Academic Year - Term]`;
}

/* ============================================================
   FINAL CALCULATION (writes step-by-step FINAL section)
   ============================================================ */
function calcFinal(){
  const base = parseMoney($("baseFee").value);
  const j = dateObj($("joinDate").value);
  const jt = findTermByDate(j);

  const monthsAttend = Number(String($("monthsAttendTag").textContent).replace(/[^\d]/g,"")) || 0;
  const prorated = parseMoney($("proratedFee").textContent);

  const d1 = parseMoney($("disc1").value); // negative
  const d2 = parseMoney($("disc2").value); // negative

  const final = prorated + d1 + d2;
  $("finalFee").textContent = formatMoney(final);

  const prCalc = Math.round((base/10) * monthsAttend);

  $("stepsText").textContent =
`FINAL AMOUNT
1) Base = ${formatMoney(base)}
2) Months attend = ${monthsAttend}
3) Prorate = Base ÷ 10 × Months attend = ${formatMoney(prCalc)}
4) Discount #1 = ${formatMoney(d1)}
5) Discount #2 = ${formatMoney(d2)}
6) FINAL Tuition Fee after Discount = Prorate + D1 + D2 = ${formatMoney(final)}

Refund only unused months from unconsumed terms (terms after the leave term), but never more than months actually paid.`;
}

/* ============================================================
   REFUND CALCULATION (clears step-by-step each click)
   - Leave date must be AFTER join date
   - Refund uses: FINAL ÷ initial months attend × refundable months (overlap)
   ============================================================ */
function calcRefund(){
  // ALWAYS clear step-by-step first (per your request)
  // Then rebuild using real amounts.
  $("stepsText").textContent = "";

  const join = dateObj($("joinDate").value);
  const leave = dateObj($("leaveDate").value);

  if(!join || !leave){
    $("refundAmount").textContent = "0";
    $("refundMeta").textContent = "[0 terms, 0 months]";
    $("stepsText").textContent = "Please select both Join date and Leave date.";
    return;
  }

  // Enforce: leave date should be after join date
  if(leave <= join){
    $("refundAmount").textContent = "0";
    $("refundMeta").textContent = "[0 terms, 0 months]";
    $("stepsText").textContent = "Leave date must be AFTER join date.";
    alert("Leave date must be AFTER join date.");
    return;
  }

  const joinTerm = findTermByDate(join);
  const leaveTerm = findTermByDate(leave);

  const monthsAttend = Number(String($("monthsAttendTag").textContent).replace(/[^\d]/g,"")) || 0;

  // Make sure final is calculated
  if(parseMoney($("finalFee").textContent) <= 0){
    calcFinal();
  }

  const final = parseMoney($("finalFee").textContent);

  if(!joinTerm || !leaveTerm || monthsAttend <= 0 || final <= 0){
    $("refundAmount").textContent = "0";
    $("refundMeta").textContent = "[0 terms, 0 months]";
    $("stepsText").textContent = "Invalid dates or amounts. Please check Join/Leave dates and click Calculate Final Amount.";
    return;
  }

  // Must be same AY for this calculator version
  if(joinTerm.ay !== leaveTerm.ay){
    $("refundAmount").textContent = "0";
    $("refundMeta").textContent = "[Different AY]";
    $("stepsText").textContent = "Join and Leave must be in the same Academic Year for this calculator.";
    return;
  }

  // Paid months list (based on join month to AY end)
  const paidMonths = buildPaidMonths(joinTerm.ay, join);

  // Refundable term months = months in terms AFTER leave term
  const refundableTermMonths = buildRefundableTermMonths(leaveTerm.ay, leaveTerm.term);

  // Intersection: only refund months that were paid AND belong to unconsumed terms
  const refundableMonths = refundableTermMonths.filter(m => paidMonths.includes(m));

  // Count terms/months label still based on "terms after leave term" and their month total
  // BUT refund months used in calculation is the INTERSECTION count.
  const { termsCount } = calcRefundableMonthsTerms(leaveTerm.ay, leaveTerm.term);
  const monthsCount = refundableMonths.length;

  const monthlyRate = final / monthsAttend;
  const refund = Math.round(monthlyRate * monthsCount);

  $("refundAmount").textContent = formatMoney(refund);
  $("refundMeta").textContent = `[${termsCount} terms, ${monthsCount} months]`;

  // Build full step-by-step (FINAL + REFUND) fresh each time
  const base = parseMoney($("baseFee").value);
  const prorated = parseMoney($("proratedFee").textContent);
  const d1 = parseMoney($("disc1").value);
  const d2 = parseMoney($("disc2").value);

  $("stepsText").textContent =
`FINAL AMOUNT
1) Base = ${formatMoney(base)}
2) Months attend = ${monthsAttend}
3) Prorate = Base ÷ 10 × Months attend = ${formatMoney(prorated)}
4) Discount #1 = ${formatMoney(d1)}
5) Discount #2 = ${formatMoney(d2)}
6) FINAL Tuition Fee after Discount = Prorate + D1 + D2 = ${formatMoney(final)}

Refund only unused months from unconsumed terms (terms after the leave term).

REFUND CALCULATION
1) FINAL Tuition Fee after Discount = ${formatMoney(final)}
2) Total initial prorated months attend = ${monthsAttend}
3) Monthly rate for refund = FINAL ÷ initial months = ${formatMoney(Math.round(monthlyRate))}
4) Refundable amount = Monthly rate × valid refundable months of unused term = ${formatMoney(refund)}

Paid months (from join month): ${paidMonths.join(", ")}
Unused-term months (terms after leave term): ${refundableTermMonths.join(", ")}
Refundable months (overlap): ${refundableMonths.join(", ")}`;
}

/* ============================================================
   REFERENCE CHART (accurate colors, Dec 26 is Term 2)
   ============================================================ */
function buildMonthStrips(){
  const months2526 = [
    ["Jun 25","t1"],["Jul","t1"],["Aug","t1"],["Sep","t2"],
    ["Oct","t2"],["Nov","t2"],["Dec","t3"],["Jan 26","t3"],
    ["Feb","t3"],["Mar","t3"],["Apr","t3"],["May","off"]
  ];

  const months2627 = [
    ["Jun 26","t1"],["Jul","t1"],["Aug","t1"],["Sep","t2"],
    ["Oct","t2"],["Nov","t2"],["Dec","t2"],["Jan 27","t3"],
    ["Feb","t3"],["Mar","t3"],["Apr","off"],["May","off"]
  ];

  function render(targetId, arr){
    const host = $(targetId);
    host.innerHTML = "";
    arr.forEach(([label, cls])=>{
      const s = document.createElement("span");
      s.className = `m ${cls}`;
      s.textContent = label;
      host.appendChild(s);
    });
  }

  render("months2526", months2526);
  render("months2627", months2627);
}

/* ============================================================
   INPUT NORMALIZATION (blur + safe defaults)
   ============================================================ */
function wireMoneyInputs(){
  // Base fee: normal
  $("baseFee").addEventListener("blur", ()=>{
    $("baseFee").value = normalizeBase($("baseFee").value);
    updateJoinAuto();
  });

  // Discounts: ALWAYS negative, ALWAYS show "-"
  ["disc1","disc2"].forEach(id=>{
    const el = $(id);

    // On blur: force negative formatting
    el.addEventListener("blur", ()=>{
      el.value = forceNegativeDisplay(el.value);
    });

    // If user deletes everything, keep "-0"
    el.addEventListener("input", ()=>{
      if(String(el.value).trim() === ""){
        el.value = "-0";
        // place cursor at end
        try{ el.setSelectionRange(el.value.length, el.value.length); }catch(e){}
      }
    });
  });
}

/* ============================================================
   LEAVE DATE VALIDATION ON CHANGE
   ============================================================ */
function wireDateValidation(){
  $("leaveDate").addEventListener("change", ()=>{
    const join = dateObj($("joinDate").value);
    const leave = dateObj($("leaveDate").value);
    updateLeaveAuto();

    if(join && leave && leave <= join){
      alert("Leave date must be AFTER join date.");
      $("leaveDate").value = "";
      updateLeaveAuto();
    }
  });

  $("joinDate").addEventListener("change", ()=>{
    updateJoinAuto();

    // If leave already selected, re-validate
    const join = dateObj($("joinDate").value);
    const leave = dateObj($("leaveDate").value);
    if(join && leave && leave <= join){
      alert("Leave date must be AFTER join date.");
      $("leaveDate").value = "";
      updateLeaveAuto();
    }
  });
}

/* ============================================================
   REFERENCE TOGGLES (ONLY)
   ============================================================ */
function wireReferenceToggles(){
  $("toggleRefTableBtn").addEventListener("click", ()=>{
    $("refTableBox").classList.toggle("hidden");
  });
  $("toggleRefChartBtn").addEventListener("click", ()=>{
    $("refChartBox").classList.toggle("hidden");
  });
}

/* ============================================================
   INIT
   ============================================================ */
(function init(){
  // Defaults
  $("baseFee").value = normalizeBase($("baseFee").value);
  $("disc1").value = forceNegativeDisplay($("disc1").value);
  $("disc2").value = forceNegativeDisplay($("disc2").value);

  buildMonthStrips();
  wireMoneyInputs();
  wireDateValidation();
  wireReferenceToggles();

  // Live updates
  $("baseFee").addEventListener("input", updateJoinAuto);
  $("joinDate").addEventListener("change", updateJoinAuto);

  // Buttons
  $("calcFinalBtn").addEventListener("click", ()=>{
    $("baseFee").value = normalizeBase($("baseFee").value);
    $("disc1").value = forceNegativeDisplay($("disc1").value);
    $("disc2").value = forceNegativeDisplay($("disc2").value);
    updateJoinAuto();
    calcFinal();
  });

  $("calcRefundBtn").addEventListener("click", ()=>{
    // normalize first
    $("baseFee").value = normalizeBase($("baseFee").value);
    $("disc1").value = forceNegativeDisplay($("disc1").value);
    $("disc2").value = forceNegativeDisplay($("disc2").value);
    updateJoinAuto();
    updateLeaveAuto();

    // Always recompute final first (safe)
    calcFinal();

    // Then compute refund (and clear steps each time)
    calcRefund();
  });

  // Initial render
  updateJoinAuto();
  updateLeaveAuto();
})();
</script>
</body>
</html>
