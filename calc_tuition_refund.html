<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tuition Proration & Refund Calculator</title>
<style>
  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --line:#e5e7eb;
    --text:#111827;
    --muted:#6b7280;
    --danger:#b91c1c;

    --btn:#111827;
    --btn2:#f97316; /* refund button ORANGE */

    --t1:#2563eb;  /* Term 1 */
    --t2:#059669;  /* Term 2 */
    --t3:#9333ea;  /* Term 3 */
    --off:#9ca3af; /* Break/Outside 10-month */
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    font-size:12px;
    line-height:1.35;
  }
  .page{
    max-width:980px;
    margin:16px auto;
    padding:0 14px 24px;
  }
  .titlebar{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:12px;
    margin-bottom:10px;
  }
  h1{
    margin:0;
    font-size:16px;
    letter-spacing:.2px;
  }
  .subtitle{
    margin:0;
    color:var(--muted);
    font-size:12px;
  }

  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
    box-shadow: 0 10px 22px rgba(17,24,39,.06);
  }

  /* Single-column lines but aligned */
  .line{
    display:grid;
    grid-template-columns: auto 16px 1fr;
    align-items:center;
    column-gap:10px;
    margin:6px 0;
  }
  .lhs{
    white-space:nowrap;
    font-weight:800;
  }
  .eq{
    text-align:center;
    font-weight:900;
    color:var(--muted);
  }
  .rhs{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }

  input{
    font-size:12px;
    padding:6px 8px;
    border:1px solid var(--line);
    border-radius:10px;
    background:#fff;
    outline:none;
  }
  input[type="date"]{ padding:5px 8px; }

  .moneyIn{
    width:190px;
    font-weight:900;
    letter-spacing:.2px;
    font-variant-numeric: tabular-nums;
    text-align:right;
  }
  .discIn{
    width:190px;
    font-weight:1000;
    color:var(--danger);
    font-variant-numeric: tabular-nums;
    text-align:right;
  }

  .tag{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:2px 9px;
    border-radius:999px;
    border:1px solid var(--line);
    background:#f3f4f6;
    font-weight:900;
    font-size:12px;
  }

  .out{
    font-size:14px;
    font-weight:1000;
    letter-spacing:.3px;
    font-variant-numeric: tabular-nums;
  }
  .muted{ color:var(--muted); font-weight:800; }

  .btnRow{
    margin-top:6px;
    margin-bottom:2px;
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
  }
  button{
    appearance:none;
    border:1px solid var(--btn);
    background:var(--btn);
    color:#fff;
    font-size:12px;
    font-weight:1000;
    padding:8px 10px;
    border-radius:10px;
    cursor:pointer;
  }
  button.secondary{
    background:#fff;
    color:var(--btn);
    border:1px solid var(--line);
  }
  button.refund{
    background:var(--btn2);
    border-color:var(--btn2);
    color:#111827;
  }

  .gap3{height:18px}

  /* Step-by-step box */
  .steps{
    margin-top:10px;
    padding:10px;
    border:1px dashed var(--line);
    border-radius:12px;
    background:#fafafa;
  }
  .steps h3{
    margin:0 0 6px;
    font-size:12px;
    letter-spacing:.2px;
  }
  .steps pre{
    margin:0;
    white-space:pre-wrap;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    font-size:11px;
    color:#374151;
  }

  /* Reference box */
  .ref{
    margin-top:12px;
    background:var(--card);
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
  }
  .ref h2{
    margin:0 0 6px;
    font-size:13px;
  }
  table{
    width:100%;
    border-collapse:collapse;
    font-size:11px;
    margin-top:6px;
  }
  th,td{
    border:1px solid var(--line);
    padding:6px;
    text-align:center;
  }
  th{
    background:#fafafa;
    font-weight:1000;
    color:#374151;
  }

  /* Month strips */
  .monthBlock{
    margin-top:10px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .ayLabel{
    font-weight:1000;
    color:#374151;
    font-size:12px;
    margin-top:6px;
  }
  .months{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
  }
  .m{
    min-width:54px;
    padding:4px 6px;
    border-radius:10px;
    color:#fff;
    font-weight:1000;
    font-size:11px;
    text-align:center;
    letter-spacing:.2px;
  }
  .t1{background:var(--t1)}
  .t2{background:var(--t2)}
  .t3{background:var(--t3)}
  .off{background:var(--off)}

  /* Toggle blocks */
  .toggleRow{
    margin:6px 0 8px;
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
  }
  .hidden{display:none !important;}
</style>
</head>

<body>
<div class="page">

  <div class="titlebar">
    <div>
      <h1>Tuition Proration & Refund Calculator</h1>
      <p class="subtitle">Proration uses BASE ÷ 10 × months attend. Refund uses FINAL tuition after discount (per attended month) × valid refundable months of unused term.</p>
    </div>
  </div>

  <div class="card">

    <div class="line">
      <div class="lhs">BASE tuition fee</div>
      <div class="eq">=</div>
      <div class="rhs">
        <input id="baseFee" class="moneyIn" value="10,000,000" inputmode="numeric" />
      </div>
    </div>

    <!-- Toggle 1 -->
    <div class="toggleRow">
      <button type="button" class="secondary" id="toggleJoinBtn">Hide Join Date</button>
      <span class="muted">Toggle to show/hide Join Date calendar</span>
    </div>

    <!-- Join date calendar moved into its own block (second box) -->
    <div id="joinBlock" class="steps" style="margin-top:0;">
      <div class="line" style="margin:0;">
        <div class="lhs">Join date</div>
        <div class="eq">=</div>
        <div class="rhs">
          <input id="joinDate" type="date" />
          <span class="tag" id="joinTermTag">[Academic Year - Term]</span>
        </div>
      </div>
    </div>

    <div class="line">
      <div class="lhs">Tuition Fee before discount [AFTER PRORATE]</div>
      <div class="eq">=</div>
      <div class="rhs">
        <span class="out" id="proratedFee">0</span>
        <span class="tag" id="monthsAttendTag">[0 months]</span>
      </div>
    </div>

    <div class="line">
      <div class="lhs">Discount #1</div>
      <div class="eq">=</div>
      <div class="rhs">
        <input id="disc1" class="discIn" value="-100,000" inputmode="numeric" />
      </div>
    </div>

    <div class="line">
      <div class="lhs">Discount #2</div>
      <div class="eq">=</div>
      <div class="rhs">
        <input id="disc2" class="discIn" value="-50,000" inputmode="numeric" />
      </div>
    </div>

    <div class="btnRow">
      <button type="button" id="calcFinalBtn">Calculate Final Amount</button>
    </div>

    <div class="line" style="margin-top:8px;">
      <div class="lhs">FINAL Tuition Fee after discount</div>
      <div class="eq">=</div>
      <div class="rhs">
        <span class="out" id="finalFee">0</span>
      </div>
    </div>

    <div class="gap3"></div>
    <div class="gap3"></div>

    <!-- Toggle 2 -->
    <div class="toggleRow">
      <button type="button" class="secondary" id="toggleLeaveBtn">Hide Leave Date</button>
      <span class="muted">Toggle to show/hide Leave Date calendar</span>
    </div>

    <!-- Leave date calendar moved into its own block (second box) -->
    <div id="leaveBlock" class="steps" style="margin-top:0;">
      <div class="line" style="margin:0;">
        <div class="lhs">Leave date</div>
        <div class="eq">=</div>
        <div class="rhs">
          <input id="leaveDate" type="date" />
          <span class="tag" id="leaveTermTag">[Academic Year - Term]</span>
        </div>
      </div>
    </div>

    <div class="btnRow">
      <button type="button" class="refund" id="calcRefundBtn">Calculate Refund</button>
    </div>

    <div class="line" style="margin-top:8px;">
      <div class="lhs">Refundable amount</div>
      <div class="eq">=</div>
      <div class="rhs">
        <span class="out" id="refundAmount">0</span>
        <span class="tag" id="refundMeta">[0 terms, 0 months]</span>
      </div>
    </div>

    <div class="steps">
      <h3>Step-by-step calculation</h3>
      <pre id="stepsText">Select Join date, click Calculate Final Amount, then select Leave date and click Calculate Refund.</pre>
    </div>

  </div>

  <div class="ref">
    <h2>Reference</h2>
    <div class="muted">1) Term start/end table (AY2025-2026 and AY2026-2027)</div>

    <table>
      <tr>
        <th>Academic Year</th><th>Term</th><th>Start</th><th>End</th><th>Months</th>
      </tr>
      <tr><td rowspan="3">AY2025-2026</td><td>Term 1</td><td>2025-06-10</td><td>2025-08-29</td><td>3</td></tr>
      <tr><td>Term 2</td><td>2025-09-01</td><td>2025-11-28</td><td>3</td></tr>
      <tr><td>Term 3</td><td>2025-12-01</td><td>2026-04-03</td><td>4</td></tr>

      <tr><td rowspan="3">AY2026-2027</td><td>Term 1</td><td>2026-06-16</td><td>2026-09-04</td><td>3</td></tr>
      <tr><td>Term 2</td><td>2026-09-07</td><td>2026-12-18</td><td>3</td></tr>
      <tr><td>Term 3</td><td>2027-01-05</td><td>2027-03-31</td><td>4</td></tr>
    </table>

    <div class="muted" style="margin-top:10px;">2) Month view (accurate colors). Dec 26 is Term 2.</div>

    <div class="monthBlock">
      <div class="ayLabel">AY2025-2026</div>
      <div class="months" id="months2526"></div>

      <div class="ayLabel">AY2026-2027</div>
      <div class="months" id="months2627"></div>
    </div>
  </div>

</div>

<script>
/* ---------------- TERM DATA ---------------- */
const TERMS = {
  "AY2025-2026": [
    { name:"Term 1", start:"2025-06-10", end:"2025-08-29", months:3 },
    { name:"Term 2", start:"2025-09-01", end:"2025-11-28", months:3 },
    { name:"Term 3", start:"2025-12-01", end:"2026-04-03", months:4 }
  ],
  "AY2026-2027": [
    { name:"Term 1", start:"2026-06-16", end:"2026-09-04", months:3 },
    { name:"Term 2", start:"2026-09-07", end:"2026-12-18", months:3 },
    { name:"Term 3", start:"2027-01-05", end:"2027-03-31", months:4 }
  ]
};

/* 10-month AY model months */
const AY_MONTHS = {
  "AY2025-2026": ["2025-06","2025-07","2025-08","2025-09","2025-10","2025-11","2025-12","2026-01","2026-02","2026-03"],
  "AY2026-2027": ["2026-06","2026-07","2026-08","2026-09","2026-10","2026-11","2026-12","2027-01","2027-02","2027-03"]
};

const $ = (id)=>document.getElementById(id);

function parseMoney(str){
  return Number(String(str||"").replace(/,/g,"").trim()) || 0;
}
function formatMoney(n){
  return Number(n||0).toLocaleString("en-US");
}
function dateObj(iso){
  if(!iso) return null;
  const d = new Date(iso + "T00:00:00");
  return isNaN(d.getTime()) ? null : d;
}
function ymKey(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}
function inRange(d, startIso, endIso){
  const s = new Date(startIso + "T00:00:00");
  const e = new Date(endIso + "T00:00:00");
  return d >= s && d <= e;
}

/* Find term by date */
function findTermByDate(d){
  if(!d) return null;
  for(const ay of Object.keys(TERMS)){
    for(const t of TERMS[ay]){
      if(inRange(d, t.start, t.end)){
        return { ay, term: t.name, months: t.months };
      }
    }
  }
  return null;
}

/* Months attend: join month → end of AY months list */
function calcMonthsAttend(joinDate){
  const jt = findTermByDate(joinDate);
  if(!jt) return { ay:null, monthsAttend:0 };

  const months = AY_MONTHS[jt.ay] || [];
  const idx = months.indexOf(ymKey(joinDate));
  if(idx === -1) return { ay:jt.ay, monthsAttend:0 };

  return { ay: jt.ay, monthsAttend: months.length - idx };
}

/* Remaining terms/months AFTER leave term (unused terms) */
function calcUnusedTermsMonths(ay, leaveTermName){
  const list = TERMS[ay] || [];
  const leaveIdx = list.findIndex(t => t.name === leaveTermName);
  const unused = leaveIdx >= 0 ? list.slice(leaveIdx + 1) : [];

  const termsCount = unused.length;
  const monthsCount = unused.reduce((s,t)=>s+(t.months||0),0);

  return { termsCount, monthsCount };
}

/* Auto update join/proration */
function updateJoinAuto(){
  const j = dateObj($("joinDate").value);
  const jt = findTermByDate(j);

  $("joinTermTag").textContent = jt ? `[${jt.ay} - ${jt.term}]` : `[Academic Year - Term]`;

  const base = parseMoney($("baseFee").value);
  const res = calcMonthsAttend(j);

  $("monthsAttendTag").textContent = `[${res.monthsAttend} months]`;

  if(!jt || res.monthsAttend <= 0 || base <= 0){
    $("proratedFee").textContent = "0";
    return;
  }

  const prorated = Math.round((base / 10) * res.monthsAttend);
  $("proratedFee").textContent = formatMoney(prorated);
}

/* Auto update leave term */
function updateLeaveAuto(){
  const l = dateObj($("leaveDate").value);
  const lt = findTermByDate(l);
  $("leaveTermTag").textContent = lt ? `[${lt.ay} - ${lt.term}]` : `[Academic Year - Term]`;
}

/* Formatting on blur */
function formatOnBlurMoneyInput(id){
  const inp = $(id);
  inp.addEventListener("blur", ()=>{
    const n = parseMoney(inp.value);
    inp.value = formatMoney(n);
    updateJoinAuto();
  });
}

/* Build step-by-step FINAL with real values at click time */
function buildFinalSteps({base, monthsAttend, prorate, d1, d2, final}){
  return `FINAL AMOUNT
1) Base = ${formatMoney(base)}
2) Months attend = ${monthsAttend}
3) Prorate = Base ÷ 10 × Months attend = ${formatMoney(prorate)}
4) Discount #1 = ${formatMoney(d1)}
5) Discount #2 = ${formatMoney(d2)}
6) FINAL Tuition Fee after Discount = Prorate + D1 + D2 = ${formatMoney(final)}

Refund only unconsumed term (unused term).`;
}

/* Build step-by-step REFUND with real values at click time */
function buildRefundSteps({final, monthsAttend, monthlyRate, refundableMonths, refund}){
  return `REFUND CALCULATION
1) FINAL Tuition Fee after Discount = ${formatMoney(final)}
2) Total initial prorated months attend = ${monthsAttend}
3) Monthly rate for refund = FINAL Tuition Fee after Discount ÷ initial prorated Months = ${formatMoney(Math.round(monthlyRate))}
4) Refundable amount = Monthly rate for refund × valid refundable months of unused term = ${formatMoney(refund)}`;
}

/* Final calc */
function calcFinal(){
  // always normalize current inputs at click time
  const base = parseMoney($("baseFee").value);
  const monthsAttend = Number(String($("monthsAttendTag").textContent).replace(/[^\d]/g,"")) || 0;

  const prorate = Math.round((base / 10) * monthsAttend);

  const d1 = parseMoney($("disc1").value);
  const d2 = parseMoney($("disc2").value);

  const final = prorate + d1 + d2;

  $("proratedFee").textContent = formatMoney(prorate);
  $("finalFee").textContent = formatMoney(final);

  $("stepsText").textContent = buildFinalSteps({base, monthsAttend, prorate, d1, d2, final});
}

/*
Refund calc:
Refundable amount = (FINAL tuition after discount ÷ total initial prorated months attend) × refundable months of unused term
*/
function calcRefund(){
  const j = dateObj($("joinDate").value);
  const joinTerm = findTermByDate(j);
  const monthsAttend = Number(String($("monthsAttendTag").textContent).replace(/[^\d]/g,"")) || 0;

  const l = dateObj($("leaveDate").value);
  const leaveTerm = findTermByDate(l);

  const final = parseMoney($("finalFee").textContent);

  if(!joinTerm || !leaveTerm || monthsAttend <= 0 || final <= 0){
    $("refundAmount").textContent = "0";
    $("refundMeta").textContent = "[0 terms, 0 months]";
    return;
  }
  if(joinTerm.ay !== leaveTerm.ay){
    $("refundAmount").textContent = "0";
    $("refundMeta").textContent = "[Different AY]";
    return;
  }

  const { termsCount, monthsCount } = calcUnusedTermsMonths(leaveTerm.ay, leaveTerm.term);

  const monthlyRate = final / monthsAttend;
  const refund = Math.round(monthlyRate * monthsCount);

  $("refundAmount").textContent = formatMoney(refund);
  $("refundMeta").textContent = `[${termsCount} terms, ${monthsCount} months]`;

  // steps: FINAL + REFUND (using real values at click time)
  const base = parseMoney($("baseFee").value);
  const d1 = parseMoney($("disc1").value);
  const d2 = parseMoney($("disc2").value);
  const prorate = parseMoney($("proratedFee").textContent);

  const finalText = buildFinalSteps({base, monthsAttend, prorate, d1, d2, final});
  const refundText = buildRefundSteps({final, monthsAttend, monthlyRate, refundableMonths: monthsCount, refund});

  $("stepsText").textContent = finalText + "\n\n" + refundText;
}

/* Month strips (correct) */
function buildMonthStrips(){
  const months2526 = [
    ["Jun 25","t1"],["Jul","t1"],["Aug","t1"],["Sep","t2"],
    ["Oct","t2"],["Nov","t2"],["Dec","t3"],["Jan 26","t3"],
    ["Feb","t3"],["Mar","t3"],["Apr","t3"],["May","off"]
  ];

  const months2627 = [
    ["Jun 26","t1"],["Jul","t1"],["Aug","t1"],["Sep","t2"],
    ["Oct","t2"],["Nov","t2"],["Dec","t2"],["Jan 27","t3"],
    ["Feb","t3"],["Mar","t3"],["Apr","off"],["May","off"]
  ];

  function render(targetId, arr){
    const host = $(targetId);
    host.innerHTML = "";
    arr.forEach(([label, cls])=>{
      const s = document.createElement("span");
      s.className = `m ${cls}`;
      s.textContent = label;
      host.appendChild(s);
    });
  }

  render("months2526", months2526);
  render("months2627", months2627);
}

/* Toggle logic */
function wireToggles(){
  const joinBtn = $("toggleJoinBtn");
  const joinBlock = $("joinBlock");

  joinBtn.addEventListener("click", ()=>{
    const hidden = joinBlock.classList.toggle("hidden");
    joinBtn.textContent = hidden ? "Show Join Date" : "Hide Join Date";
  });

  const leaveBtn = $("toggleLeaveBtn");
  const leaveBlock = $("leaveBlock");

  leaveBtn.addEventListener("click", ()=>{
    const hidden = leaveBlock.classList.toggle("hidden");
    leaveBtn.textContent = hidden ? "Show Leave Date" : "Hide Leave Date";
  });
}

/* Init */
(function init(){
  $("baseFee").value = formatMoney(parseMoney($("baseFee").value));
  $("disc1").value = formatMoney(parseMoney($("disc1").value));
  $("disc2").value = formatMoney(parseMoney($("disc2").value));

  buildMonthStrips();
  wireToggles();

  $("joinDate").addEventListener("change", updateJoinAuto);
  $("leaveDate").addEventListener("change", updateLeaveAuto);

  $("baseFee").addEventListener("input", updateJoinAuto);

  $("calcFinalBtn").addEventListener("click", ()=>{
    $("baseFee").value = formatMoney(parseMoney($("baseFee").value));
    $("disc1").value = formatMoney(parseMoney($("disc1").value));
    $("disc2").value = formatMoney(parseMoney($("disc2").value));
    updateJoinAuto();
    calcFinal();
  });

  $("calcRefundBtn").addEventListener("click", ()=>{
    $("baseFee").value = formatMoney(parseMoney($("baseFee").value));
    updateJoinAuto();
    updateLeaveAuto();
    if(parseMoney($("finalFee").textContent) <= 0) calcFinal();
    calcRefund();
  });

  formatOnBlurMoneyInput("baseFee");
  formatOnBlurMoneyInput("disc1");
  formatOnBlurMoneyInput("disc2");

  updateJoinAuto();
  updateLeaveAuto();
})();
</script>
</body>
</html>
