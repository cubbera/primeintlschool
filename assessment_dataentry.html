<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Assessment Entry</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- SheetJS for Excel import/export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui;
    background: #f5f5f7;
    padding: 20px;
  }

  .title {
    font-size: 22px;
    font-weight: 600;
    margin-bottom: 15px;
  }

  .dropdown-label {
    font-size: 14px;
    font-weight: 600;
  }

  select {
    padding: 4px 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 14px;
  }

  .card {
    background: #ffffff;
    border-radius: 14px;
    padding: 20px;
    border: 1px solid #ddd;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    position: relative;
    margin-top: 15px;
  }

  .top-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }

  .btn-top {
    padding: 6px 12px;
    background: #0071e3;
    color: white;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 13px;
  }

  .btn-top:hover {
    background: #005bbd;
  }

  /* Coursework Box */
  .cw-group {
    border: 1px solid #d0d0d5;
    background: #fafafa;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 14px;
    display: inline-block;
  }

  .cw-title {
    font-weight: 600;
    margin-bottom: 6px;
  }

  .cw-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .btn {
    padding: 5px 12px;
    border-radius: 999px;
    border: 1px solid #ccc;
    background: white;
    cursor: pointer;
    font-size: 12px;
  }

  .btn:hover {
    background: #eaeaea;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    margin-top: 15px;
    font-size: 13px;
    min-width: 1100px;
  }

  th, td {
    border: 1px solid #dcdcdc;
    padding: 6px;
    text-align: center;
  }

  th {
    background: #f2f2f7;
    font-weight: 600;
    white-space: nowrap;
  }

  .label-col {
    text-align: left;
    padding-left: 8px;
    font-weight: 600;
    white-space: nowrap;
  }

  input.score-box {
    width: 60px;
    padding: 4px;
    border-radius: 6px;
    border: 1px solid #cfcfd4;
    text-align: right;
  }

  input.score-box:focus {
    outline: 2px solid #0071e3;
  }

  input.name-box {
    width: 150px;
    padding: 4px;
    border-radius: 6px;
    border: 1px solid #cfcfd4;
  }

  .delete-col-btn {
    font-size: 11px;
    background: none;
    border: none;
    color: red;
    cursor: pointer;
    margin-left: 4px;
  }

  .btn-add-student {
    margin-top: 14px;
    padding: 6px 14px;
    border-radius: 999px;
    background: #0071e3;
    color: #fff;
    border: none;
    cursor: pointer;
    font-size: 13px;
  }

  /* Colors */
  .cw-cell { background: #eaf4ff; }     /* light pastel blue */
  .cw-total-cell { background: #eaf4ff; font-weight: 600; }

  .exam-cell { background: #fff8dc; }   /* light pastel yellow */
  .exam-total-cell { background: #fff8dc; font-weight: 600; }

  .total-cell { background: #eaffea; font-weight: 600; } /* light pastel green */

  .btn-submit {
    margin-top: 20px;
    padding: 10px 20px;
    border-radius: 999px;
    border: none;
    font-size: 14px;
    cursor: pointer;
    background: #28c76f; /* green */
    color: #fff;
  }

  .btn-submit:hover {
    background: #20b764;
  }
</style>
</head>

<body>

<div class="title">Assessment Entry</div>

<!-- Dropdowns -->
<div style="margin-bottom: 15px;">
    <div style="margin-bottom: 15px;">
  <span class="dropdown-label">Academic Year: </span>
  <select id="academicYear">
    <option>2025-2026</option>
  </select>

  &nbsp;&nbsp;&nbsp;

  <span class="dropdown-label">Term: </span>
  <select id="termSelect">
    <option>Term 1</option>
    <option>Term 2</option>
    <option>Term 3</option>
  </select>
</div>

  <span class="dropdown-label">Grade Level: </span>
  <select id="gradeLevel">
    <option>Year 1</option>
    <option>Year 2</option>
    <option>Year 3</option>
  </select>

  &nbsp;&nbsp;&nbsp;

  <span class="dropdown-label">Subject: </span>
  <select id="subjectSelect">
    <option>English</option>
    <option>Mathematics</option>
    <option>Science</option>
    <option>Social Studies</option>
    <option>Myanmar</option>
    <option>Myanmar Social Studies</option>
    <option>Wellbeing</option>
    <option>ICT</option>
    <option>Chinese</option>
  </select>
</div>

<div class="card">

  <div class="top-buttons">
    <button class="btn-top" onclick="importExcel()">Import from Excel</button>
    <button class="btn-top" onclick="exportExcel()">Export to Excel</button>
  </div>

  <div class="cw-group">
    <div class="cw-title">Coursework Weight: 40%</div>
    <div class="cw-buttons">
      <button class="btn" onclick="addUnitTest()">+ Add Unit Test</button>
      <button class="btn" onclick="addProject()">+ Add Project</button>
      <button class="btn" onclick="addPresentation()">+ Add Presentation</button>
    </div>
  </div>

    <!-- ASSESSMENT TABLE -->
  <table id="assessmentTable">
    <thead>
      <!-- ROW 1: MAIN HEADERS -->
      <tr id="headerRow1">
        <th rowspan="2">Nr.</th>
        <th rowspan="2">Student Name</th>

        <!-- Coursework -->
        <th id="cwHeader" colspan="2">Coursework (40%)</th>

        <!-- Exam -->
        <th id="examHeader" colspan="2">Term Exam (60%)</th>

        <!-- Total -->
        <th colspan="2">TOTAL (100%)</th>
      </tr>

      <!-- ROW 2: SUB-COLUMNS -->
      <tr id="headerRow2">
        <!-- Coursework dynamic columns -->
        <th id="cw-ut1" data-role="cw-col">
          Unit Test 1
          <button class="delete-col-btn" onclick="deleteColumn('cw-ut1')">x</button>
        </th>

        <!-- Coursework total -->
        <th data-role="cw-total">Coursework Total</th>

        <!-- Exam score, exam total -->
        <th data-role="exam-score">Exam Score</th>
        <th data-role="exam-total">Exam Total</th>

        <!-- Final totals -->
        <th data-role="original-total">Original</th>
        <th data-role="rounded-total">Rounded</th>
      </tr>
    </thead>

    <!-- ========================= -->
    <!-- 17 STUDENT ROWS BELOW     -->
    <!-- ========================= -->
    <tbody id="tbody">

      <tr>
        <td>1</td>
        <td class="label-col">Ye Yint Tayza Hman</td>

        <td class="cw-cell" data-col="cw-ut1">
          <input class="score-box" type="number" min="0" max="100" step="0.1">
        </td>

        <td class="cw-total-cell">0.00</td>

        <td class="exam-cell exam-score-cell">
          <input class="score-box" type="number" min="0" max="100" value="0" step="0.1">
        </td>
        <td class="exam-total-cell">0.00</td>

        <td class="total-cell final-total-cell">0.00</td>
        <td class="total-cell rounded-total-cell">0</td>
      </tr>

      <tr>
        <td>2</td>
        <td class="label-col">Shoon La Woon Htet</td>

        <td class="cw-cell" data-col="cw-ut1">
          <input class="score-box" type="number" min="0" max="100" step="0.1">
        </td>

        <td class="cw-total-cell">0.00</td>

        <td class="exam-cell exam-score-cell">
          <input class="score-box" type="number" value="0" min="0" max="100" step="0.1">
        </td>
        <td class="exam-total-cell">0.00</td>

        <td class="total-cell final-total-cell">0.00</td>
        <td class="total-cell rounded-total-cell">0</td>
      </tr>

      <tr>
        <td>3</td>
        <td class="label-col">Htun Lae Yi Mon</td>

        <td class="cw-cell" data-col="cw-ut1">
          <input class="score-box" type="number" min="0" max="100" step="0.1">
        </td>

        <td class="cw-total-cell">0.00</td>

        <td class="exam-cell exam-score-cell">
          <input class="score-box" type="number" value="0" min="0" max="100" step="0.1">
        </td>
        <td class="exam-total-cell">0.00</td>

        <td class="total-cell final-total-cell">0.00</td>
        <td class="total-cell rounded-total-cell">0</td>
      </tr>

      <tr>
        <td>4</td>
        <td class="label-col">Lwin Aung Hein</td>

        <td class="cw-cell" data-col="cw-ut1">
          <input class="score-box" type="number" min="0" max="100" step="0.1">
        </td>

        <td class="cw-total-cell">0.00</td>

        <td class="exam-cell exam-score-cell">
          <input class="score-box" type="number" value="0" min="0" max="100" step="0.1">
        </td>
        <td class="exam-total-cell">0.00</td>

        <td class="total-cell final-total-cell">0.00</td>
        <td class="total-cell rounded-total-cell">0</td>
      </tr>

      <tr>
        <td>5</td>
        <td class="label-col">Aung Bhone San</td>

        <td class="cw-cell" data-col="cw-ut1">
          <input class="score-box" type="number" min="0" max="100" step="0.1">
        </td>

        <td class="cw-total-cell">0.00</td>

        <td class="exam-cell exam-score-cell">
          <input class="score-box" type="number" value="0" min="0" max="100" step="0.1">
        </td>
        <td class="exam-total-cell">0.00</td>

        <td class="total-cell final-total-cell">0.00</td>
        <td class="total-cell rounded-total-cell">0</td>
      </tr>

      <tr>
        <td>6</td>
        <td class="label-col">Htet Nay Bhone</td>

        <td class="cw-cell" data-col="cw-ut1">
          <input class="score-box" type="number" min="0" max="100" step="0.1">
        </td>

        <td class="cw-total-cell">0.00</td>

        <td class="exam-cell exam-score-cell">
          <input class="score-box" type="number" value="0" min="0" max="100" step="0.1">
        </td>
        <td class="exam-total-cell">0.00</td>

        <td class="total-cell final-total-cell">0.00</td>
        <td class="total-cell rounded-total-cell">0</td>
      </tr>

      <tr>
        <td>7</td>
        <td class="label-col">Sian Vang Huai Kim</td>

        <td class="cw-cell" data-col="cw-ut1">
          <input class="score-box" type="number" min="0" max="100" step="0.1">
        </td>

        <td class="cw-total-cell">0.00</td>

        <td class="exam-cell exam-score-cell">
          <input class="score-box" type="number" value="0" min="0" max="100" step="0.1">
        </td>
        <td class="exam-total-cell">0.00</td>

        <td class="total-cell final-total-cell">0.00</td>
        <td class="total-cell rounded-total-cell">0</td>
      </tr>

      <tr>
        <td>8</td>
        <td class="label-col">Thu Htet Htoo</td>

        <td class="cw-cell" data-col="cw-ut1">
          <input class="score-box" type="number" min="0" max="100" step="0.1">
        </td>

        <td class="cw-total-cell">0.00</td>

        <td class="exam-cell exam-score-cell">
          <input class="score-box" type="number" value="0" min="0" max="100" step="0.1">
        </td>
        <td class="exam-total-cell">0.00</td>

        <td class="total-cell final-total-cell">0.00</td>
        <td class="total-cell rounded-total-cell">0</td>
      </tr>

      <tr>
        <td>9</td>
        <td class="label-col">Khant Su Thar</td>

        <td class="cw-cell" data-col="cw-ut1">
          <input class="score-box" type="number" min="0" max="100" step="0.1">
        </td>

        <td class="cw-total-cell">0.00</td>

        <td class="exam-cell exam-score-cell">
          <input class="score-box" type="number" value="0" min="0" max="100" step="0.1">
        </td>
        <td class="exam-total-cell">0.00</td>

        <td class="total-cell final-total-cell">0.00</td>
        <td class="total-cell rounded-total-cell">0</td>
      </tr>

      <tr>
        <td>10</td>
        <td class="label-col">Lwin Khit</td>

        <td class="cw-cell" data-col="cw-ut1">
          <input class="score-box" type="number" min="0" max="100" step="0.1">
        </td>

        <td class="cw-total-cell">0.00</td>

        <td class="exam-cell exam-score-cell">
          <input class="score-box" type="number" value="0" min="0" max="100" step="0.1">
        </td>
        <td class="exam-total-cell">0.00</td>

        <td class="total-cell final-total-cell">0.00</td>
        <td class="total-cell rounded-total-cell">0</td>
      </tr>

      <tr>
        <td>11</td>
        <td class="label-col">Htut Myat Aung</td>

        <td class="cw-cell" data-col="cw-ut1">
          <input class="score-box" type="number" min="0" max="100" step="0.1">
        </td>

        <td class="cw-total-cell">0.00</td>

        <td class="exam-cell exam-score-cell">
          <input class="score-box" type="number" value="0" min="0" max="100" step="0.1">
        </td>
        <td class="exam-total-cell">0.00</td>

        <td class="total-cell final-total-cell">0.00</td>
        <td class="total-cell rounded-total-cell">0</td>
      </tr>

      <tr>
        <td>12</td>
        <td class="label-col">Myat Shwe Yee Thin</td>

        <td class="cw-cell" data-col="cw-ut1">
          <input class="score-box" type="number" min="0" max="100" step="0.1">
        </td>

        <td class="cw-total-cell">0.00</td>

        <td class="exam-cell exam-score-cell">
          <input class="score-box" type="number" value="0" min="0" max="100" step="0.1">
        </td>
        <td class="exam-total-cell">0.00</td>

        <td class="total-cell final-total-cell">0.00</td>
        <td class="total-cell rounded-total-cell">0</td>
      </tr>

      <tr>
        <td>13</td>
        <td class="label-col">Kaung Khit Han</td>

        <td class="cw-cell" data-col="cw-ut1">
          <input class="score-box" type="number" min="0" max="100" step="0.1">
        </td>

        <td class="cw-total-cell">0.00</td>

        <td class="exam-cell exam-score-cell">
          <input class="score-box" type="number" value="0" min="0" max="100" step="0.1">
        </td>
        <td class="exam-total-cell">0.00</td>

        <td class="total-cell final-total-cell">0.00</td>
        <td class="total-cell rounded-total-cell">0</td>
      </tr>

      <tr>
        <td>14</td>
        <td class="label-col">Linn Pyae Sone Aung</td>

        <td class="cw-cell" data-col="cw-ut1">
          <input class="score-box" type="number" min="0" max="100" step="0.1">
        </td>

        <td class="cw-total-cell">0.00</td>

        <td class="exam-cell exam-score-cell">
          <input class="score-box" type="number" value="0" min="0" max="100" step="0.1">
        </td>
        <td class="exam-total-cell">0.00</td>

        <td class="total-cell final-total-cell">0.00</td>
        <td class="total-cell rounded-total-cell">0</td>
      </tr>

      <tr>
        <td>15</td>
        <td class="label-col">Sai Noon Wan Han</td>

        <td class="cw-cell" data-col="cw-ut1">
          <input class="score-box" type="number" min="0" max="100" step="0.1">
        </td>

        <td class="cw-total-cell">0.00</td>

        <td class="exam-cell exam-score-cell">
          <input class="score-box" type="number" value="0" min="0" max="100" step="0.1">
        </td>
        <td class="exam-total-cell">0.00</td>

        <td class="total-cell final-total-cell">0.00</td>
        <td class="total-cell rounded-total-cell">0</td>
      </tr>

      <tr>
        <td>16</td>
        <td class="label-col">Ngwe Yati Moe</td>

        <td class="cw-cell" data-col="cw-ut1">
          <input class="score-box" type="number" min="0" max="100" step="0.1">
        </td>

        <td class="cw-total-cell">0.00</td>

        <td class="exam-cell exam-score-cell">
          <input class="score-box" type="number" value="0" min="0" max="100" step="0.1">
        </td>
        <td class="exam-total-cell">0.00</td>

        <td class="total-cell final-total-cell">0.00</td>
        <td class="total-cell rounded-total-cell">0</td>
      </tr>

      <tr>
        <td>17</td>
        <td class="label-col">Khant Htet Zan</td>

        <td class="cw-cell" data-col="cw-ut1">
          <input class="score-box" type="number" min="0" max="100" step="0.1">
        </td>

        <td class="cw-total-cell">0.00</td>

        <td class="exam-cell exam-score-cell">
          <input class="score-box" type="number" value="0" min="0" max="100" step="0.1">
        </td>
        <td class="exam-total-cell">0.00</td>

        <td class="total-cell final-total-cell">0.00</td>
        <td class="total-cell rounded-total-cell">0</td>
      </tr>

    </tbody>
  </table>

  <button class="btn-add-student" onclick="addStudent()">+ Add Student</button>

  <br>

  <button class="btn-submit" onclick="submitScores()">Submit Scores</button>

</div> <!-- end card -->

<script>
  // Track coursework columns by id (e.g., "cw-ut1", "cw-proj1", "cw-pres1")
  let cwColumns = ["cw-ut1"];

  function updateHeaderSpans() {
    const cwHeader = document.getElementById("cwHeader");
    if (cwHeader) {
      // coursework columns + coursework total
      cwHeader.colSpan = cwColumns.length + 1;
    }
    const examHeader = document.getElementById("examHeader");
    if (examHeader) {
      examHeader.colSpan = 2; // exam score + exam total
    }
  }

  function nextIndexForPrefix(prefix) {
    const existing = cwColumns.filter(id => id.startsWith(prefix));
    return existing.length + 1;
  }

  function addUnitTest() {
    const index = nextIndexForPrefix("cw-ut");
    const colId = "cw-ut" + index;
    cwColumns.push(colId);
    addCourseworkColumn(colId, "Unit Test " + index, "cw-ut");
  }

  function addProject() {
    const index = nextIndexForPrefix("cw-proj");
    const colId = "cw-proj" + index;
    cwColumns.push(colId);
    addCourseworkColumn(colId, "Project " + index, "cw-proj");
  }

  function addPresentation() {
    const index = nextIndexForPrefix("cw-pres");
    const colId = "cw-pres" + index;
    cwColumns.push(colId);
    addCourseworkColumn(colId, "Presentation " + index, "cw-pres");
  }

  function addCourseworkColumn(colId, label, prefix) {
    const headerRow2 = document.getElementById("headerRow2");
    if (!headerRow2) return;

    const headerCells = Array.from(headerRow2.children);
    const cwTotalTh = headerRow2.querySelector('th[data-role="cw-total"]');

    // Find last coursework column of the same type (prefix)
    const cwColThs = headerCells.filter(th => th.getAttribute("data-role") === "cw-col");
    let lastSameType = null;
    cwColThs.forEach(th => {
      if (th.id && th.id.startsWith(prefix)) {
        lastSameType = th;
      }
    });

    const newTh = document.createElement("th");
    newTh.id = colId;
    newTh.setAttribute("data-role", "cw-col");
    newTh.innerHTML =
      label +
      " <button class=\"delete-col-btn\" onclick=\"deleteColumn('" +
      colId +
      "')\">x</button>";

    if (lastSameType && lastSameType.nextSibling) {
      headerRow2.insertBefore(newTh, lastSameType.nextSibling);
    } else if (cwTotalTh) {
      headerRow2.insertBefore(newTh, cwTotalTh);
    } else {
      headerRow2.appendChild(newTh);
    }

    // Determine new column index within headerRow2 (0-based)
    const newIndex = Array.from(headerRow2.children).indexOf(newTh);

    // For each student row, insert a td in the correct position
    const tbody = document.getElementById("tbody");
    Array.from(tbody.querySelectorAll("tr")).forEach(row => {
      const td = document.createElement("td");
      td.className = "cw-cell";
      td.setAttribute("data-col", colId);
      td.innerHTML =
        '<input class="score-box" type="number" min="0" max="100" step="0.1">';

      // Row has extra 2 leading cells (Nr, Name)
      const insertPos = newIndex + 2;
      if (insertPos >= row.children.length) {
        row.appendChild(td);
      } else {
        row.insertBefore(td, row.children[insertPos]);
      }
    });

    updateHeaderSpans();
    recalc();
  }

  function deleteColumn(colId) {
    // Remove from cwColumns list
    cwColumns = cwColumns.filter(id => id !== colId);

    // Remove header cell
    const th = document.getElementById(colId);
    if (th && th.parentNode) {
      th.parentNode.removeChild(th);
    }

    // Remove all td for that column
    document
      .querySelectorAll('td[data-col="' + colId + '"]')
      .forEach(td => td.parentNode && td.parentNode.removeChild(td));

    // If somehow no coursework columns left, keep array consistent
    if (cwColumns.length === 0) {
      cwColumns = ["cw-ut1"];
    }

    updateHeaderSpans();
    recalc();
  }

  function addStudent() {
    const tbody = document.getElementById("tbody");
    const rowNumber = tbody.children.length + 1;

    const tr = document.createElement("tr");

    let html = `
      <td>${rowNumber}</td>
      <td class="label-col"><input class="name-box" placeholder="Student Name"></td>
    `;

    // coursework columns (dynamic)
    cwColumns.forEach(colId => {
      html += `
        <td class="cw-cell" data-col="${colId}">
          <input class="score-box" type="number" min="0" max="100" step="0.1">
        </td>
      `;
    });

    // coursework total, exam score, exam total, original total, rounded total
    html += `
      <td class="cw-total-cell">0.00</td>
      <td class="exam-cell exam-score-cell">
        <input class="score-box" type="number" min="0" max="100" step="0.1" value="0">
      </td>
      <td class="exam-total-cell">0.00</td>
      <td class="total-cell final-total-cell">0.00</td>
      <td class="total-cell rounded-total-cell">0</td>
    `;

    tr.innerHTML = html;
    tbody.appendChild(tr);
    recalc();
  }

  function clamp100(value) {
    let v = parseFloat(value);
    if (isNaN(v)) v = 0;
    if (v < 0) v = 0;
    if (v > 100) v = 100;
    return v;
  }

  function recalc() {
    const rows = document.querySelectorAll("#tbody tr");

    rows.forEach(row => {
      let utScores = [];
      let otherScores = [];

      // coursework inputs
      row.querySelectorAll("td[data-col]").forEach(td => {
        const colId = td.getAttribute("data-col");
        const input = td.querySelector("input.score-box");
        if (!input) return;

        const val = clamp100(input.value);
        input.value = input.value === "" ? "" : val; // keep blank if empty

        if (colId.startsWith("cw-ut")) {
          utScores.push(val);
        } else {
          // all non-UT coursework (project, presentation...)
          otherScores.push(val);
        }
      });

      // compute averages
      const utAvg =
        utScores.length > 0
          ? utScores.reduce((a, b) => a + b, 0) / utScores.length
          : 0;
      const otherAvg =
        otherScores.length > 0
          ? otherScores.reduce((a, b) => a + b, 0) / otherScores.length
          : 0;

      let courseworkPercent = 0;

      if (utScores.length > 0 && otherScores.length > 0) {
        // normal case: 25% quizzes + 15% project/presentation
        courseworkPercent =
          (utAvg / 100) * 25 + (otherAvg / 100) * 15;
      } else if (utScores.length > 0 && otherScores.length === 0) {
        // only unit tests ⇒ carry full 40%
        courseworkPercent = (utAvg / 100) * 40;
      } else if (utScores.length === 0 && otherScores.length > 0) {
        // only project/presentation ⇒ carry full 40%
        courseworkPercent = (otherAvg / 100) * 40;
      } else {
        courseworkPercent = 0;
      }

      // Exam
      const examInput = row.querySelector(".exam-score-cell input.score-box");
      let examRaw = 0;
      if (examInput) {
        examRaw = clamp100(examInput.value);
        examInput.value = examInput.value === "" ? "" : examRaw;
      }
      const examPercent = (examRaw / 100) * 60;

      // Totals
      const finalTotal = courseworkPercent + examPercent;
      const roundedTotal = Math.round(finalTotal);

      const cwTotalCell = row.querySelector(".cw-total-cell");
      const examTotalCell = row.querySelector(".exam-total-cell");
      const finalCell = row.querySelector(".final-total-cell");
      const roundedCell = row.querySelector(".rounded-total-cell");

      if (cwTotalCell) cwTotalCell.textContent = courseworkPercent.toFixed(2);
      if (examTotalCell) examTotalCell.textContent = examPercent.toFixed(2);
      if (finalCell) finalCell.textContent = finalTotal.toFixed(2);
      if (roundedCell) roundedCell.textContent = roundedTotal;
    });
  }

  // Simple Excel import: expect sheet with columns:
  // Nr | Student Name | Unit Test 1 | Exam Score
  function importExcel() {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".xlsx,.xls";

    input.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = event => {
        const data = event.target.result;
        const workbook = XLSX.read(data, { type: "binary" });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        populateFromExcel(rows);
      };
      reader.readAsBinaryString(file);
    };

    input.click();
  }

  function populateFromExcel(rows) {
    if (!rows || rows.length < 2) return;
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    // assume first row is header
    rows.slice(1).forEach((row, i) => {
      const nr = row[0] || i + 1;
      const name = row[1] || "";
      const ut1 = row[2] != null ? clamp100(row[2]) : "";
      const exam = row[3] != null ? clamp100(row[3]) : 0;

      const tr = document.createElement("tr");

      let html = `
        <td>${nr}</td>
        <td class="label-col">${name}</td>
        <td class="cw-cell" data-col="cw-ut1">
          <input class="score-box" type="number" min="0" max="100" step="0.1" value="${ut1}">
        </td>
        <td class="cw-total-cell">0.00</td>
        <td class="exam-cell exam-score-cell">
          <input class="score-box" type="number" min="0" max="100" step="0.1" value="${exam}">
        </td>
        <td class="exam-total-cell">0.00</td>
        <td class="total-cell final-total-cell">0.00</td>
        <td class="total-cell rounded-total-cell">0</td>
      `;

      tr.innerHTML = html;
      tbody.appendChild(tr);
    });

    // Reset coursework columns to just cw-ut1 after import
    cwColumns = ["cw-ut1"];
    updateHeaderSpans();
    recalc();
  }

function exportExcel() {
    const academicYear = document.getElementById("academicYear").value;
    const term = document.getElementById("termSelect").value;
    const grade = document.getElementById("gradeLevel").value;
    const subject = document.getElementById("subjectSelect").value;

    const table = document.getElementById("assessmentTable");

    let sheetData = [];

    // ---- METADATA (clean and separate, does NOT break table layout) ----
    sheetData.push(["Academic Year", academicYear]);
    sheetData.push(["Term", term]);
    sheetData.push(["Grade Level", grade]);
    sheetData.push(["Subject", subject]);
    sheetData.push([]); // Empty row BEFORE table

    // ---- EXPORT TABLE EXACTLY AS IT APPEARS ----
    const tableRows = table.querySelectorAll("tr");
    tableRows.forEach(tr => {
        const rowData = [];
        const cells = tr.querySelectorAll("th, td");

        cells.forEach(cell => {
            const input = cell.querySelector("input");
            if (input) {
                rowData.push(input.value);
            } else {
                rowData.push(cell.textContent.trim());
            }
        });

        sheetData.push(rowData);
    });

    // ---- BUILD WORKBOOK ----
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(sheetData);

    // Auto column width
    ws["!cols"] = sheetData[ sheetData.length - 1 ].map(() => ({ wch: 18 }));

    XLSX.utils.book_append_sheet(wb, ws, "Assessment");

    // ---- FILE NAME ----
    const fileName =
        `${grade}_${subject}_${academicYear}_${term}_assessment.xlsx`
            .replace(/\s+/g, '');

    XLSX.writeFile(wb, fileName);
}



  function submitScores() {
    alert("Scores submitted! (Placeholder – connect to backend API later.)");
  }

  // Event delegation: recalc whenever any score-box changes
  document.addEventListener("DOMContentLoaded", () => {
    updateHeaderSpans();
    recalc();

    document.getElementById("tbody").addEventListener("input", e => {
      if (e.target.classList.contains("score-box")) {
        recalc();
      }
    });
  });
</script>

</body>
</html>
