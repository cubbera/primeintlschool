<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Student Enrollment & Tuition Plan</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, system-ui;
    background: #f5f5f7;
    padding: 24px;
  }

  .container {
    max-width: 1100px;
    margin: auto;
    background: #fff;
    padding: 32px;
    border-radius: 14px;
  }

  h2 {
    margin-top: 32px;
    border-bottom: 1px solid #ddd;
    padding-bottom: 6px;
  }

  .row {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-top: 14px;
    flex-wrap: wrap;
  }

  .label {
    min-width: 220px;
    font-weight: 600;
  }

  input,
  select {
    padding: 8px 10px;
    font-size: 14px;
    min-width: 260px;
  }

  .radio-row {
    display: flex;
    gap: 48px;
    margin-top: 14px;
  }

  .money {
    padding: 6px 14px;
    border-radius: 10px;
    background: #f1f5f9;
    font-weight: 800;
    display: inline-block;
    min-width: 140px;
    text-align: right;
  }

  .money.red {
    background: #fff1f2;
    color: #9f1239;
  }

  .student-id {
    padding: 8px 16px;
    border-radius: 999px;
    background: #e0f2fe;
    color: #0369a1;
    font-weight: 800;
    display: inline-block;
  }

  .discount-box {
    margin-top: 16px;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 14px;
    background: #fafafa;
  }

  .discount-box h3 {
    margin: 0 0 10px 0;
    font-size: 14px;
    font-weight: 700;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    background: #fff;
  }

  th,
  td {
    padding: 10px 8px;
    border-bottom: 1px solid #eee;
    vertical-align: middle;
  }

  th {
    background: #f8fafc;
    text-align: left;
  }

  td:last-child,
  th:last-child {
    text-align: right;
  }

  .disc-calc {
    color: #b91c1c;
    font-weight: 800;
    white-space: nowrap;
  }

  .remove {
    cursor: pointer;
    color: #991b1b;
    font-size: 18px;
    margin-left: 8px;
    user-select: none;
  }

  .add-disc {
    margin-top: 10px;
    padding: 8px 14px;
    background: #e5e7eb;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
  }

  .primary-btn {
    margin-top: 30px;
    width: 100%;
    padding: 18px;
    background: #2563eb;
    color: #fff;
    border: none;
    border-radius: 12px;
    font-weight: 800;
    cursor: pointer;
  }

  @media (max-width: 900px) {
    .label {
      min-width: 160px;
    }
    input,
    select {
      min-width: 220px;
    }
  }
</style>
</head>

<body>
<div class="container">

  <h2>1. Enrollment</h2>

  <div class="row">
    <div class="label">Academic Year</div>
    <select id="year">
      <option value="AY25">AY 2025–2026</option>
      <option value="SUM26">Summer 2026</option>
      <option value="AY26">AY 2026–2027</option>
    </select>
  </div>

  <div class="radio-row">
    <label><input type="radio" name="stype" value="new" checked /> New Student</label>
    <label><input type="radio" name="stype" value="current" /> Current Student</label>
  </div>

  <div id="studentBox"></div>

  <div class="row">
    <div class="label">First Attendance Date</div>
    <input type="date" id="attDate" />
  </div>

  <div class="row">
    <div class="label">Grade</div>
    <select id="grade">
      <option>SR Half-day</option>
      <option>SR Full-day</option>
      <option>EY1</option>
      <option>EY2</option>
      <option>Y1</option>
      <option>Y2</option>
      <option>Y3</option>
    </select>
  </div>

  <div class="row">
    <div class="label">Payment Plan</div>
    <select id="plan">
      <option>Annual</option>
      <option>Termly</option>
      <option selected>Monthly</option>
    </select>
  </div>

  <h2>2. Calculating Payment</h2>

  <div class="row">
    <div class="label">Tuition Before Discount</div>
    <span class="money" id="tuition">0</span>
  </div>

  <div class="discount-box">
    <h3>Discounts</h3>

    <table>
      <thead>
        <tr>
          <th style="width:60px;">Disc</th>
          <th style="width:160px;">Type</th>
          <th>Description</th>
          <th style="width:160px;">Amount</th>
          <th style="width:170px;">Calc Amount</th>
        </tr>
      </thead>
      <tbody id="discBody"></tbody>
    </table>

    <button class="add-disc" type="button" onclick="addDiscount()">+ Add Discount</button>
  </div>

  <div class="row">
    <div class="label">Total Discount</div>
    <span class="money red" id="totalDisc">0</span>
  </div>

  <div class="row">
    <div class="label">Amount After Discount</div>
    <span class="money" id="afterDisc">0</span>
  </div>

  <div class="row">
    <div class="label">Monthly Fee (10 installments)</div>
    <span class="money" id="monthlyFee">0</span>
  </div>

  <h2>3. Tuition Payment Plan</h2>

  <table>
    <thead>
      <tr>
        <th style="width:90px;">No</th>
        <th>Due Date</th>
        <th style="width:200px; text-align:right;">Amount</th>
      </tr>
    </thead>
    <tbody id="planBody"></tbody>
  </table>

  <button class="primary-btn" type="button">Add Student & Create Payment Plan</button>

  <p style="margin-top:12px;font-size:13px;color:#555">
    By clicking, we will create new student, payment plan, and then proceed to payment receipt creation.
  </p>

</div>

<script>
  // Pricing base (as previously used)
  const pricing = {
    AY25: { base: 4500000 },
    AY26: { base: 4890000 },
    SUM26: { base: 850000 }
  };

  const yearEl = document.getElementById("year");
  const planEl = document.getElementById("plan");
  const attDateEl = document.getElementById("attDate");

  const tuitionEl = document.getElementById("tuition");
  const totalDiscEl = document.getElementById("totalDisc");
  const afterDiscEl = document.getElementById("afterDisc");
  const monthlyFeeEl = document.getElementById("monthlyFee");

  const discBodyEl = document.getElementById("discBody");
  const planBodyEl = document.getElementById("planBody");
  const studentBoxEl = document.getElementById("studentBox");

  // Default attendance date = today
  attDateEl.value = new Date().toISOString().slice(0, 10);

  function renderStudent() {
    const type = document.querySelector('input[name="stype"]:checked').value;
    const year = yearEl.value;

    studentBoxEl.innerHTML = "";

    if (type === "new") {
      const id = (year === "AY25") ? "PR25142" : "PR26012";
      studentBoxEl.innerHTML = `
        <div class="row">
          <div class="label">Student ID</div>
          <span class="student-id">${id}</span>
        </div>
      `;
    } else {
      studentBoxEl.innerHTML = `
        <div class="row">
          <div class="label">Student Name</div>
          <input type="text" />
        </div>
        <div class="row">
          <div class="label">Student ID</div>
          <input type="text" />
        </div>
      `;
    }
  }

  document.querySelectorAll('input[name="stype"]').forEach(r => {
    r.addEventListener("change", renderStudent);
  });

  yearEl.addEventListener("change", () => {
    renderStudent();
    calc();
  });

  planEl.addEventListener("change", calc);

  let discNo = 0;

  function addDiscount() {
    discNo++;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${discNo}</td>
      <td>
        <select onchange="calc()">
          <option value="fixed">Fixed Amount</option>
          <option value="percent">Percentage</option>
          <option value="free">Free</option>
        </select>
      </td>
      <td>
        <select onchange="calc()">
          <option value="Referral">Referral</option>
          <option value="Sibling Discount">Sibling Discount</option>
          <option value="Early Bird">Early Bird</option>
          <option value="Free 3 Terms">Free 3 Terms</option>
          <option value="Free 2 Terms">Free 2 Terms</option>
          <option value="Free 1 Term">Free 1 Term</option>
          <option value="Free Summer Program">Free Summer Program</option>
        </select>
      </td>
      <td>
        <input type="number" oninput="calc()" />
      </td>
      <td class="disc-calc">
        0
        <span class="remove" onclick="removeDiscount(this)">−</span>
      </td>
    `;

    discBodyEl.appendChild(tr);
    calc();
  }

  function removeDiscount(btn) {
    const tr = btn.closest("tr");
    if (tr) tr.remove();
    calc();
  }

  function formatMoney(n) {
    return Math.round(n).toLocaleString();
  }

  function calc() {
    const yearKey = yearEl.value;
    const base = (pricing[yearKey] ? pricing[yearKey].base : 0);

    tuitionEl.textContent = formatMoney(base);

    // Apply rule: sum all fixed/free first, then percent based on (base - fixedTotal)
    let fixedTotal = 0;
    let percentList = [];

    // First pass: compute fixed/free, gather percents
    Array.from(discBodyEl.querySelectorAll("tr")).forEach(tr => {
      const typeSel = tr.children[1].querySelector("select").value;
      const inputVal = Number(tr.children[3].querySelector("input").value || 0);

      if (typeSel === "fixed" || typeSel === "free") {
        fixedTotal += inputVal;
      } else if (typeSel === "percent") {
        percentList.push({ tr, pct: inputVal });
      }
    });

    const percentBase = Math.max(0, base - fixedTotal);

    // Second pass: set calc amounts per row (using rule above)
    let totalDiscount = 0;

    Array.from(discBodyEl.querySelectorAll("tr")).forEach(tr => {
      const typeSel = tr.children[1].querySelector("select").value;
      const inputEl = tr.children[3].querySelector("input");
      const val = Number(inputEl.value || 0);

      let d = 0;
      if (typeSel === "fixed" || typeSel === "free") {
        d = val;
      } else if (typeSel === "percent") {
        d = percentBase * val / 100;
      }

      totalDiscount += d;

      const calcCell = tr.children[4];
      // Keep remove button
      const removeBtn = calcCell.querySelector(".remove");
      calcCell.textContent = "-" + formatMoney(d) + " ";
      calcCell.appendChild(removeBtn);
    });

    const net = Math.max(0, base - totalDiscount);

    totalDiscEl.textContent = "-" + formatMoney(totalDiscount);
    afterDiscEl.textContent = formatMoney(net);

    const monthly = Math.round(net / 10);
    monthlyFeeEl.textContent = formatMoney(monthly);

    // Payment plan table (10 rows as your existing structure implied)
    planBodyEl.innerHTML = "";
    for (let i = 1; i <= 10; i++) {
      const due = (i === 1) ? "Registration" : ("Month " + i);
      planBodyEl.innerHTML += `
        <tr>
          <td>${i}</td>
          <td>${due}</td>
          <td style="text-align:right;">${formatMoney(monthly)}</td>
        </tr>
      `;
    }
  }

  // Initial render
  renderStudent();
  calc();
</script>

</body>
</html>
