<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Student Enrollment & Tuition Plan</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, system-ui;
    background: #f5f5f7;
    padding: 24px;
  }

  .container {
    max-width: 1100px;
    margin: auto;
    background: #fff;
    padding: 32px;
    border-radius: 14px;
  }

  h2 {
    margin-top: 32px;
    border-bottom: 1px solid #ddd;
    padding-bottom: 6px;
  }

  .row {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-top: 14px;
    flex-wrap: wrap;
  }

  .label {
    min-width: 220px;
    font-weight: 600;
  }

  input,
  select {
    padding: 8px 10px;
    font-size: 14px;
    min-width: 260px;
  }

  .radio-row {
    display: flex;
    gap: 48px;
    margin-top: 14px;
    justify-content: flex-start;
  }

  .money {
    padding: 6px 14px;
    border-radius: 10px;
    background: #f1f5f9;
    font-weight: 800;
    display: inline-block;
    min-width: 160px;
    text-align: right;
  }

  .money.red {
    background: #fff1f2;
    color: #9f1239;
  }

  .student-id {
    padding: 8px 16px;
    border-radius: 999px;
    background: #e0f2fe;
    color: #0369a1;
    font-weight: 800;
    display: inline-block;
  }

  .discount-box {
    margin-top: 16px;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 14px;
    background: #fafafa;
  }

  .discount-box h3 {
    margin: 0 0 10px 0;
    font-size: 14px;
    font-weight: 700;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    background: #fff;
  }

  th,
  td {
    padding: 10px 8px;
    border-bottom: 1px solid #eee;
    vertical-align: middle;
  }

  th {
    background: #f8fafc;
    text-align: left;
  }

  td:last-child,
  th:last-child {
    text-align: right;
  }

  .disc-calc {
    color: #b91c1c;
    font-weight: 800;
    white-space: nowrap;
  }

  .remove {
    cursor: pointer;
    color: #991b1b;
    font-size: 18px;
    margin-left: 8px;
    user-select: none;
  }

  .add-disc {
    margin-top: 10px;
    padding: 8px 14px;
    background: #e5e7eb;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
  }

  .primary-btn {
    margin-top: 30px;
    width: 100%;
    padding: 18px;
    background: #2563eb;
    color: #fff;
    border: none;
    border-radius: 12px;
    font-weight: 800;
    cursor: pointer;
  }

  .small {
    font-size: 12px;
    color: #6b7280;
    margin-top: 8px;
  }

  @media (max-width: 900px) {
    .label { min-width: 160px; }
    input, select { min-width: 220px; }
  }
</style>
</head>

<body>
<div class="container">

  <h2>1. Enrollment</h2>

  <div class="row">
    <div class="label">Academic Year</div>
    <select id="year">
      <option value="AY2025-2026">AY 2025–2026</option>
      <option value="SUMMER2026">Summer 2026</option>
      <option value="AY2026-2027">AY 2026–2027</option>
    </select>
  </div>

  <div class="radio-row">
    <label><input type="radio" name="stype" value="new" checked /> New Student</label>
    <label><input type="radio" name="stype" value="current" /> Current Student</label>
  </div>

  <div id="studentBox"></div>

  <div class="row">
    <div class="label">First Attendance Date</div>
    <input type="date" id="attDate" />
  </div>

  <div class="row">
    <div class="label">Grade</div>
    <select id="grade">
      <option value="SR_HALF">SR Half-day</option>
      <option value="SR_FULL">SR Full-day</option>
      <option value="EY1">EY1</option>
      <option value="EY2">EY2</option>
      <option value="Y1">Y1</option>
      <option value="Y2">Y2</option>
      <option value="Y3">Y3</option>
    </select>
  </div>

  <div class="row">
    <div class="label">Payment Plan</div>
    <select id="plan">
      <option>Annual</option>
      <option>Termly</option>
      <option selected>Monthly</option>
    </select>
  </div>

  <h2>2. Calculating Payment</h2>

  <div class="row">
    <div class="label">Tuition Before Discount</div>
    <span class="money" id="tuition">0</span>
  </div>

  <div class="discount-box">
    <h3>Discounts</h3>

    <table>
      <thead>
        <tr>
          <th style="width:70px;">Disc</th>
          <th style="width:170px;">Type</th>
          <th>Desc</th>
          <th style="width:170px;">Disc Amount</th>
          <th style="width:170px;">Calc Amount</th>
        </tr>
      </thead>
      <tbody id="discBody"></tbody>
    </table>

    <button class="add-disc" type="button" onclick="addDiscount()">+ Add Discount</button>
    <div class="small">Rule: all fixed amounts apply first, then percentage discounts apply on the remaining amount.</div>
  </div>

  <div class="row">
    <div class="label">Total Discount</div>
    <span class="money red" id="totalDisc">0</span>
  </div>

  <div class="row">
    <div class="label">Amount After Discount</div>
    <span class="money" id="afterDisc">0</span>
  </div>

  <div class="row">
    <div class="label">Monthly Fee (10 installments)</div>
    <span class="money" id="monthlyFee">0</span>
  </div>

  <h2>3. Tuition Payment Plan</h2>

  <table>
    <thead>
      <tr>
        <th style="width:90px;">No</th>
        <th>Due Date</th>
        <th style="width:200px; text-align:right;">Amount</th>
      </tr>
    </thead>
    <tbody id="planBody"></tbody>
  </table>

  <button class="primary-btn" type="button">Add Student & Create Payment Plan</button>

  <p style="margin-top:12px;font-size:13px;color:#555">
    By clicking, we will create new student, payment plan, and then proceed to payment receipt creation.
  </p>

</div>

<script>
  // Default attendance date = today
  document.getElementById("attDate").value = new Date().toISOString().slice(0, 10);

  // Student IDs per your rule (not random)
  function getStudentIdByYear(year) {
    if (year === "AY2025-2026") return "PR25142";
    return "PR26012"; // Summer 2026 and AY 2026–2027
  }

  // Pricing from your provided INSERT data
  // AY: annual/termly/monthly by grade + session type for SR
  const AY_PRICING = {
    "AY2025-2026": {
      SR: {
        HALF_DAY: { annual: 2700000, termly: 3000000, monthly: 3000000 },
        FULL_DAY: { annual: 3900000, termly: 4200000, monthly: 4200000 }
      },
      EY1: { annual: 3900000, termly: 4200000, monthly: 4200000 },
      EY2: { annual: 3900000, termly: 4200000, monthly: 4200000 },
      Y1:  { annual: 4200000, termly: 4500000, monthly: 4500000 },
      Y2:  { annual: 4200000, termly: 4500000, monthly: 4500000 },
      Y3:  { annual: 4200000, termly: 4500000, monthly: 4500000 }
    },
    "AY2026-2027": {
      SR: {
        HALF_DAY: { annual: 2890000, termly: 3090000, monthly: 3290000 },
        FULL_DAY: { annual: 4290000, termly: 4490000, monthly: 4890000 }
      },
      EY1: { annual: 4290000, termly: 4490000, monthly: 4890000 },
      EY2: { annual: 4290000, termly: 4490000, monthly: 4890000 },
      Y1:  { annual: 4690000, termly: 4890000, monthly: 5290000 },
      Y2:  { annual: 4690000, termly: 4890000, monthly: 5290000 },
      Y3:  { annual: 4690000, termly: 4890000, monthly: 5290000 }
    }
  };

  // Program tuition pricing
  const PROGRAM_TUITION = {
    "SUMMER2026": 850000
    // (You also provided SUMMER2025=800000 but not in your UI year list)
  };

  // Helpers
  function money(n) {
    return Math.round(n).toLocaleString();
  }

  function getPlanKey() {
    const p = document.getElementById("plan").value;
    if (p === "Annual") return "annual";
    if (p === "Termly") return "termly";
    return "monthly";
  }

  function getSelectedTuition() {
    const year = document.getElementById("year").value;
    const grade = document.getElementById("grade").value;
    const planKey = getPlanKey();

    // Summer program: program tuition
    if (year === "SUMMER2026") {
      return PROGRAM_TUITION["SUMMER2026"] || 0;
    }

    // Academic year pricing
    const yearPricing = AY_PRICING[year];
    if (!yearPricing) return 0;

    if (grade === "SR_HALF") return yearPricing.SR.HALF_DAY[planKey] || 0;
    if (grade === "SR_FULL") return yearPricing.SR.FULL_DAY[planKey] || 0;

    const g = yearPricing[grade];
    if (!g) return 0;

    return g[planKey] || 0;
  }

  // For "Free X Terms", compute using TERMly price of the same AY+grade (regardless of current plan),
  // and for Free Summer Program, use SUMMER2026 program tuition (850,000).
  function getTermlyTuitionForFreeTerms() {
    const year = document.getElementById("year").value;
    const grade = document.getElementById("grade").value;

    // If currently Summer, "Free Terms" doesn't really apply; return 0
    if (year === "SUMMER2026") return 0;

    const yearPricing = AY_PRICING[year];
    if (!yearPricing) return 0;

    if (grade === "SR_HALF") return yearPricing.SR.HALF_DAY.termly || 0;
    if (grade === "SR_FULL") return yearPricing.SR.FULL_DAY.termly || 0;

    const g = yearPricing[grade];
    return g ? (g.termly || 0) : 0;
  }

  function computeFreeDiscount(desc) {
    const termly = getTermlyTuitionForFreeTerms();

    if (desc === "Free 3 Terms") return termly * 3;
    if (desc === "Free 2 Terms") return termly * 2;
    if (desc === "Free 1 Term")  return termly * 1;
    if (desc === "Free Summer Program") return PROGRAM_TUITION["SUMMER2026"] || 0;

    return 0;
  }

  // Student section
  const studentBoxEl = document.getElementById("studentBox");
  function renderStudent() {
    const type = document.querySelector('input[name="stype"]:checked').value;
    const year = document.getElementById("year").value;

    studentBoxEl.innerHTML = "";

    if (type === "new") {
      const id = getStudentIdByYear(year);
      studentBoxEl.innerHTML = `
        <div class="row">
          <div class="label">Student ID</div>
          <span class="student-id">${id}</span>
        </div>
      `;
    } else {
      studentBoxEl.innerHTML = `
        <div class="row">
          <div class="label">Student Name</div>
          <input type="text" id="curName" oninput="syncCurrentStudentFields('name')" />
        </div>
        <div class="row">
          <div class="label">Student ID</div>
          <input type="text" id="curId" oninput="syncCurrentStudentFields('id')" />
        </div>
      `;
    }
  }

  function syncCurrentStudentFields(changed) {
    // "typed any, the other one will appear" — simple behavior:
    // if one has value, leave other visible (already visible); no auto-fill.
    // This function exists mainly to ensure "current student" feels active.
  }

  // Discounts
  const discBodyEl = document.getElementById("discBody");
  let discNo = 0;

  function addDiscount() {
    discNo++;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${discNo}</td>
      <td>
        <select onchange="calc()">
          <option value="fixed">Fixed Amount</option>
          <option value="percent">Percentage</option>
          <option value="free">Free</option>
        </select>
      </td>
      <td>
        <input type="text" placeholder="Type description..." oninput="calc()" />
      </td>
      <td>
        <input type="number" oninput="calc()" />
      </td>
      <td class="disc-calc">
        0 <span class="remove" onclick="removeDiscount(this)">−</span>
      </td>
    `;

    discBodyEl.appendChild(tr);
    sortDiscountRows(); // priority order
    calc();
  }

  function removeDiscount(btn) {
    const tr = btn.closest("tr");
    if (tr) tr.remove();
    calc();
  }

  // Priority: fixed > referral > others (and free is treated like fixed for priority)
  function getRowPriority(tr) {
    const type = tr.children[1].querySelector("select").value;
    const desc = (tr.children[2].querySelector("input").value || "").toLowerCase();

    if (type === "fixed" || type === "free") return 1;
    if (desc.includes("referral")) return 2;
    return 3;
  }

  function renumberRows() {
    const rows = Array.from(discBodyEl.querySelectorAll("tr"));
    rows.forEach((tr, idx) => {
      tr.children[0].textContent = (idx + 1);
    });
  }

  function sortDiscountRows() {
    const rows = Array.from(discBodyEl.querySelectorAll("tr"));
    rows.sort((a, b) => getRowPriority(a) - getRowPriority(b));
    discBodyEl.innerHTML = "";
    rows.forEach(r => discBodyEl.appendChild(r));
    renumberRows();
  }

  // Calculation + payment plan
  const tuitionEl = document.getElementById("tuition");
  const totalDiscEl = document.getElementById("totalDisc");
  const afterDiscEl = document.getElementById("afterDisc");
  const monthlyFeeEl = document.getElementById("monthlyFee");
  const planBodyEl = document.getElementById("planBody");

  function calc() {
    // keep student ID updated
    renderStudent();

    const base = getSelectedTuition();
    tuitionEl.textContent = money(base);

    // Sort discounts by priority whenever content changes
    sortDiscountRows();

    // Apply: all fixed/free first, then percent on remaining
    let fixedTotal = 0;
    let percentRows = [];

    const rows = Array.from(discBodyEl.querySelectorAll("tr"));
    rows.forEach(tr => {
      const type = tr.children[1].querySelector("select").value;
      const desc = tr.children[2].querySelector("input").value || "";
      const amountInput = tr.children[3].querySelector("input");
      const val = Number(amountInput.value || 0);

      // Free: no amount nor calc shown; compute from dropdown-like desc
      if (type === "free") {
        fixedTotal += computeFreeDiscount(desc);
      } else if (type === "fixed") {
        fixedTotal += val;
      } else if (type === "percent") {
        percentRows.push(tr);
      }
    });

    const percentBase = Math.max(0, base - fixedTotal);

    let totalDiscount = 0;

    rows.forEach(tr => {
      const type = tr.children[1].querySelector("select").value;
      const desc = tr.children[2].querySelector("input").value || "";
      const amountInput = tr.children[3].querySelector("input");
      const val = Number(amountInput.value || 0);

      const calcCell = tr.children[4];
      const removeBtn = calcCell.querySelector(".remove");

      // Free behavior: no amount input and no calc amount shown (but discount still applies to totals)
      if (type === "free") {
        amountInput.value = "";
        amountInput.disabled = true;

        // also enforce "Free ..." choices by simple placeholder guidance
        amountInput.placeholder = "";

        const freeDiscount = computeFreeDiscount(desc);
        totalDiscount += freeDiscount;

        calcCell.textContent = ""; // show nothing for free calc
        calcCell.appendChild(removeBtn);
        return;
      } else {
        amountInput.disabled = false;
        amountInput.placeholder = "";
      }

      let d = 0;
      if (type === "fixed") d = val;
      if (type === "percent") d = percentBase * (val / 100);

      totalDiscount += d;

      calcCell.textContent = "-" + money(d) + " ";
      calcCell.appendChild(removeBtn);
    });

    const net = Math.max(0, base - totalDiscount);

    totalDiscEl.textContent = "-" + money(totalDiscount);
    afterDiscEl.textContent = money(net);

    // Monthly Fee display always net/10 as requested previously
    const monthly = Math.round(net / 10);
    monthlyFeeEl.textContent = money(monthly);

    renderPaymentPlan(net);
  }

  function renderPaymentPlan(net) {
    const plan = document.getElementById("plan").value;

    let count = 10;
    if (plan === "Annual") count = 1;
    if (plan === "Termly") count = 3;
    if (plan === "Monthly") count = 10;

    const per = count ? Math.round(net / count) : 0;

    const dueDates = [
      "Registration Date",
      "1 July",
      "1 Aug",
      "1 Sep",
      "1 Oct",
      "1 Nov",
      "1 Dec",
      "1 Jan",
      "1 Feb",
      "1 Mar"
    ];

    planBodyEl.innerHTML = "";

    for (let i = 1; i <= 10; i++) {
      const show = i <= count;
      planBodyEl.innerHTML += `
        <tr>
          <td>${i}</td>
          <td>${dueDates[i - 1] || ("Payment " + i)}</td>
          <td style="text-align:right;">${show ? money(per) : ""}</td>
        </tr>
      `;
    }
  }

  // Events
  document.getElementById("year").addEventListener("change", calc);
  document.getElementById("grade").addEventListener("change", calc);
  document.getElementById("plan").addEventListener("change", calc);
  document.querySelectorAll('input[name="stype"]').forEach(r => r.addEventListener("change", calc));

  // Initialize: one default discount row optional? (leave empty)
  renderStudent();
  calc();

  // Guidance for "Free" entries: user wants dropdown for Free options.
  // To keep your structure intact, accountants type one of:
  // "Free 3 Terms", "Free 2 Terms", "Free 1 Term", "Free Summer Program"
</script>

</body>
</html>
