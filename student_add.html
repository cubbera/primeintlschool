<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Student Enrollment & Tuition Plan</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  :root{
    --bg:#f5f5f7;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --line:#e5e7eb;
    --accent:#0071e3;
    --accent2:#059669;
    --danger:#b91c1c;
    --dangerBg:#fff1f2;
    --pill:#eef2ff;
    --pillText:#3730a3;
    --shadow:0 8px 30px rgba(0,0,0,0.08);
  }
  *{ box-sizing:border-box; }
  body{
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui;
    background:var(--bg);
    color:var(--text);
    margin:0;
    padding:32px 16px;
  }
  .container{
    max-width:980px;
    margin:0 auto;
    background:var(--card);
    border-radius:16px;
    box-shadow:var(--shadow);
    padding:22px;
  }
  h1{
    margin:0 0 14px;
    font-size:22px;
  }
  h2{
    margin:22px 0 10px;
    font-size:16px;
    border-bottom:1px solid var(--line);
    padding-bottom:8px;
  }

  select, input[type="text"], input[type="date"], input[type="number"]{
    width:100%;
    max-width:360px;
    padding:10px 12px;
    font-size:14px;
    border:1px solid #d1d5db;
    border-radius:10px;
    background:#fff;
  }

  .radio-row{
    display:flex;
    gap:24px;
    align-items:center;
    justify-content:flex-start;
  }
  .radio-row label{
    display:flex;
    align-items:center;
    gap:6px;
    font-weight:600;
    margin:0;
  }

  .pill{
    padding:8px 12px;
    border-radius:999px;
    background:var(--pill);
    color:var(--pillText);
    font-weight:800;
    letter-spacing:0.2px;
  }

  .amount-pill{
    padding:8px 12px;
    border-radius:12px;
    background:rgba(5,150,105,0.12);
    color:#065f46;
    font-weight:900;
    display:inline-block;
    white-space:nowrap;
  }
  .amount-pill.red{
    background:var(--dangerBg);
    color:var(--danger);
  }

  .enroll-table{
    margin-top:8px;
    border:1px solid var(--line);
    border-radius:14px;
    overflow:hidden;
    background:#fff;
  }
  .enroll-table table{
    width:100%;
    border-collapse:collapse;
  }
  .enroll-table td{
    padding:10px 12px;
    font-size:13px;
    border-bottom:1px solid var(--line);
    vertical-align:middle;
  }
  .enroll-table tr:last-child td{ border-bottom:none; }

  .cell{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    flex-wrap:wrap;
  }
  .cell .t{
    font-weight:700;
    white-space:nowrap;
  }
  .cell .v{
    flex:1;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:flex-start;
    flex-wrap:wrap;
  }

  /* keep input + button on SAME LINE for current student search */
  .inline-search{
    display:flex;
    gap:10px;
    align-items:center;
    width:100%;
    flex-wrap:nowrap;
  }
  .inline-search input{
    flex:1;
    min-width:220px;
    max-width:none;
  }
  .inline-search button{
    flex:0 0 auto;
    white-space:nowrap;
  }

  .btn-search{
    padding:10px 12px;
    font-size:13px;
    font-weight:700;
    border-radius:10px;
    border:1px solid #d1d5db;
    background:#ffffff;
    cursor:pointer;
  }

  .discount-wrap{
    margin-top:10px;
    border:1px solid var(--line);
    border-radius:14px;
    overflow:hidden;
    background:#fff;
  }
  table{
    width:100%;
    border-collapse:collapse;
  }
  thead th{
    background:#f9fafb;
    font-size:12px;
    padding:10px 12px;
    border-bottom:1px solid var(--line);
    text-align:left;
  }
  tbody td{
    padding:10px 12px;
    font-size:13px;
    border-bottom:1px solid var(--line);
    vertical-align:middle;
  }
  tbody tr:last-child td{ border-bottom:none; }

  .disc-calc{
    color:var(--danger);
    font-weight:900;
    white-space:nowrap;
  }

  .btn-add{
    margin-top:10px;
    padding:10px 12px;
    font-size:13px;
    font-weight:800;
    border-radius:10px;
    border:1px solid #d1d5db;
    background:#fff;
    cursor:pointer;
  }

  .btn-remove{
    border:none;
    background:none;
    color:#b91c1c;
    font-weight:900;
    cursor:pointer;
    font-size:18px;
    line-height:1;
  }

  .totals{
    margin-top:12px;
    display:grid;
    gap:8px;
    font-size:13px;
    font-weight:700;
  }

  .plan{
    margin-top:10px;
    border:1px solid var(--line);
    border-radius:14px;
    overflow:hidden;
    background:#fff;
  }
  .plan th, .plan td{
    padding:10px 12px;
    border-bottom:1px solid var(--line);
    font-size:13px;
  }
  .plan td:last-child{
    text-align:right;
    font-weight:900;
    white-space:nowrap;
  }

  .btn-final{
    margin-top:16px;
    width:100%;
    padding:14px;
    font-size:16px;
    font-weight:900;
    border-radius:14px;
    border:none;
    background:var(--accent2);
    color:#fff;
  }

  /* ===== ONLY FIX REQUESTED: keep Search beside Student Name on same line in CURRENT mode ===== */
  .current-mode #studentNameCell .v{ flex-wrap:nowrap; }
  .current-mode #studentNameCell .inline-search{ width:100%; }
  .current-mode #studentNameCell .inline-search input{ min-width:0; }
</style>
</head>

<body>
<div class="container" id="containerRoot">
  <h1>Student Enrollment & Tuition Plan</h1>

  <h2>1. Enrollment</h2>

  <div class="enroll-table">
    <table>
      <tbody>

        <tr>
          <td width="50%">
            <div class="cell">
              <div class="t">Academic Year</div>
              <div class="v">
                <select id="academicYear">
                  <option value="AY2025-2026" selected>AY2025–2026</option>
                  <option value="SUMMER2026">Summer 2026</option>
                  <option value="AY2026-2027">AY2026–2027</option>
                </select>
              </div>
            </div>
          </td>
          <td width="50%">
            <div class="cell">
              <div class="t">Grade</div>
              <div class="v">
                <select id="grade">
                  <option>SR Half-day</option>
                  <option>SR Full-day</option>
                  <option>EY1</option>
                  <option>EY2</option>
                  <option>Y1</option>
                  <option>Y2</option>
                  <option>Y3</option>
                </select>
              </div>
            </div>
          </td>
        </tr>

        <tr>
          <td>
            <div class="cell">
              <div class="t">Student Type</div>
              <div class="v radio-row">
                <label><input type="radio" name="studentType" value="new" checked> New</label>
                <label><input type="radio" name="studentType" value="current"> Current</label>
              </div>
            </div>
          </td>
          <td>
            <div class="cell">
              <div class="t">Father’s Name</div>
              <div class="v" id="fatherCell">
                <input type="text" id="fatherName">
              </div>
            </div>
          </td>
        </tr>

        <tr>
          <td>
            <div class="cell">
              <div class="t">Student ID</div>
              <div class="v" id="studentIdCell">
                <span class="pill" id="studentId">PR25142</span>
              </div>
            </div>
          </td>
          <td>
            <div class="cell">
              <div class="t">Student Name</div>
              <div class="v" id="studentNameCell">
                <input type="text" id="studentName">
              </div>
            </div>
          </td>
        </tr>

        <tr>
          <td>
            <div class="cell">
              <div class="t">Payment Plan</div>
              <div class="v">
                <select id="paymentPlan">
                  <option>Annual</option>
                  <option>Termly</option>
                  <option selected>Monthly</option>
                </select>
              </div>
            </div>
          </td>
          <td>
            <div class="cell">
              <div class="t">First Attendance Date</div>
              <div class="v">
                <input type="date" id="firstAttendance">
              </div>
            </div>
          </td>
        </tr>

      </tbody>
    </table>
  </div>

  <h2>2. Calculating Payment</h2>

  <div class="cell">
    <div class="t">Tuition Before Discount</div>
    <div class="v">
      <span class="amount-pill" id="tuitionBefore">0 Ks</span>
    </div>
  </div>

  <div class="discount-wrap">
    <table>
      <thead>
        <tr>
          <th>Disc No</th>
          <th>Type</th>
          <th>Description</th>
          <th>Amount</th>
          <th>Calc</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="discBody"></tbody>
    </table>
  </div>

  <button class="btn-add" type="button" onclick="addDiscount()">+ Add Discount</button>

  <div class="totals">
    <div>Total Discount <span class="amount-pill red" id="totalDiscount">0 Ks</span></div>
    <div>Amount After Discount <span class="amount-pill" id="afterDiscount">0 Ks</span></div>
    <div>Payment Plan <span class="amount-pill" id="paymentFee">0 Ks</span></div>
  </div>

  <h2>3. Tuition Payment Plan</h2>

  <div class="plan">
    <table>
      <thead>
        <tr><th>No</th><th>Due Date</th><th>Amount</th></tr>
      </thead>
      <tbody id="planBody"></tbody>
    </table>
  </div>

  <button class="btn-final" type="button">Add Student &amp; Create Payment Plan</button>
</div>

<script>
  const academicYearEl = document.getElementById("academicYear");
  const paymentPlanEl = document.getElementById("paymentPlan");
  const firstAttendanceEl = document.getElementById("firstAttendance");

  const studentTypeRadios = document.querySelectorAll('input[name="studentType"]');
  const studentIdCell = document.getElementById("studentIdCell");
  const studentNameCell = document.getElementById("studentNameCell");
  const fatherCell = document.getElementById("fatherCell");
  const containerRoot = document.getElementById("containerRoot");

  const tuitionBeforeEl = document.getElementById("tuitionBefore");
  const discBody = document.getElementById("discBody");
  const totalDiscountEl = document.getElementById("totalDiscount");
  const afterDiscountEl = document.getElementById("afterDiscount");
  const paymentFeeEl = document.getElementById("paymentFee");
  const planBody = document.getElementById("planBody");

  // defaults
  firstAttendanceEl.valueAsDate = new Date();

  function newStudentIdForYear(){
    const y = academicYearEl.value;
    return (y === "AY2025-2026") ? "PR25142" : "PR26012";
  }

  /* ===== ONLY ADDITION REQUESTED: "Current" search returns Father's Name text result ===== */
  const CURRENT_STUDENT_DIRECTORY = [
    { id:"PR23004", name:"Aye Chan", father:"U Kyaw Min" },
    { id:"PR23005", name:"Hnin Pwint", father:"U Zaw Lin" },
    { id:"PR23006", name:"Min Khant", father:"U Myint Oo" },
    { id:"PR23009", name:"Thiri Tun", father:"U Nay Win" },
    { id:"PR23010", name:"Zin Myo", father:"U Soe Thet" },
    { id:"PR24046", name:"Pyae Phyo", father:"U Aung Zeya" },
    { id:"PR24050", name:"Su Mon", father:"U Hla Myo" },
    { id:"PR24051", name:"Khine Thazin", father:"U Khin Maung" },
    { id:"PR25010", name:"Ye Lin", father:"U Tun Tun" },
    { id:"PR2523",  name:"Moe Set", father:"U Aung Naing" }
  ];

  function attachCurrentSearch(){
    const btn = document.getElementById("currentSearchBtn");
    if (!btn) return;

    btn.addEventListener("click", () => {
      const idEl = document.getElementById("studentIdSearch");
      const nameEl = document.getElementById("studentNameSearch");
      const fatherEl = document.getElementById("fatherDisplay");

      const idQ = (idEl && idEl.value ? idEl.value.trim() : "");
      const nameQ = (nameEl && nameEl.value ? nameEl.value.trim() : "");

      let found = null;

      if (idQ) {
        found = CURRENT_STUDENT_DIRECTORY.find(s => s.id.toLowerCase() === idQ.toLowerCase());
      }
      if (!found && nameQ) {
        found = CURRENT_STUDENT_DIRECTORY.find(s => s.name.toLowerCase() === nameQ.toLowerCase());
      }

      if (found) {
        if (idEl) idEl.value = found.id;
        if (nameEl) nameEl.value = found.name;
        if (fatherEl) fatherEl.textContent = found.father;
      } else {
        if (fatherEl) fatherEl.textContent = "Not found";
      }
    });
  }

  function renderStudentType(){
    const type = document.querySelector('input[name="studentType"]:checked').value;

    if (type === "current") {
      containerRoot.classList.add("current-mode");

      // Student ID becomes editable (search)
      studentIdCell.innerHTML = '<input type="text" id="studentIdSearch" placeholder="Student ID">';

      // Student Name input + Search button SAME LINE
      studentNameCell.innerHTML = `
        <div class="inline-search">
          <input type="text" id="studentNameSearch" placeholder="Student Name">
          <button class="btn-search" id="currentSearchBtn" type="button">Search</button>
        </div>
      `;

      // Father name is text result based on search
      fatherCell.innerHTML = '<span class="pill" id="fatherDisplay">—</span>';

      attachCurrentSearch();
    } else {
      containerRoot.classList.remove("current-mode");

      // New student
      studentIdCell.innerHTML = '<span class="pill" id="studentId"></span>';
      document.getElementById("studentId").textContent = newStudentIdForYear();

      studentNameCell.innerHTML = '<input type="text" id="studentName" placeholder="Student Name">';
      fatherCell.innerHTML = '<input type="text" id="fatherName" placeholder="Father’s Name">';
    }
  }

  studentTypeRadios.forEach(r => r.addEventListener("change", renderStudentType));
  academicYearEl.addEventListener("change", () => {
    if (document.querySelector('input[name="studentType"]:checked').value === "new") {
      const pill = document.getElementById("studentId");
      if (pill) pill.textContent = newStudentIdForYear();
    }
    recalc();
  });

  function renumberDiscounts(){
    [...discBody.querySelectorAll("tr")].forEach((tr, i) => {
      tr.querySelector("[data-discno]").textContent = (i + 1);
    });
  }

  function addDiscount(){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td data-discno>1</td>
      <td>
        <select class="disc-type" onchange="recalc()">
          <option value="fixed">Fixed Amount</option>
          <option value="percent">Percentage</option>
          <option value="free">Free</option>
        </select>
      </td>
      <td><input class="disc-desc" type="text" placeholder="Description" oninput="recalc()"></td>
      <td><input class="disc-amt" type="number" placeholder="Amount" oninput="recalc()"></td>
      <td class="disc-calc">0</td>
      <td><button class="btn-remove" type="button" onclick="removeDiscount(this)">−</button></td>
    `;
    discBody.appendChild(tr);
    renumberDiscounts();
    recalc();
  }

  function removeDiscount(btn){
    btn.closest("tr").remove();
    renumberDiscounts();
    recalc();
  }

  window.addDiscount = addDiscount;
  window.removeDiscount = removeDiscount;

  // pricing (based on your inserts)
  function getTuitionBefore(){
    const year = academicYearEl.value;
    const grade = document.getElementById("grade").value;
    const plan = paymentPlanEl.value;

    // AY2025–2026
    if (year === "AY2025-2026") {
      if (grade === "SR Half-day") return plan === "Annual" ? 2700000 : 3000000;
      if (grade === "SR Full-day") return plan === "Annual" ? 3900000 : 4200000;
      if (grade === "EY1" || grade === "EY2") return plan === "Annual" ? 3900000 : 4200000;
      if (grade === "Y1" || grade === "Y2" || grade === "Y3") return plan === "Annual" ? 4200000 : 4500000;
    }

    // SUMMER2026: one time
    if (year === "SUMMER2026") return 850000;

    // AY2026–2027
    if (year === "AY2026-2027") {
      if (grade === "SR Half-day") return plan === "Annual" ? 2890000 : (plan === "Termly" ? 3090000 : 3290000);
      if (grade === "SR Full-day") return plan === "Annual" ? 4290000 : (plan === "Termly" ? 4490000 : 4890000);
      if (grade === "EY1" || grade === "EY2") return plan === "Annual" ? 4290000 : (plan === "Termly" ? 4490000 : 4890000);
      if (grade === "Y1" || grade === "Y2" || grade === "Y3") return plan === "Annual" ? 4690000 : (plan === "Termly" ? 4890000 : 5290000);
    }

    return 0;
  }

  // annual reference for "free terms" math (use annual amount / 10 months)
  function getAnnualReferenceAmount(){
    const year = academicYearEl.value;
    const grade = document.getElementById("grade").value;

    if (year === "SUMMER2026") return 0;

    // use annual value regardless of selected plan
    if (year === "AY2025-2026") {
      if (grade === "SR Half-day") return 2700000;
      if (grade === "SR Full-day") return 3900000;
      if (grade === "EY1" || grade === "EY2") return 3900000;
      if (grade === "Y1" || grade === "Y2" || grade === "Y3") return 4200000;
    }

    if (year === "AY2026-2027") {
      if (grade === "SR Half-day") return 2890000;
      if (grade === "SR Full-day") return 4290000;
      if (grade === "EY1" || grade === "EY2") return 4290000;
      if (grade === "Y1" || grade === "Y2" || grade === "Y3") return 4690000;
    }

    return 0;
  }

  function fmtKs(n){
    const v = Math.max(0, Math.round(n));
    return v.toLocaleString() + " Ks";
  }

  function ensureFreeDescControl(tr){
    const descCell = tr.children[2];
    const existing = descCell.querySelector(".free-desc");
    const type = tr.querySelector(".disc-type").value;

    if (type !== "free") {
      // if it was free before, restore input
      if (existing) {
        descCell.innerHTML = `<input class="disc-desc" type="text" placeholder="Description" oninput="recalc()">`;
      }
      return;
    }

    if (!existing) {
      descCell.innerHTML = `
        <select class="free-desc" onchange="recalc()">
          <option value="FREE_3">Free 3 Terms</option>
          <option value="FREE_2">Free 2 Terms</option>
          <option value="FREE_1">Free 1 Term</option>
        </select>
      `;
    }
  }

  function computeFreeDiscount(tr){
    const year = academicYearEl.value;
    if (year === "SUMMER2026") return 0;

    const annual = getAnnualReferenceAmount();
    if (!annual) return 0;

    // AY2026-2027 rough: term1=3 months, term2=3 months, term3=4 months => 10 months total
    // Free 3 terms => annual (10/10)
    // Free 2 terms => 6 months => annual/10 * 6
    // Free 1 term  => 3 months => annual/10 * 3
    const sel = tr.querySelector(".free-desc") ? tr.querySelector(".free-desc").value : "FREE_1";
    const perMonth = annual / 10;

    if (sel === "FREE_3") return Math.round(perMonth * 10);
    if (sel === "FREE_2") return Math.round(perMonth * 6);
    return Math.round(perMonth * 3);
  }

  function recalc(){
    const tuitionBefore = getTuitionBefore();
    tuitionBeforeEl.textContent = fmtKs(tuitionBefore);

    const rows = [...discBody.querySelectorAll("tr")];

    // normalize UI (free desc dropdown, amount disabled, etc.)
    rows.forEach(tr => {
      ensureFreeDescControl(tr);

      const type = tr.querySelector(".disc-type").value;
      const amtEl = tr.querySelector(".disc-amt");
      const calcEl = tr.querySelector(".disc-calc");

      if (type === "free") {
        amtEl.value = "";
        amtEl.disabled = true;
        const freeDisc = computeFreeDiscount(tr);
        calcEl.textContent = freeDisc > 0 ? ("-" + fmtKs(freeDisc)) : "0";
      } else {
        amtEl.disabled = false;
        // calc filled below
        if (calcEl.textContent === "—") calcEl.textContent = "0";
      }
    });

    // discount rules: sum fixed (including free) first, then percent on remaining
    let fixedTotal = 0;
    let percentSum = 0;

    rows.forEach(tr => {
      const type = tr.querySelector(".disc-type").value;
      if (type === "free") {
        fixedTotal += computeFreeDiscount(tr);
        return;
      }
      const amt = Number(tr.querySelector(".disc-amt").value || 0);
      if (type === "fixed") fixedTotal += amt;
      if (type === "percent") percentSum += amt;
    });

    let subtotal = tuitionBefore - fixedTotal;
    if (subtotal < 0) subtotal = 0;

    const percentDiscount = percentSum > 0 ? Math.floor(subtotal * (percentSum / 100)) : 0;

    const totalDiscount = fixedTotal + percentDiscount;
    const afterDiscount = Math.max(0, tuitionBefore - totalDiscount);

    // Update calc per row
    rows.forEach(tr => {
      const type = tr.querySelector(".disc-type").value;
      const calcEl = tr.querySelector(".disc-calc");

      if (type === "free") return;

      const amt = Number(tr.querySelector(".disc-amt").value || 0);
      let calc = 0;

      if (type === "fixed") {
        calc = amt;
      } else if (type === "percent") {
        // distribute percentDiscount proportional to percentages if multiple rows
        const pctSum = rows
          .filter(r => r.querySelector(".disc-type").value === "percent")
          .reduce((s, r) => s + Number(r.querySelector(".disc-amt").value || 0), 0);

        if (pctSum > 0) {
          const pct = Number(tr.querySelector(".disc-amt").value || 0);
          calc = Math.floor(percentDiscount * (pct / pctSum));
        } else {
          calc = 0;
        }
      }

      calcEl.textContent = calc > 0 ? ("-" + fmtKs(calc)) : "0";
    });

    totalDiscountEl.textContent = totalDiscount > 0 ? ("-" + fmtKs(totalDiscount)) : "0 Ks";
    afterDiscountEl.textContent = fmtKs(afterDiscount);

    renderPaymentPlan(afterDiscount);
  }

  function renderPaymentPlan(afterDiscount){
    const plan = paymentPlanEl.value;
    const year = academicYearEl.value;

    planBody.innerHTML = "";

    // Summer 2026: one-time payment only
    if (year === "SUMMER2026") {
      const amt = afterDiscount;
      paymentFeeEl.textContent = fmtKs(amt);
      planBody.innerHTML = `<tr><td>1</td><td>Registration Date</td><td>${fmtKs(amt)}</td></tr>`;
      return;
    }

    if (plan === "Annual") {
      const amt = afterDiscount;
      paymentFeeEl.textContent = fmtKs(amt);
      planBody.innerHTML = `<tr><td>1</td><td>Registration Date</td><td>${fmtKs(amt)}</td></tr>`;
      return;
    }

    if (plan === "Monthly") {
      const per = Math.round(afterDiscount / 10);
      paymentFeeEl.textContent = fmtKs(per);

      const due = [
        "Registration Date",
        "1 July",
        "1 Aug",
        "1 Sep",
        "1 Oct",
        "1 Nov",
        "1 Dec",
        "1 Jan",
        "1 Feb",
        "1 Mar"
      ];

      due.forEach((d, i) => {
        planBody.innerHTML += `<tr><td>${i+1}</td><td>${d}</td><td>${fmtKs(per)}</td></tr>`;
      });
      return;
    }

    // Termly: Registration, before term 2, before term 3
    if (plan === "Termly") {
      const per = Math.round(afterDiscount / 3);
      paymentFeeEl.textContent = fmtKs(per);

      const termStart = {
        "AY2025-2026": { t2:"2025-09-01", t3:"2025-12-01" },
        "AY2026-2027": { t2:"2026-09-01", t3:"2026-12-01" }
      };
      const starts = termStart[year] || null;

      const before = (iso) => {
        const d = new Date(iso + "T00:00:00");
        d.setDate(d.getDate() - 1);
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,"0");
        const day = String(d.getDate()).padStart(2,"0");
        return `${y}-${m}-${day}`;
      };

      const due2 = starts ? before(starts.t2) : "Before Term 2";
      const due3 = starts ? before(starts.t3) : "Before Term 3";

      planBody.innerHTML = `
        <tr><td>1</td><td>Registration Date</td><td>${fmtKs(per)}</td></tr>
        <tr><td>2</td><td>${due2}</td><td>${fmtKs(per)}</td></tr>
        <tr><td>3</td><td>${due3}</td><td>${fmtKs(per)}</td></tr>
      `;
      return;
    }

    paymentFeeEl.textContent = "0 Ks";
  }

  document.getElementById("grade").addEventListener("change", recalc);
  paymentPlanEl.addEventListener("change", recalc);

  // init
  renderStudentType();
  recalc();
</script>