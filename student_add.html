<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Student Enrollment & Tuition Plan System</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  /* =========================================
     CSS VARIABLES & RESET
     ========================================= */
  :root{
    --bg: #f5f5f7;
    --card: #ffffff;
    --text: #111827;
    --muted: #6b7280;
    --line: #e5e7eb;
    --accent: #0071e3;
    --accent-hover: #0077ed;
    --accent2: #059669;
    --accent2-hover: #047857;
    --danger: #b91c1c;
    --dangerBg: #fff1f2;
    --pill: #eef2ff;
    --pillText: #3730a3;
    --shadow: 0 8px 30px rgba(0,0,0,0.08);
    --input-border: #d1d5db;
    --focus-ring: rgba(0, 113, 227, 0.3);
  }

  * { 
    box-sizing: border-box; 
    outline: none;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    margin: 0;
    padding: 40px 20px;
    line-height: 1.5;
  }

  /* =========================================
     LAYOUT CONTAINERS
     ========================================= */
  .container {
    max-width: 1000px;
    margin: 0 auto;
    background: var(--card);
    border-radius: 18px;
    box-shadow: var(--shadow);
    padding: 30px;
  }

  /* =========================================
     TYPOGRAPHY
     ========================================= */
  h1 {
    margin: 0 0 20px;
    font-size: 24px;
    font-weight: 800;
    letter-spacing: -0.5px;
    color: var(--text);
  }

  h2 {
    margin: 30px 0 15px;
    font-size: 17px;
    font-weight: 700;
    border-bottom: 2px solid var(--line);
    padding-bottom: 10px;
    color: var(--text);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* =========================================
     FORM ELEMENTS
     ========================================= */
  select, 
  input[type="text"], 
  input[type="date"], 
  input[type="number"] {
    width: 100%;
    max-width: 400px;
    padding: 12px 14px;
    font-size: 14px;
    border: 1px solid var(--input-border);
    border-radius: 10px;
    background: #fff;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  select:focus, 
  input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--focus-ring);
  }

  input[disabled] {
    background-color: #f3f4f6;
    color: #9ca3af;
    cursor: not-allowed;
  }

  /* =========================================
     RADIO BUTTONS ROW
     ========================================= */
  .radio-row {
    display: flex;
    gap: 20px;
    align-items: center;
    justify-content: flex-start;
  }

  .radio-row label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    padding: 6px 10px;
    border-radius: 8px;
    transition: background 0.1s;
  }
  
  .radio-row label:hover {
    background: #f9fafb;
  }

  /* =========================================
     PILLS & BADGES
     ========================================= */
  .pill {
    padding: 8px 16px;
    border-radius: 999px;
    background: var(--pill);
    color: var(--pillText);
    font-weight: 700;
    letter-spacing: 0.3px;
    font-size: 13px;
  }

  .amount-pill {
    padding: 10px 16px;
    border-radius: 12px;
    background: rgba(5,150,105,0.12);
    color: #065f46;
    font-weight: 900;
    font-size: 15px;
    display: inline-block;
    white-space: nowrap;
    min-width: 100px;
    text-align: right;
  }

  .amount-pill.red {
    background: var(--dangerBg);
    color: var(--danger);
  }

  /* =========================================
     TABLES (Enrollment, Discount, Plan)
     ========================================= */
  .enroll-table, 
  .discount-wrap, 
  .plan {
    margin-top: 15px;
    border: 1px solid var(--line);
    border-radius: 14px;
    overflow: hidden;
    background: #fff;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  /* Header styles */
  thead th {
    background: #f9fafb;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    color: var(--muted);
    padding: 12px 16px;
    border-bottom: 1px solid var(--line);
    text-align: left;
  }

  /* Body styles */
  tbody td {
    padding: 14px 16px;
    font-size: 14px;
    border-bottom: 1px solid var(--line);
    vertical-align: middle;
  }

  tbody tr:last-child td {
    border-bottom: none;
  }

  /* Zebra striping for plan table usually looks nice */
  .plan tbody tr:nth-child(even) {
    background-color: #fbfbfb;
  }

  /* Right align amount columns */
  .plan td:last-child {
    text-align: right;
    font-weight: 700;
    font-family: "SF Mono", "Monaco", "Courier New", monospace;
  }

  /* =========================================
     CELL UTILITIES (Flexbox for Label : Input)
     ========================================= */
  .cell {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
  }

  .cell .t {
    font-weight: 600;
    white-space: nowrap;
    color: #374151;
    min-width: 120px;
  }

  .cell .v {
    flex: 1;
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: flex-start;
  }

  /* =========================================
     SEARCH COMPONENT (For Current Students)
     ========================================= */
  .inline-search {
    display: flex;
    gap: 10px;
    align-items: center;
    width: 100%;
    flex-wrap: nowrap;
  }

  .inline-search input {
    flex: 1;
    min-width: 150px;
  }

  .btn-search {
    padding: 12px 18px;
    font-size: 13px;
    font-weight: 700;
    border-radius: 10px;
    border: 1px solid var(--input-border);
    background: #fff;
    color: var(--text);
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-search:hover {
    background: #f3f4f6;
    border-color: #9ca3af;
  }

  /* State: Hide/Show logic for Current Mode */
  .current-mode #studentNameCell .v {
    flex-wrap: nowrap;
  }
  
  .current-mode #studentNameCell .inline-search {
    width: 100%;
  }

  /* =========================================
     BUTTONS (Add, Remove, Final)
     ========================================= */
  .btn-add {
    margin-top: 12px;
    padding: 10px 16px;
    font-size: 13px;
    font-weight: 700;
    border-radius: 10px;
    border: 1px dashed var(--input-border);
    background: #fff;
    color: var(--accent);
    cursor: pointer;
    width: 100%;
    text-align: center;
    transition: all 0.2s;
  }

  .btn-add:hover {
    border-color: var(--accent);
    background: #f0f9ff;
  }

  .btn-remove {
    border: none;
    background: rgba(185, 28, 28, 0.1);
    color: var(--danger);
    font-weight: 900;
    cursor: pointer;
    font-size: 16px;
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }

  .btn-remove:hover {
    background: rgba(185, 28, 28, 0.2);
  }

  .btn-final {
    margin-top: 24px;
    width: 100%;
    padding: 18px;
    font-size: 16px;
    font-weight: 800;
    border-radius: 14px;
    border: none;
    background: var(--accent2);
    color: #fff;
    cursor: pointer;
    box-shadow: 0 4px 6px -1px rgba(5, 150, 105, 0.2);
    transition: transform 0.1s, background 0.2s;
  }

  .btn-final:hover {
    background: var(--accent2-hover);
  }

  .btn-final:active {
    transform: scale(0.99);
  }

  /* =========================================
     SUMMARY & TOTALS SECTION
     ========================================= */
  .totals {
    margin-top: 20px;
    padding: 20px;
    background: #f9fafb;
    border-radius: 14px;
    display: grid;
    gap: 12px;
    font-size: 14px;
    font-weight: 700;
  }

  .totals div {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .disc-calc {
    color: var(--danger);
    font-weight: 700;
    font-family: "SF Mono", monospace;
  }

  /* =========================================
     RESPONSIVE
     ========================================= */
  @media (max-width: 768px) {
    .enroll-table td {
      display: block;
      width: 100% !important;
    }
    .cell {
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
    }
    .cell .v {
      width: 100%;
    }
    select, input {
      max-width: 100%;
    }
  }
</style>
</head>

<body>

<div class="container" id="containerRoot">
  <h1>Student Enrollment & Tuition Plan System</h1>

  <h2>1. Enrollment Details</h2>

  <div class="enroll-table">
    <table>
      <tbody>
        <tr>
          <td width="50%">
            <div class="cell">
              <div class="t">Academic Year</div>
              <div class="v">
                <select id="academicYear">
                  <option value="AY2025-2026" selected>AY2025–2026</option>
                  <option value="SUMMER2026">Summer 2026</option>
                  <option value="AY2026-2027">AY2026–2027</option>
                </select>
              </div>
            </div>
          </td>
          <td width="50%">
            <div class="cell">
              <div class="t">Grade Level</div>
              <div class="v">
                <select id="grade">
                  <option value="SR Half-day">SR Half-day</option>
                  <option value="SR Full-day">SR Full-day</option>
                  <option value="EY1">EY1</option>
                  <option value="EY2">EY2</option>
                  <option value="Y1">Y1</option>
                  <option value="Y2">Y2</option>
                  <option value="Y3">Y3</option>
                </select>
              </div>
            </div>
          </td>
        </tr>

        <tr>
          <td>
            <div class="cell">
              <div class="t">Student Type</div>
              <div class="v radio-row">
                <label>
                  <input type="radio" name="studentType" value="new" checked> 
                  New
                </label>
                <label>
                  <input type="radio" name="studentType" value="returning"> 
                  Returning
                </label>
                <label>
                  <input type="radio" name="studentType" value="current"> 
                  Current
                </label>
              </div>
            </div>
          </td>
          <td>
            <div class="cell">
              <div class="t">Father’s Name</div>
              <div class="v" id="fatherCell">
                <input type="text" id="fatherName" placeholder="Enter name">
              </div>
            </div>
          </td>
        </tr>

        <tr>
          <td>
            <div class="cell">
              <div class="t">Student ID</div>
              <div class="v" id="studentIdCell">
                <span class="pill" id="studentId">---</span>
              </div>
            </div>
          </td>
          <td>
            <div class="cell">
              <div class="t">Student Name</div>
              <div class="v" id="studentNameCell">
                <input type="text" id="studentName" placeholder="Enter name">
              </div>
            </div>
          </td>
        </tr>

        <tr>
          <td>
            <div class="cell">
              <div class="t">Payment Plan</div>
              <div class="v">
                <select id="paymentPlan">
                  <option value="One-Time">One-Time</option>
                  <option value="Termly">Termly</option>
                  <option value="Monthly" selected>Monthly</option>
                </select>
              </div>
            </div>
          </td>
          <td>
            <div class="cell">
              <div class="t">First Attendance Date</div>
              <div class="v">
                <input type="date" id="firstAttendance">
              </div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2>2. Fee Calculation</h2>

  <div class="cell" style="margin-bottom:15px; padding:0 5px;">
    <div class="t" style="font-size:15px;">Tuition Before Discount</div>
    <div class="v">
      <span class="amount-pill" id="tuitionBefore">0 Ks</span>
    </div>
  </div>

  <div class="discount-wrap">
    <table>
      <thead>
        <tr>
          <th width="5%">No</th>
          <th width="25%">Discount Type</th>
          <th width="30%">Description / Option</th>
          <th width="20%">Amount / %</th>
          <th width="15%">Calculation</th>
          <th width="5%"></th>
        </tr>
      </thead>
      <tbody id="discBody">
        </tbody>
    </table>
  </div>

  <button class="btn-add" type="button" onclick="addDiscount()">
    + Add Another Discount
  </button>

  <div class="totals">
    <div>
      <span>Total Discount Applied</span>
      <span class="amount-pill red" id="totalDiscount">0 Ks</span>
    </div>
    <div>
      <span>Net Tuition Amount</span>
      <span class="amount-pill" id="afterDiscount">0 Ks</span>
    </div>
    <div style="border-top:1px solid #e5e7eb; padding-top:12px; margin-top:4px;">
      <span>Per Payment Cycle</span>
      <span class="amount-pill" id="paymentFee" style="background:#0071e3; color:#fff;">0 Ks</span>
    </div>
  </div>

  <h2>3. Tuition Payment Schedule</h2>

  <div class="plan">
    <table>
      <thead>
        <tr>
          <th width="10%">No</th>
          <th width="60%">Due Date / Description</th>
          <th width="30%">Amount Payable</th>
        </tr>
      </thead>
      <tbody id="planBody">
        </tbody>
    </table>
  </div>

  <button class="btn-final" type="button" onclick="submitForm()">
    Confirm Enrollment &amp; Generate Contract
  </button>
</div>

<script>
  /* ----------------------------------------------------
     DOM Elements
     ---------------------------------------------------- */
  const academicYearEl = document.getElementById("academicYear");
  const gradeEl = document.getElementById("grade");
  const paymentPlanEl = document.getElementById("paymentPlan");
  const firstAttendanceEl = document.getElementById("firstAttendance");
  
  const studentTypeRadios = document.querySelectorAll('input[name="studentType"]');
  const studentIdCell = document.getElementById("studentIdCell");
  const studentNameCell = document.getElementById("studentNameCell");
  const fatherCell = document.getElementById("fatherCell");
  const containerRoot = document.getElementById("containerRoot");

  const tuitionBeforeEl = document.getElementById("tuitionBefore");
  const discBody = document.getElementById("discBody");
  const totalDiscountEl = document.getElementById("totalDiscount");
  const afterDiscountEl = document.getElementById("afterDiscount");
  const paymentFeeEl = document.getElementById("paymentFee");
  const planBody = document.getElementById("planBody");

  // Set default date to today
  firstAttendanceEl.valueAsDate = new Date();

  /* ----------------------------------------------------
     DATA: Pricing Configuration
     ---------------------------------------------------- */
  // Returns tuition based on Year, Grade, and if it's One-Time vs Installment
  // Note: "One-Time" plan often has cheaper base tuition than installments
  function getTuitionBefore() {
    const year = academicYearEl.value;
    const grade = gradeEl.value;
    const plan = paymentPlanEl.value;

    if (year === "SUMMER2026") {
      // Flat rate for Summer
      return 850000;
    }

    // Pricing Table: [One-Time Price, Installment Price]
    // If plan is 'One-Time', use index 0. If Termly/Monthly, use index 1.
    const isInstallment = (plan !== "One-Time");
    
    // Structure: Grade -> [OneTime, Installment]
    const prices2025 = {
      "SR Half-day": [2700000, 3000000],
      "SR Full-day": [3900000, 4200000],
      "EY1":         [3900000, 4200000],
      "EY2":         [3900000, 4200000],
      "Y1":          [4200000, 4500000],
      "Y2":          [4200000, 4500000],
      "Y3":          [4200000, 4500000]
    };

    const prices2026 = {
      "SR Half-day": [2890000, 3290000], // Termly usually slightly less than Monthly, but simplifying for logic: Base vs Installment
      "SR Full-day": [4290000, 4890000],
      "EY1":         [4290000, 4890000],
      "EY2":         [4290000, 4890000],
      "Y1":          [4690000, 5290000],
      "Y2":          [4690000, 5290000],
      "Y3":          [4690000, 5290000]
    };

    let selectedTable = (year === "AY2025-2026") ? prices2025 : prices2026;
    if (!selectedTable[grade]) return 0;

    // However, the prompt implies "Termly" might have specific pricing distinct from "Monthly".
    // For this implementation based on previous logic:
    // One-Time = Base
    // Termly/Monthly = Higher Base
    
    // Refining specific override from previous prompts:
    // AY26 SR Half: Annual 2.89m, Termly 3.09m, Monthly (implies based on 3.29m total or similar)
    // To handle the exact request "Termly" vs "Monthly" base prices:
    
    if (year === "AY2026-2027") {
       if (grade === "SR Half-day") {
           if(plan === "One-Time") return 2890000;
           if(plan === "Termly")   return 3090000;
           return 3290000; // Monthly
       }
       if (grade === "SR Full-day" || grade.startsWith("EY")) {
           if(plan === "One-Time") return 4290000;
           if(plan === "Termly")   return 4490000;
           return 4890000;
       }
       if (grade.startsWith("Y")) {
           if(plan === "One-Time") return 4690000;
           if(plan === "Termly")   return 4890000;
           return 5290000;
       }
    }

    // Default Fallback to the dictionary
    return isInstallment ? selectedTable[grade][1] : selectedTable[grade][0];
  }

  // Returns the Reference Annual Amount used for "FREE TERMS" calculation
  // The rule is: Free Terms are calculated based on the Annual (One-Time) Fee, 
  // regardless of which plan the user is currently on.
  function getAnnualReference() {
    const year = academicYearEl.value;
    const grade = gradeEl.value;

    if (year === "SUMMER2026") return 0; // No free terms for summer usually

    // AY 2025
    if (year === "AY2025-2026") {
      if (grade === "SR Half-day") return 2700000;
      if (grade === "SR Full-day" || grade.startsWith("EY")) return 3900000;
      return 4200000;
    }

    // AY 2026
    if (year === "AY2026-2027") {
      if (grade === "SR Half-day") return 2890000;
      if (grade === "SR Full-day" || grade.startsWith("EY")) return 4290000;
      return 4690000;
    }

    return 0;
  }

  /* ----------------------------------------------------
     DATA: Current Student Directory (Dummy Data)
     ---------------------------------------------------- */
  const CURRENT_STUDENT_DIRECTORY = [
    { id: "PR23001", name: "Aung Aung", father: "U Ba Maung" },
    { id: "PR23002", name: "Bo Bo", father: "U Hla Tun" },
    { id: "PR23003", name: "Chit Thu", father: "U Kyaw Swar" },
    { id: "PR23004", name: "Aye Chan", father: "U Kyaw Min" },
    { id: "PR23005", name: "Hnin Pwint", father: "U Zaw Lin" },
    { id: "PR23006", name: "Min Khant", father: "U Myint Oo" },
    { id: "PR23007", name: "Nandar Hlaing", father: "U Win Bo" },
    { id: "PR23008", name: "Phyo Thiha", father: "U Tin Maung" },
    { id: "PR23009", name: "Thiri Tun", father: "U Nay Win" },
    { id: "PR23010", name: "Zin Myo", father: "U Soe Thet" },
    { id: "PR24040", name: "Kyaw Kyaw", father: "U Mya" },
    { id: "PR24041", name: "Su Su", father: "U Ba" },
    { id: "PR24042", name: "Tun Tun", father: "U Hla" },
    { id: "PR24046", name: "Pyae Phyo", father: "U Aung Zeya" },
    { id: "PR24050", name: "Su Mon", father: "U Hla Myo" },
    { id: "PR24051", name: "Khine Thazin", father: "U Khin Maung" },
    { id: "PR25010", name: "Ye Lin", father: "U Tun Tun" },
    { id: "PR25230", name: "Moe Set", father: "U Aung Naing" },
    { id: "PR25231", name: "Wai Yan", father: "U Ko Ko" },
    { id: "PR25232", name: "Yoon Nadi", father: "U Zaw Zaw" },
    { id: "PR25233", name: "Hein Htet", father: "U Min Min" },
    { id: "PR25234", name: "Eaindra", father: "U Thein Lwin" },
    { id: "PR25235", name: "Myat Noe", father: "U Aung Kyaw" }
  ];

  /* ----------------------------------------------------
     LOGIC: Student Type & Search
     ---------------------------------------------------- */
  function handleStudentTypeChange() {
    const type = document.querySelector('input[name="studentType"]:checked').value;
    
    // UI Elements
    const sId = document.getElementById("studentIdCell");
    const sName = document.getElementById("studentNameCell");
    const fCell = document.getElementById("fatherCell");
    const fInput = document.getElementById("fatherName");

    if (type === "current") {
      containerRoot.classList.add("current-mode");

      // Replace Static ID with Input
      sId.innerHTML = `<input type="text" id="studentIdSearch" placeholder="Search ID..." onkeydown="if(event.key==='Enter') searchStudent()">`;
      
      // Replace Name Input with Search Combo
      sName.innerHTML = `
        <div class="inline-search">
          <input type="text" id="studentNameSearch" placeholder="Search Name..." onkeydown="if(event.key==='Enter') searchStudent()">
          <button class="btn-search" id="currentSearchBtn" type="button" onclick="searchStudent()">Search</button>
        </div>
      `;

      // Replace Father Input with Display Text
      fCell.innerHTML = `<span class="pill" id="fatherDisplay" style="background:#f3f4f6; color:#111;">—</span>`;
    
    } else {
      // New or Returning
      containerRoot.classList.remove("current-mode");
      
      // Generate Random ID for New
      const yPrefix = academicYearEl.value === "AY2025-2026" ? "25" : "26";
      const rnd = Math.floor(100 + Math.random() * 900);
      sId.innerHTML = `<span class="pill" id="studentId">PR${yPrefix}${rnd}</span>`;
      
      // Standard Inputs
      sName.innerHTML = `<input type="text" id="studentName" placeholder="Enter student name">`;
      fCell.innerHTML = `<input type="text" id="fatherName" placeholder="Enter father's name">`;
    }
  }

  function searchStudent() {
    const idField = document.getElementById("studentIdSearch");
    const nameField = document.getElementById("studentNameSearch");
    const fatherDisplay = document.getElementById("fatherDisplay");

    const idQ = idField ? idField.value.trim().toLowerCase() : "";
    const nameQ = nameField ? nameField.value.trim().toLowerCase() : "";

    let found = null;

    if (idQ) {
      found = CURRENT_STUDENT_DIRECTORY.find(s => s.id.toLowerCase() === idQ);
    }
    if (!found && nameQ) {
      found = CURRENT_STUDENT_DIRECTORY.find(s => s.name.toLowerCase().includes(nameQ));
    }

    if (found) {
      if(idField) idField.value = found.id;
      if(nameField) nameField.value = found.name;
      if(fatherDisplay) {
        fatherDisplay.textContent = found.father;
        fatherDisplay.style.background = "#eef2ff";
        fatherDisplay.style.color = "#3730a3";
      }
    } else {
      if(fatherDisplay) {
        fatherDisplay.textContent = "Not Found";
        fatherDisplay.style.background = "#fee2e2";
        fatherDisplay.style.color = "#b91c1c";
      }
    }
  }

  /* ----------------------------------------------------
     LOGIC: Discount Management
     ---------------------------------------------------- */
  function addDiscount() {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="d-no" style="font-weight:700; color:#6b7280;"></td>
      <td>
        <select class="disc-type" onchange="handleDiscTypeChange(this)">
          <option value="Fixed">Fixed Amount</option>
          <option value="Percent %">Percentage (%)</option>
          <option value="Sibling %">Sibling Discount (%)</option>
          <option value="Early Bird %">Early Bird (%)</option>
          <option value="Referral">Referral (Fixed)</option>
          <option value="FREE">FREE TERMS (Tuition Waiver)</option>
        </select>
      </td>
      <td class="desc-cell">
        <input type="text" class="disc-desc" placeholder="e.g. Scholarship" oninput="recalc()">
      </td>
      <td>
        <input type="number" class="disc-amt" placeholder="0" oninput="recalc()">
      </td>
      <td class="disc-calc" style="text-align:right;">0</td>
      <td style="text-align:center;">
        <button class="btn-remove" type="button" onclick="removeDiscount(this)">−</button>
      </td>
    `;
    discBody.appendChild(tr);
    renumberDiscounts();
    recalc();
  }

  function removeDiscount(btn) {
    btn.closest("tr").remove();
    renumberDiscounts();
    recalc();
  }

  function renumberDiscounts() {
    const rows = discBody.querySelectorAll("tr");
    rows.forEach((tr, index) => {
      tr.querySelector(".d-no").textContent = index + 1;
    });
  }

  function handleDiscTypeChange(select) {
    const tr = select.closest("tr");
    const descCell = tr.querySelector(".desc-cell");
    const amtInput = tr.querySelector(".disc-amt");
    
    if (select.value === "FREE") {
      // Switch Description to Dropdown for Free Terms
      descCell.innerHTML = `
        <select class="disc-desc" onchange="recalc()">
          <option value="FREE_3T">FREE_3T (Full Year / 3 Terms)</option>
          <option value="FREE_2T">FREE_2T (2 Terms)</option>
          <option value="FREE_1T">FREE_1T (1 Term)</option>
        </select>
      `;
      // Disable Amount input as it is calculated automatically
      amtInput.value = "";
      amtInput.disabled = true;
      amtInput.placeholder = "Auto";
    } else {
      // Revert to Text Input
      descCell.innerHTML = `<input type="text" class="disc-desc" placeholder="Description" oninput="recalc()">`;
      amtInput.disabled = false;
      amtInput.placeholder = select.value.includes("%") ? "%" : "Amount";
    }
    recalc();
  }

  /* ----------------------------------------------------
     LOGIC: Main Calculation Engine
     ---------------------------------------------------- */
  function fmtKs(n) {
    // Round to nearest integer and format with commas
    const val = Math.max(0, Math.round(n));
    return val.toLocaleString("en-US") + " Ks";
  }

  function recalc() {
    // 1. Get Base Tuition
    const baseTuition = getTuitionBefore();
    const annualReference = getAnnualReference(); // Used for Free Terms calc
    
    tuitionBeforeEl.textContent = fmtKs(baseTuition);

    // 2. Iterate Discounts
    let fixedDeductions = 0; // Fixed amounts + Free Terms amounts
    let percentAccumulator = 0; // Sum of percentage values (e.g., 5 + 10 = 15%)

    const rows = [...discBody.querySelectorAll("tr")];

    // First Pass: Calculate Fixed and Percent Sums
    rows.forEach(tr => {
      const type = tr.querySelector(".disc-type").value;
      const amtInput = tr.querySelector(".disc-amt");
      const calcDisplay = tr.querySelector(".disc-calc");
      
      let rowValue = 0;

      if (type === "FREE") {
        // Logic: Calculate based on Annual Fee fractions
        const freeType = tr.querySelector(".disc-desc").value;
        if (freeType === "FREE_3T") {
            rowValue = annualReference * 1.0; 
        } else if (freeType === "FREE_2T") {
            rowValue = annualReference * (2/3); 
        } else if (freeType === "FREE_1T") {
            rowValue = annualReference * (1/3); 
        }
        fixedDeductions += rowValue;
        calcDisplay.textContent = "-" + fmtKs(rowValue);
      } 
      else if (type === "Fixed" || type === "Referral") {
        // Direct Fixed Amount
        rowValue = Number(amtInput.value || 0);
        fixedDeductions += rowValue;
        calcDisplay.textContent = "-" + fmtKs(rowValue);
      } 
      else if (type.includes("%")) {
        // Just sum the percentage points here, calculate money later
        const p = Number(amtInput.value || 0);
        percentAccumulator += p;
        // Temporary placeholder for display
        calcDisplay.textContent = "Pending..."; 
        calcDisplay.dataset.pct = p; // Store for 2nd pass
      }
    });

    // 3. Apply Logic
    // Subtotal after fixed discounts
    let remainingAfterFixed = Math.max(0, baseTuition - fixedDeductions);
    
    // Calculate total money value of percentage discounts applied to the Remaining amount
    // (Common logic: Percent applies to balance after fixed coupons)
    const totalPercentMoney = remainingAfterFixed * (percentAccumulator / 100);

    // Second Pass: Update Percent Displays
    rows.forEach(tr => {
      const type = tr.querySelector(".disc-type").value;
      if (type.includes("%")) {
        const pct = Number(tr.querySelector(".disc-calc").dataset.pct || 0);
        if (percentAccumulator > 0) {
            // Pro-rate the total discount money to this specific row
            const share = (pct / percentAccumulator) * totalPercentMoney;
            tr.querySelector(".disc-calc").textContent = "-" + fmtKs(share);
        } else {
            tr.querySelector(".disc-calc").textContent = "0";
        }
      }
    });

    const totalDiscount = fixedDeductions + totalPercentMoney;
    const finalAmount = Math.max(0, baseTuition - totalDiscount);

    // 4. Update Summaries
    totalDiscountEl.textContent = (totalDiscount > 0 ? "-" : "") + fmtKs(totalDiscount);
    afterDiscountEl.textContent = fmtKs(finalAmount);

    // 5. Render Payment Plan
    renderPaymentSchedule(finalAmount);
  }

  /* ----------------------------------------------------
     LOGIC: Payment Schedule Generation
     ---------------------------------------------------- */
  function renderPaymentSchedule(totalAmount) {
    planBody.innerHTML = "";
    const plan = paymentPlanEl.value;
    const year = academicYearEl.value;

    // A. Summer School (Always One-Time)
    if (year === "SUMMER2026") {
      paymentFeeEl.textContent = fmtKs(totalAmount);
      addPlanRow(1, "Full Payment (Summer)", totalAmount);
      return;
    }

    // B. One-Time Payment
    if (plan === "One-Time") {
      paymentFeeEl.textContent = fmtKs(totalAmount);
      addPlanRow(1, "Full Annual Payment (Due upon Registration)", totalAmount);
      return;
    }

    // C. Termly (3 Payments)
    if (plan === "Termly") {
      // Divide by 3
      // Rounding logic: We usually want clean numbers. 
      // Simple math here:
      const perTerm = Math.round(totalAmount / 3);
      paymentFeeEl.textContent = fmtKs(perTerm);

      // Adjust last payment for rounding errors
      const totalCheck = perTerm * 3;
      const diff = totalAmount - totalCheck; // add diff to last payment

      // Dates
      const termDates = (year === "AY2025-2026") 
        ? ["Registration Date", "1st September 2025", "1st December 2025"]
        : ["Registration Date", "1st September 2026", "1st December 2026"];

      addPlanRow(1, `Term 1 (${termDates[0]})`, perTerm);
      addPlanRow(2, `Term 2 (${termDates[1]})`, perTerm);
      addPlanRow(3, `Term 3 (${termDates[2]})`, perTerm + diff);
      return;
    }

    // D. Monthly (10 Installments)
    if (plan === "Monthly") {
      const perMonth = Math.round(totalAmount / 10);
      paymentFeeEl.textContent = fmtKs(perMonth);

      const totalCheck = perMonth * 10;
      const diff = totalAmount - totalCheck;

      const months = [
        "Registration (Month 1)", "July 1st", "August 1st", "September 1st", "October 1st",
        "November 1st", "December 1st", "January 1st", "February 1st", "March 1st"
      ];

      for (let i = 0; i < 10; i++) {
        const amt = (i === 9) ? (perMonth + diff) : perMonth;
        addPlanRow(i + 1, months[i] || `Month ${i+1}`, amt);
      }
      return;
    }
  }

  function addPlanRow(no, dateDesc, amount) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${no}</td>
      <td>${dateDesc}</td>
      <td>${fmtKs(amount)}</td>
    `;
    planBody.appendChild(tr);
  }

  function submitForm() {
    alert("System Message:\n\nEnrollment data validated.\nProceeding to contract generation...");
  }

  /* ----------------------------------------------------
     EVENT LISTENERS & INIT
     ---------------------------------------------------- */
  // Listen for changes on main inputs
  academicYearEl.addEventListener("change", () => {
    // If Student Type is New, regenerate ID for new year
    const type = document.querySelector('input[name="studentType"]:checked').value;
    if (type === "new") {
        const yPrefix = academicYearEl.value === "AY2025-2026" ? "25" : "26";
        const rnd = Math.floor(100 + Math.random() * 900);
        const sid = document.getElementById("studentId");
        if(sid) sid.textContent = `PR${yPrefix}${rnd}`;
    }
    recalc();
  });

  gradeEl.addEventListener("change", recalc);
  paymentPlanEl.addEventListener("change", recalc);

  studentTypeRadios.forEach(radio => {
    radio.addEventListener("change", handleStudentTypeChange);
  });

  // Initialize
  addDiscount(); // Add one empty discount row by default
  recalc();      // Initial Calc
  
</script>
</body>
</html>