<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tuition Late Fee Calculator & Simulator</title>
  <style>
    :root { --bg:#f6f7f9; --card:#fff; --border:#d8dde3; --text:#111827; --muted:#6b7280; }
    body{font-family:Arial,Helvetica,sans-serif;margin:20px;background:var(--bg);color:var(--text);}
    h2{margin:0 0 10px 0;padding:10px;background:#111827;color:#fff;}
    fieldset{border:1px solid var(--border);background:var(--card);padding:14px;margin:0 0 16px 0;}
    legend{font-weight:bold;color:#111827;}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin:8px 0;}
    .row label{min-width:220px;font-weight:bold;}
    .row input,.row .readonly{
      width:260px;max-width:100%;
      padding:7px 8px;border:1px solid var(--border);border-radius:6px;background:#fff;
    }
    .row .readonly{background:#f3f4f6;}
    .btnrow{margin-top:10px;}
    button{padding:10px 16px;font-weight:bold;border:1px solid #111827;border-radius:8px;background:#111827;color:#fff;cursor:pointer;}
    button:active{transform:translateY(1px);}
    .line{border-top:3px solid #111827;margin:18px 0;}
    .status{display:flex;flex-wrap:wrap;gap:18px;margin-top:10px;}
    .status .pill{background:#f3f4f6;border:1px solid var(--border);border-radius:999px;padding:8px 12px;}
    .status b{margin-right:6px;}
    .warn{color:#b45309;font-weight:bold;}
    .err{color:#b91c1c;font-weight:bold;}
    table{width:100%;border-collapse:collapse;background:var(--card);margin-top:10px;}
    th,td{border:1px solid var(--border);padding:8px;text-align:center;}
    th{background:#eef2f7;}
    .subhead{margin:8px 0 0 0;font-weight:bold;}
    .muted{color:var(--muted);}
    .kpi{font-size:18px;}
  </style>
</head>
<body>

<h2>PART 1 – Calculate Late Fee</h2>

<fieldset>
  <div class="row">
    <label for="studentId">Student ID</label>
    <input id="studentId" value="PR25004" />
  </div>

  <div class="row">
    <label for="studentName">Student Name</label>
    <input id="studentName" value="Aye Aye" />
  </div>

  <div class="row">
    <label for="invoiceNo">Tuition Invoice Nr</label>
    <input id="invoiceNo" value="INV25046-07" />
  </div>

  <div class="row">
    <label for="lateFeeAmount">Late Fee Amount (per day)</label>
    <input id="lateFeeAmount" type="number" value="20000" />
  </div>

  <div class="row">
    <label for="dueDate">Due Date [Day, DD-MMM-YYYY]</label>
    <input id="dueDate" type="date" value="2026-01-01" />
    <span class="muted" id="dueDateFmt"></span>
  </div>

  <div class="row">
    <label for="tuitionPayDate">Tuition Payment Date [Day, DD-MMM-YYYY]</label>
    <input id="tuitionPayDate" type="date" />
    <span class="muted" id="tuitionPayFmt"></span>
  </div>

  <div class="row">
    <label for="lateFeePayDate">Late Fee Payment Date [Day, DD-MMM-YYYY]</label>
    <input id="lateFeePayDate" type="date" />
    <span class="muted" id="lateFeePayFmt"></span>
  </div>

  <div class="btnrow">
    <div>BR</div>
    <button type="button" onclick="calculateLateFee()">Calculate Late Fee</button>
  </div>

  <div class="status">
    <div class="pill kpi"><b>Calculated Late Fee:</b> <span id="lateFeeResult">0</span></div>
    <div class="pill"><b>Student Status (as-of simulation approval date):</b> <span id="studentStatus">ACTIVE</span></div>
  </div>

  <div class="muted" id="calcNote" style="margin-top:8px;"></div>
</fieldset>

<div class="line"></div>

<h2>Simulate Database</h2>

<fieldset>
  <div class="row">
    <label>Tuition Payment Date [Day, DD-MMM-YYYY]</label>
    <div class="readonly" id="tuitionPayRead">—</div>
  </div>

  <div class="row">
    <label>Late Fee Payment Date [Day, DD-MMM-YYYY]</label>
    <div class="readonly" id="lateFeePayRead">—</div>
  </div>

  <div class="row">
    <label for="approveDate">Accountant Approve-Payment-Date [Day, DD-MMM-YYYY]</label>
    <input id="approveDate" type="date" />
    <span class="muted" id="approveFmt"></span>
  </div>

  <div class="btnrow">
    <div>BR</div>
    <button type="button" onclick="runSimulation()">Run Simulation</button>
  </div>

  <div id="simMsg" style="margin-top:10px;"></div>
</fieldset>

<div class="line"></div>

<h2>PART 2 – Late Fee Daily Ledger Table</h2>

<p class="subhead" id="tuitionHeading">Late Fee Daily Ledger Table on Tuition Payment Date = —</p>
<table id="tuitionTable"></table>

<p class="subhead" id="lateFeeHeading">Late Fee Daily Ledger Table on Late Fee Payment Date = —</p>
<table id="lateFeeTable"></table>

<p class="subhead" id="approveHeading">Late Fee Daily Ledger Table on Accountant Approve-Payment-Date = —</p>
<table id="approveTable"></table>

<script>
  // ---------- Date formatting: "Day, DD-MMM-YYYY" ----------
  const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const DAYS = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

  function toDateOrNull(v){
    if(!v) return null;
    const d = new Date(v + "T00:00:00");
    return Number.isNaN(d.getTime()) ? null : d;
  }

  function fmt(d){
    if(!d) return "—";
    const dd = String(d.getDate()).padStart(2,"0");
    return `${DAYS[d.getDay()]}, ${dd}-${MONTHS[d.getMonth()]}-${d.getFullYear()}`;
  }

  function addDays(d, n){
    const x = new Date(d.getTime());
    x.setDate(x.getDate() + n);
    return x;
  }

  function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }

  // Days late definition aligned with your examples:
  // Due 1 Jan, pay 2 Jan => 1 day late => 20k
  // daysLate = (stopDate - dueDate) in whole days, clamped to 0..5
  function daysLate(due, stop){
    const ms = stop.getTime() - due.getTime();
    const d = Math.floor(ms / 86400000);
    return clamp(d, 0, 5);
  }

  // Ledger insertion timeline rule you described:
  // At due+1 00:00 insert row for due date, and so on.
  // Therefore, "ledger as of date S" (during day) contains rows with lateFeeDate <= S-1.
  // On approval date A, accountant can see rows through A-1 (capped to 5 rows total).
  function buildProvisionalLedger(dueDate, approveDate, dailyFee){
    // Max row date = min(approveDate - 1 day, dueDate + 4 days) because cap 5 rows starting from dueDate
    const maxByApproval = addDays(approveDate, -1);
    const maxByCap = addDays(dueDate, 4);
    const maxDate = (maxByApproval < maxByCap) ? maxByApproval : maxByCap;

    const rows = [];
    // If approveDate <= dueDate, there are no late fee rows yet.
    if(maxDate < dueDate) return rows;

    // Create rows for each date from dueDate..maxDate inclusive
    let cur = new Date(dueDate.getTime());
    while(cur <= maxDate){
      rows.push({
        late_fee_date: new Date(cur.getTime()),
        late_fee_amount: dailyFee,
        is_cancelled: null,
        payment_date: null
      });
      cur = addDays(cur, 1);
    }
    return rows;
  }

  function renderTable(tableEl, rows){
    if(!rows || rows.length === 0){
      tableEl.innerHTML = `
        <tr>
          <th>student id</th><th>invoice number</th><th>late fee date</th>
          <th>late fee amount</th><th>is_cancelled</th><th>payment date</th>
        </tr>
        <tr><td colspan="6" class="muted">No ledger rows</td></tr>
      `;
      return;
    }

    const sid = document.getElementById("studentId").value.trim();
    const inv = document.getElementById("invoiceNo").value.trim();

    let html = `
      <tr>
        <th>student id</th>
        <th>invoice number</th>
        <th>late fee date</th>
        <th>late fee amount</th>
        <th>is_cancelled</th>
        <th>payment date</th>
      </tr>`;

    for(const r of rows){
      const isC = (r.is_cancelled === null) ? "NULL" : String(r.is_cancelled);
      const pay = r.payment_date ? fmt(r.payment_date) : "NULL";
      html += `
        <tr>
          <td>${sid || "—"}</td>
          <td>${inv || "—"}</td>
          <td>${fmt(r.late_fee_date)}</td>
          <td>${Number(r.late_fee_amount).toLocaleString()}</td>
          <td>${isC}</td>
          <td>${pay}</td>
        </tr>`;
    }
    tableEl.innerHTML = html;
  }

  function syncReadOnlyDates(){
    const due = toDateOrNull(document.getElementById("dueDate").value);
    const tpd = toDateOrNull(document.getElementById("tuitionPayDate").value);
    const lpd = toDateOrNull(document.getElementById("lateFeePayDate").value);
    const apd = toDateOrNull(document.getElementById("approveDate").value);

    document.getElementById("dueDateFmt").textContent = due ? fmt(due) : "";
    document.getElementById("tuitionPayFmt").textContent = tpd ? fmt(tpd) : "";
    document.getElementById("lateFeePayFmt").textContent = lpd ? fmt(lpd) : "";
    document.getElementById("approveFmt").textContent = apd ? fmt(apd) : "";

    document.getElementById("tuitionPayRead").textContent = fmt(tpd);
    document.getElementById("lateFeePayRead").textContent = fmt(lpd);

    document.getElementById("tuitionHeading").textContent =
      `Late Fee Daily Ledger Table on Tuition Payment Date = ${fmt(tpd)}`;
    document.getElementById("lateFeeHeading").textContent =
      `Late Fee Daily Ledger Table on Late Fee Payment Date = ${fmt(lpd)}`;
    document.getElementById("approveHeading").textContent =
      `Late Fee Daily Ledger Table on Accountant Approve-Payment-Date = ${fmt(apd)}`;
  }

  // ---------- Part 1: Calculate (business meaning: if/when late fee is paid) ----------
  function calculateLateFee(){
    syncReadOnlyDates();

    const due = toDateOrNull(document.getElementById("dueDate").value);
    const tpd = toDateOrNull(document.getElementById("tuitionPayDate").value);
    const lpd = toDateOrNull(document.getElementById("lateFeePayDate").value);
    const dailyFee = Number(document.getElementById("lateFeeAmount").value);

    const noteEl = document.getElementById("calcNote");
    noteEl.textContent = "";

    if(!due || !tpd){
      document.getElementById("lateFeeResult").textContent = "0";
      noteEl.innerHTML = `<span class="err">Please select Due Date and Tuition Payment Date.</span>`;
      return;
    }

    // Late fee stops only when BOTH tuition and late fee are paid.
    // For calculator: if late fee payment date exists => stopDate = max(tuition, lateFee).
    // If late fee payment date missing => cannot stop; show late fee "as of tuition pay date" for reference + warning.
    let stopDateForCalc = null;

    if(lpd){
      stopDateForCalc = (tpd > lpd) ? tpd : lpd;
      const dLate = daysLate(due, stopDateForCalc);
      const total = dLate * dailyFee;
      document.getElementById("lateFeeResult").textContent = total.toLocaleString();
      noteEl.innerHTML =
        `Late fee will be capped at 5 days (max ${(5*dailyFee).toLocaleString()}). ` +
        `Stop date used for calculation: <b>${fmt(stopDateForCalc)}</b> (both paid).`;
    } else {
      // Not paid yet: still accruing; show "as of tuition payment date" amount as reference.
      const dLate = daysLate(due, tpd);
      const total = dLate * dailyFee;
      document.getElementById("lateFeeResult").textContent = total.toLocaleString();
      noteEl.innerHTML =
        `<span class="warn">Late fee payment date is empty. Late fee does NOT stop and will continue to accrue until late fee is paid.</span> ` +
        `Shown amount is only the late fee level as-of Tuition Payment Date (<b>${fmt(tpd)}</b>) for reference, capped at 5 days.`;
    }

    // Status here is shown "as-of simulation approval date" (updated in simulation).
    document.getElementById("studentStatus").textContent = "ACTIVE";
  }

  // ---------- Part 2: Simulation ----------
  function runSimulation(){
    // Recalculate each time Run Simulation is clicked (always reset tables/data).
    const simMsg = document.getElementById("simMsg");
    simMsg.textContent = "";
    simMsg.className = "";

    syncReadOnlyDates();

    const sid = document.getElementById("studentId").value.trim();
    const inv = document.getElementById("invoiceNo").value.trim();

    const due = toDateOrNull(document.getElementById("dueDate").value);
    const tpd = toDateOrNull(document.getElementById("tuitionPayDate").value);
    const lpd = toDateOrNull(document.getElementById("lateFeePayDate").value);
    const apd = toDateOrNull(document.getElementById("approveDate").value);
    const dailyFee = Number(document.getElementById("lateFeeAmount").value);

    // Basic validation
    if(!sid || !inv || !due || !tpd || !apd){
      simMsg.className = "err";
      simMsg.textContent = "Missing required fields: Student ID, Invoice Number, Due Date, Tuition Payment Date, Accountant Approve-Payment-Date.";
      renderTable(document.getElementById("tuitionTable"), []);
      renderTable(document.getElementById("lateFeeTable"), []);
      renderTable(document.getElementById("approveTable"), []);
      return;
    }

    // Approval constraints:
    // - Accountant approve can only be ON OR AFTER tuition payment date.
    // - If late fee payment date exists, approval must also be ON OR AFTER late fee payment date.
    if(apd < tpd){
      simMsg.className = "err";
      simMsg.textContent = "Invalid: Accountant Approve-Payment-Date must be ON OR AFTER Tuition Payment Date.";
      return;
    }
    if(lpd && apd < lpd){
      simMsg.className = "err";
      simMsg.textContent = "Invalid: Accountant Approve-Payment-Date must be ON OR AFTER Late Fee Payment Date (when late fee is paid).";
      return;
    }

    // Provisional ledger visible at approval time (rows through approve-1, capped to 5 days)
    const provisional = buildProvisionalLedger(due, apd, dailyFee);

    // Stop condition only when BOTH are paid
    const bothPaid = !!(tpd && lpd);

    // If both paid, stopDate is the later of the two payment dates.
    // On approval, system auto-updates late fee ledger:
    // - payment_date = stopDate
    // - is_cancelled = 0 for rows with late_fee_date < stopDate, else 1 for >= stopDate
    const stopDate = bothPaid ? ((tpd > lpd) ? tpd : lpd) : null;

    const approvedView = provisional.map(r => ({...r}));

    if(stopDate){
      for(const r of approvedView){
        r.payment_date = stopDate;
        r.is_cancelled = (r.late_fee_date >= stopDate) ? 1 : 0;
      }
    }

    // Build snapshot views:
    // "Ledger on date S" shows rows that exist by S (inserted up to S-1).
    function rowsAsOf(baseRows, asOfDate){
      if(!asOfDate) return [];
      const maxRowDate = addDays(asOfDate, -1);
      return baseRows.filter(r => r.late_fee_date <= maxRowDate);
    }

    // Before approval happens, entries are not auto-updated yet (NULL cancel/payment).
    // So for tuition date snapshot and late fee date snapshot, show provisional rows (not updated),
    // filtered to as-of each date.
    const tuitionSnapshot = rowsAsOf(provisional, tpd);

    const lateFeeSnapshot = lpd ? rowsAsOf(provisional, lpd) : [];

    // On approval date snapshot, show auto-updated table (if both paid), filtered as-of approval.
    const approveSnapshot = rowsAsOf(approvedView, apd);

    renderTable(document.getElementById("tuitionTable"), tuitionSnapshot);
    renderTable(document.getElementById("lateFeeTable"), lateFeeSnapshot);
    renderTable(document.getElementById("approveTable"), approveSnapshot);

    // Student status:
    // - If late fee not fully paid by Jan 7 morning => FINANCIALLY SUSPENDED (until paid)
    // - When paid (stopDate exists), status becomes ACTIVE
    const suspensionDate = new Date("2026-01-07T00:00:00"); // "7 Jan morning"
    let status = "ACTIVE";
    if(!stopDate && apd >= suspensionDate){
      status = "FINANCIALLY SUSPENDED";
    }
    if(stopDate){
      status = "ACTIVE";
    }
    document.getElementById("studentStatus").textContent = status;

    // Informational message
    const capMax = (5 * dailyFee).toLocaleString();
    if(!stopDate){
      simMsg.className = "warn";
      simMsg.innerHTML =
        `Late fee has <b>NOT</b> stopped because both Tuition and Late Fee are not paid. ` +
        `Late fee continues to accrue daily until paid, capped at 5 days (max <b>${capMax}</b>).`;
    } else {
      simMsg.className = "";
      simMsg.innerHTML =
        `Late fee stopped on <b>${fmt(stopDate)}</b> (both paid). ` +
        `Ledger auto-updated on approval date <b>${fmt(apd)}</b>.`;
    }
  }

  // Live formatting updates
  ["dueDate","tuitionPayDate","lateFeePayDate","approveDate"].forEach(id=>{
    document.getElementById(id).addEventListener("change", syncReadOnlyDates);
  });

  syncReadOnlyDates();
</script>

</body>
</html>